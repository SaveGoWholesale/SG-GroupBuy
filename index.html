<!DOCTYPE html>

<html class="h-full" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Converted File</title>
<script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script></head>
<body class="h-full bg-gray-50">

html
<html class="h-full" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>SaveGo - Group Buying Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .animate-pulse-hover:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
        }
        
        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .search-dropdown {
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
        }
        
        .products-container {
            transition: max-height 0.3s ease-in-out;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
<!-- Navigation -->
<nav class="bg-white shadow-sm border-b sticky top-0 z-40">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex items-center space-x-2">
<div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
<i class="w-5 h-5 text-white" data-lucide="shopping-bag"></i>
</div>
<span class="text-xl font-bold text-gray-900">SaveGo</span>
</div>
<div class="hidden md:flex items-center space-x-8">
<button class="text-gray-600 hover:text-gray-900 transition-colors" onclick="showSection('browse')">Browse Requests</button>
<button class="text-gray-600 hover:text-gray-900 transition-colors" onclick="showSection('create')">Create Request</button>
<button class="text-gray-600 hover:text-gray-900 transition-colors" onclick="showSection('my-groups')">My Groups</button>
</div>
<div class="flex items-center space-x-4">
<button class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors" onclick="toggleLanguage()">
<span id="language-toggle">中文</span>
</button>
<div class="relative">
<button class="p-2 text-gray-600 hover:text-gray-900 transition-colors relative" onclick="toggleNotifications()">
<i class="w-5 h-5" data-lucide="bell"></i>
<span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden" id="notification-badge">0</span>
</button>
<div class="absolute right-0 top-full mt-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="notifications-dropdown">
<div class="p-4 border-b">
<h3 class="font-semibold text-gray-900">Notifications</h3>
</div>
<div class="max-h-64 overflow-y-auto" id="notifications-list">
<div class="p-4 text-center text-gray-500">No notifications</div>
</div>
<div class="p-3 border-t text-center">
<button class="text-sm text-gray-600 hover:text-gray-800" onclick="clearAllNotifications()">Clear All</button>
</div>
</div>
</div>
<div class="relative">
<button class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 transition-colors" onclick="toggleUserMenu()">
<div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold" id="user-avatar">
                                G
                            </div>
<span class="text-sm font-medium text-gray-700 hidden md:block" id="user-name-display">Guest</span>
<i class="w-4 h-4 text-gray-500" data-lucide="chevron-down"></i>
</button>
<div class="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="user-menu">
<div class="hidden" id="logged-in-menu">
<div class="p-3 border-b">
<p class="font-medium text-gray-900" id="menu-user-name">User Name</p>
<p class="text-sm text-gray-600" id="menu-user-email">user@email.com</p>
</div>
<button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="profile-menu-btn" onclick="showSection('profile')">Profile Settings</button>
<button class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50" id="logout-menu-btn" onclick="logout()">Logout</button>
</div>
<div id="guest-menu">
<button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="login-menu-btn" onclick="showLoginModal()">Login</button>
<button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="signup-menu-btn" onclick="showSignupModal()">Create Account</button>
</div>
</div>
</div>
</div>
</div>
</div>
</nav>
<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<!-- Browse Section -->
<div class="section" id="browse-section">
<div class="mb-8">
<h1 class="text-3xl font-bold text-gray-900 mb-4" id="browse-title">Active Group Buy Requests</h1>
<div class="flex flex-col sm:flex-row gap-4">
<div class="flex-1">
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="search-requests" placeholder="Search by product name, ID, or host..." type="text"/>
</div>
<select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" id="filter-status">
<option value="all">All Status</option>
<option value="open">Open</option>
<option value="almost-full">Almost Full</option>
<option value="completed">Completed</option>
</select>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="requests-grid">
<!-- Requests will be populated here -->
</div>
</div>
<!-- Create Request Section -->
<div class="section hidden" id="create-section">
<div class="max-w-2xl mx-auto">
<h1 class="text-3xl font-bold text-gray-900 mb-8" id="create-title">Create Group Buy Request</h1>
<div class="bg-white rounded-xl shadow-lg p-8">
<form id="create-request-form">
<div class="mb-6">
<div class="flex justify-between items-center mb-4">
<h3 class="text-lg font-semibold text-gray-900" id="products-title">Products</h3>
<span class="text-sm text-gray-600" id="products-subtitle">Add multiple products to your group buy</span>
</div>
<div class="space-y-4 mb-4" id="selected-products-list">
<!-- Selected products will appear here -->
</div>
<div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
<div class="text-center mb-4">
<i class="w-8 h-8 text-gray-400 mx-auto mb-2" data-lucide="plus-circle"></i>
<p class="text-gray-600" id="add-product-text">Add a product to your group buy</p>
</div>
<div class="relative mb-4">
<input class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="product-search" placeholder="Search by product name or ID..." type="text"/>
<div class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg mt-1 search-dropdown hidden" id="search-results">
<!-- Search results will appear here -->
</div>
</div>
<div class="hidden" id="add-product-form">
<div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg" id="selected-product-preview">
<!-- Selected product preview will appear here -->
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" id="quantity-label">Your Required Quantity (lbs)</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="host-quantity" min="1" placeholder="e.g., 10" type="number"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" id="min-order-label">Minimum Order (lbs)</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="min-order-quantity" min="1" placeholder="e.g., 5" type="number" value="5"/>
</div>
</div>
<div class="mb-4 text-sm hidden" id="quantity-feedback">
<!-- Dynamic feedback will appear here -->
</div>
<div class="flex space-x-3">
<button class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors" id="add-product-btn" onclick="addProductToRequest()" type="button">
<i class="w-4 h-4 inline mr-2" data-lucide="plus"></i>
                                            Add Product
                                        </button>
<button class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors" id="cancel-product-btn" onclick="cancelAddProduct()" type="button">
                                            Cancel
                                        </button>
</div>
</div>
</div>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2" id="notes-label">Additional Notes (Optional)</label>
<textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="request-notes" placeholder="Any special requirements, pickup location preferences, etc..." rows="3"></textarea>
</div>
<button class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled="" id="create-request-btn" type="submit">
                            Create Group Buy Request
                        </button>
<p class="text-sm text-gray-500 text-center mt-2" id="create-help-text">Add at least one product to create your request</p>
</form>
</div>
</div>
</div>
<!-- My Groups Section -->
<div class="section hidden" id="my-groups-section">
<h1 class="text-3xl font-bold text-gray-900 mb-8" id="my-groups-title">My Group Buys</h1>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="my-groups-grid">
<!-- User's groups will be populated here -->
</div>
</div>
<!-- Profile Section -->
<div class="section hidden" id="profile-section">
<div class="max-w-2xl mx-auto">
<h1 class="text-3xl font-bold text-gray-900 mb-8" id="profile-settings-title">Profile Settings</h1>
<div class="bg-white rounded-xl shadow-lg p-8">
<div class="flex items-center space-x-6 mb-8">
<div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white text-2xl font-bold" id="profile-avatar">
                            U
                        </div>
<div>
<h2 class="text-xl font-semibold text-gray-900" id="profile-name">User Name</h2>
<p class="text-gray-600" id="profile-email">user@email.com</p>
</div>
</div>
<form id="profile-form">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" id="full-name-label">Full Name</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="profile-full-name" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" id="email-label">Email</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="profile-email-input" type="email"/>
</div>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2" id="phone-label">Phone Number</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="profile-phone" type="tel"/>
</div>
<div class="mb-6">
<h3 class="text-lg font-semibold text-gray-900 mb-4" id="notification-preferences-title">Notification Preferences</h3>
<div class="space-y-4">
<div class="bg-gray-50 p-4 rounded-lg">
<h4 class="font-medium text-gray-900 mb-3" id="notification-types-title">Receive notifications for:</h4>
<div class="space-y-2">
<label class="flex items-center">
<input checked="" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-new-participants" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-participants-label">New participants join my group buys</span>
</label>
<label class="flex items-center">
<input checked="" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-order-fulfilled" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-fulfilled-label">Orders are fulfilled/completed</span>
</label>
<label class="flex items-center">
<input checked="" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-quantity-changes" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-quantity-label">Participants adjust their quantities</span>
</label>
<label class="flex items-center">
<input checked="" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-cancellations" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-cancel-label">Group buys are cancelled or participants leave</span>
</label>
</div>
</div>
<div class="bg-gray-50 p-4 rounded-lg">
<h4 class="font-medium text-gray-900 mb-3" id="notification-methods-title">Notification methods:</h4>
<div class="space-y-2">
<label class="flex items-center">
<input checked="" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-browser" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-browser-label">Browser notifications (in-app)</span>
</label>
<label class="flex items-center">
<input class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-email" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-email-label">Email notifications</span>
</label>
<label class="flex items-center">
<input class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" id="notify-sms" type="checkbox"/>
<span class="ml-2 text-sm text-gray-700" id="notify-sms-label">SMS text messages</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-2" id="notification-note">Email and SMS notifications require verification and may have additional charges.</p>
</div>
</div>
</div>
<div class="flex space-x-4">
<button class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors" id="save-changes-btn" type="submit">
                                Save Changes
                            </button>
<button class="bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors" id="change-password-btn" onclick="showChangePasswordModal()" type="button">
                                Change Password
                            </button>
</div>
</form>
</div>
</div>
</div>
</div>
<!-- Request Detail Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="request-modal">
<div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
<div id="modal-content">
<!-- Modal content will be populated here -->
</div>
</div>
</div>
<!-- Chat Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="chat-modal">
<div class="bg-white rounded-xl max-w-2xl w-full h-[600px] flex flex-col">
<div class="p-4 border-b flex justify-between items-center">
<h3 class="text-lg font-semibold" id="chat-modal-title">Group Chat</h3>
<button class="text-gray-500 hover:text-gray-700" onclick="closeChatModal()">
<i class="w-5 h-5" data-lucide="x"></i>
</button>
</div>
<div class="flex-1 p-4 overflow-y-auto space-y-3" id="chat-messages">
<!-- Chat messages will appear here -->
</div>
<div class="p-4 border-t">
<div class="flex space-x-2">
<input class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="chat-input" placeholder="Type your message..." type="text"/>
<button class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors" onclick="sendMessage()">
<i class="w-4 h-4" data-lucide="send"></i>
</button>
</div>
</div>
</div>
</div>
<!-- Login Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="login-modal">
<div class="bg-white rounded-xl max-w-md w-full">
<div class="p-6">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-900" id="login-modal-title">Login</h2>
<button class="text-gray-500 hover:text-gray-700" onclick="closeLoginModal()">
<i class="w-6 h-6" data-lucide="x"></i>
</button>
</div>
<form id="login-form">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2" id="login-identifier-label">Email or Phone</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="login-identifier" required="" type="text"/>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2" id="login-password-label">Password</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="login-password" required="" type="password"/>
</div>
<button class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors mb-4" id="login-submit-btn" type="submit">
                        Login
                    </button>
<div class="text-center">
<span class="text-sm text-gray-600" id="login-signup-text">Don't have an account? </span>
<button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium" id="login-signup-btn" onclick="showSignupModal()" type="button">
                            Sign up
                        </button>
</div>
</form>
</div>
</div>
</div>
<!-- Signup Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="signup-modal">
<div class="bg-white rounded-xl max-w-md w-full">
<div class="p-6">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-900" id="signup-modal-title">Create Account</h2>
<button class="text-gray-500 hover:text-gray-700" onclick="closeSignupModal()">
<i class="w-6 h-6" data-lucide="x"></i>
</button>
</div>
<form id="signup-form">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2" id="signup-name-label">Full Name</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="signup-name" required="" type="text"/>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2" id="signup-email-label">Email</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="signup-email" required="" type="email"/>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2" id="signup-phone-label">Phone Number</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="signup-phone" required="" type="tel"/>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2" id="signup-password-label">Password</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="signup-password" required="" type="password"/>
<p class="text-xs text-gray-500 mt-1" id="signup-password-help">Must be at least 8 characters</p>
</div>
<button class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors mb-4" id="signup-submit-btn" type="submit">
                        Create Account
                    </button>
<div class="text-center">
<span class="text-sm text-gray-600" id="signup-login-text">Already have an account? </span>
<button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium" id="signup-login-btn" onclick="showLoginModal()" type="button">
                            Login
                        </button>
</div>
</form>
</div>
</div>
</div>
<!-- Change Password Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="change-password-modal">
<div class="bg-white rounded-xl max-w-md w-full">
<div class="p-6">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-900">Change Password</h2>
<button class="text-gray-500 hover:text-gray-700" onclick="closeChangePasswordModal()">
<i class="w-6 h-6" data-lucide="x"></i>
</button>
</div>
<form id="change-password-form">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="current-password" required="" type="password"/>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="new-password" required="" type="password"/>
</div>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
<input class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" id="confirm-password" required="" type="password"/>
</div>
<button class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors" type="submit">
                        Change Password
                    </button>
</form>
</div>
</div>
</div>
<script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Sample product database
        var productDatabase = [
            {
                id: "P001",
                englishName: "Premium Organic Apples",
                chineseName: "优质有机苹果",
                caseWeight: 40,
                packaging: "Cardboard box, 40 individual apples",
                image: "🍎",
                category: "Fruits"
            },
            {
                id: "P002", 
                englishName: "Fresh Atlantic Salmon",
                chineseName: "新鲜大西洋三文鱼",
                caseWeight: 25,
                packaging: "Vacuum sealed, ice packed",
                image: "🐟",
                category: "Seafood"
            },
            {
                id: "P003",
                englishName: "Organic Baby Spinach",
                chineseName: "有机嫩菠菜",
                caseWeight: 15,
                packaging: "Plastic containers, pre-washed",
                image: "🥬",
                category: "Vegetables"
            },
            {
                id: "P004",
                englishName: "Premium Wagyu Beef",
                chineseName: "优质和牛肉",
                caseWeight: 30,
                packaging: "Vacuum sealed portions",
                image: "🥩",
                category: "Meat"
            },
            {
                id: "P005",
                englishName: "Imported Italian Pasta",
                chineseName: "进口意大利面条",
                caseWeight: 20,
                packaging: "Individual 1lb packages",
                image: "🍝",
                category: "Pantry"
            },
            {
                id: "P006",
                englishName: "Organic Blueberries",
                chineseName: "有机蓝莓",
                caseWeight: 12,
                packaging: "Plastic pint containers",
                image: "🫐",
                category: "Fruits"
            }
        ];
        
        // User accounts database
        var userAccounts = [
            {
                id: 1,
                name: "Sarah Chen",
                email: "sarah.chen@email.com",
                phone: "+1-555-0101",
                password: "password123",
                avatar: "S",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 2,
                name: "David Kim",
                email: "david.kim@email.com",
                phone: "+1-555-0102",
                password: "password123",
                avatar: "D",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 3,
                name: "Emma Liu",
                email: "emma.liu@email.com",
                phone: "+1-555-0103",
                password: "password123",
                avatar: "E",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 4,
                name: "Mike Johnson",
                email: "mike.johnson@email.com",
                phone: "+1-555-0104",
                password: "password123",
                avatar: "M",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            }
        ];
        
        // Current user session
        var currentUser = null;
        var isLoggedIn = false;
        
        // Notifications system
        var userNotifications = [];
        
        // Sample group buy requests
        var groupBuyRequests = [
            {
                id: 1,
                hostName: "Sarah Chen",
                items: [
                    {
                        productId: "P001",
                        hostQuantity: 10,
                        totalQuantity: 40,
                        currentQuantity: 25,
                        participants: [
                            { name: "Sarah Chen", quantity: 10, isHost: true },
                            { name: "Mike Johnson", quantity: 8 },
                            { name: "Lisa Wang", quantity: 7 }
                        ],
                        status: "open"
                    }
                ],
                notes: "Pickup available in downtown area. Prefer weekend pickup.",
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                chatEnabled: true
            },
            {
                id: 2,
                hostName: "David Kim",
                items: [
                    {
                        productId: "P002",
                        hostQuantity: 5,
                        totalQuantity: 25,
                        currentQuantity: 25,
                        participants: [
                            { name: "David Kim", quantity: 5, isHost: true },
                            { name: "Emma Liu", quantity: 8 },
                            { name: "John Smith", quantity: 6 },
                            { name: "Amy Zhang", quantity: 6 }
                        ],
                        status: "completed"
                    }
                ],
                notes: "Fresh delivery required. Split payment via Venmo.",
                createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                chatEnabled: true
            }
        ];
        
        // Chat messages for each request
        var chatMessages = {
            1: [
                { sender: "Sarah Chen", message: "Hi everyone! Thanks for joining my apple group buy 🍎", timestamp: new Date(Date.now() - 60 * 60 * 1000) },
                { sender: "Mike Johnson", message: "Thanks for organizing! When are you thinking for pickup?", timestamp: new Date(Date.now() - 45 * 60 * 1000) },
                { sender: "Sarah Chen", message: "I was thinking this Saturday around 2 PM at the farmer's market?", timestamp: new Date(Date.now() - 30 * 60 * 1000) },
                { sender: "Lisa Wang", message: "Saturday works for me! Should we split the payment now or at pickup?", timestamp: new Date(Date.now() - 15 * 60 * 1000) }
            ],
            2: [
                { sender: "David Kim", message: "Salmon group buy almost full! Just 2 lbs left 🐟", timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000) },
                { sender: "Emma Liu", message: "This is so fresh! Can't wait to try it", timestamp: new Date(Date.now() - 90 * 60 * 1000) },
                { sender: "John Smith", message: "I can help with pickup if needed", timestamp: new Date(Date.now() - 60 * 60 * 1000) }
            ]
        };
        
        var currentChatRequestId = null;
        var currentLanguage = 'en';
        var selectedProducts = []; // Array to store products being added to the request
        var currentSelectedProduct = null; // Currently selected product for adding
        
        // Language translation system
        var translations = {
            en: {
                'Browse Requests': 'Browse Requests',
                'Create Request': 'Create Request', 
                'My Groups': 'My Groups',
                'View Details': 'View Details',
                'Cancel Request': 'Cancel Request',
                'Opt Out': 'Opt Out',
                'Chat💬': 'Chat💬',
                'Host': 'Host',
                'Participant': 'Participant',
                'Login': 'Login',
                'Logout': 'Logout',
                'Profile Settings': 'Profile Settings',
                'Create Account': 'Create Account',
                'No requests found': 'No requests found',
                'Try adjusting your search or filter criteria': 'Try adjusting your search or filter criteria',
                'No group buys yet': 'No group buys yet',
                'You haven\'t created or joined any group buys': 'You haven\'t created or joined any group buys',
                'Please log in': 'Please log in',
                'You need to be logged in to view your group buys': 'You need to be logged in to view your group buys',
                'All Status': 'All Status',
                'Open': 'Open',
                'Almost Full': 'Almost Full',
                'Completed': 'Completed',
                'Search by product name, ID, or host...': 'Search by product name, ID, or host...',
                'Create Group Buy Request': 'Create Group Buy Request',
                'Products': 'Products',
                'Add multiple products to your group buy': 'Add multiple products to your group buy',
                'Add a product to your group buy': 'Add a product to your group buy',
                'Search by product name or ID...': 'Search by product name or ID...',
                'Additional Notes (Optional)': 'Additional Notes (Optional)',
                'Any special requirements, pickup location preferences, etc...': 'Any special requirements, pickup location preferences, etc...',
                'Add at least one product to create your request': 'Add at least one product to create your request',
                'participants': 'participants',
                'Your Quantity': 'Your Quantity',
                'Case Total': 'Case Total',
                'Remaining': 'Remaining',
                'Minimum order': 'Minimum order',
                'You take': 'You take',
                'Remaining for others': 'Remaining for others',
                'Progress': 'Progress',
                'Participants': 'Participants',
                'Your quantity (lbs)': 'Your quantity (lbs)',
                'Min': 'Min',
                'Available': 'Available',
                'Join': 'Join',
                'Update': 'Update',
                'Total Case': 'Total Case',
                'Committed': 'Committed',
                'Active Group Buy Requests': 'Active Group Buy Requests',
                'My Group Buys': 'My Group Buys'
            },
            zh: {
                'Browse Requests': '瀏覽請求',
                'Create Request': '創建請求',
                'My Groups': '我的團購',
                'View Details': '查看詳情',
                'Cancel Request': '取消請求',
                'Opt Out': '退出',
                'Chat💬': '聊天💬',
                'Host': '主辦人',
                'Participant': '參與者',
                'Login': '登入',
                'Logout': '登出',
                'Profile Settings': '個人設定',
                'Create Account': '創建帳戶',
                'Email or Phone': '電子郵件或電話',
                'Password': '密碼',
                'Don\'t have an account?': '還沒有帳戶？',
                'Sign up': '註冊',
                'Full Name': '全名',
                'Email': '電子郵件',
                'Phone Number': '電話號碼',
                'Must be at least 8 characters': '必須至少8個字符',
                'Already have an account?': '已經有帳戶了？',
                'No requests found': '找不到請求',
                'Try adjusting your search or filter criteria': '請嘗試調整搜索或篩選條件',
                'No group buys yet': '尚無團購',
                'You haven\'t created or joined any group buys': '您尚未創建或加入任何團購',
                'Please log in': '請登入',
                'You need to be logged in to view your group buys': '您需要登入才能查看您的團購',
                'All Status': '所有狀態',
                'Open': '開放中',
                'Almost Full': '即將滿額',
                'Completed': '已完成',
                'Search by product name, ID, or host...': '按產品名稱、ID或主辦人搜索...',
                'Create Group Buy Request': '創建團購請求',
                'Products': '產品',
                'Add multiple products to your group buy': '為您的團購添加多個產品',
                'Add a product to your group buy': '為您的團購添加產品',
                'Search by product name or ID...': '按產品名稱或ID搜索...',
                'Additional Notes (Optional)': '附加說明（可選）',
                'Any special requirements, pickup location preferences, etc...': '任何特殊要求、取貨地點偏好等...',
                'Add at least one product to create your request': '至少添加一個產品才能創建請求',
                'Total Case Weight': '總箱重量',
                'Packaging': '包裝',
                'Product ID': '產品編號',
                'Your Required Quantity (lbs)': '您需要的數量（磅）',
                'Minimum Order (lbs)': '最小訂購量（磅）',
                'Add Product': '添加產品',
                'Cancel': '取消',
                'participants': '參與者',
                'Your Quantity': '您的數量',
                'Case Total': '箱總重',
                'Remaining': '剩餘',
                'Minimum order': '最小訂購量',
                'You take': '您需要',
                'Remaining for others': '其他人剩餘',
                'Progress': '進度',
                'Participants': '參與者',
                'Your quantity (lbs)': '您的數量（磅）',
                'Min': '最少',
                'Available': '可用',
                'Join': '加入',
                'Update': '更新',
                'Total Case': '總箱重',
                'Committed': '已承諾',
                'Active Group Buy Requests': '活躍團購請求',
                'My Group Buys': '我的團購',
                'Profile Settings': '個人設定',
                'Full Name': '全名',
                'Email': '電子郵件',
                'Phone Number': '電話號碼',
                'Save Changes': '保存更改',
                'Change Password': '更改密碼',
                'Notification Preferences': '通知偏好',
                'Receive notifications for:': '接收以下通知：',
                'New participants join my group buys': '新參與者加入我的團購',
                'Orders are fulfilled/completed': '訂單已完成/履行',
                'Participants adjust their quantities': '參與者調整數量',
                'Group buys are cancelled or participants leave': '團購被取消或參與者離開',
                'Notification methods:': '通知方式：',
                'Browser notifications (in-app)': '瀏覽器通知（應用內）',
                'Email notifications': '電子郵件通知',
                'SMS text messages': '短信通知',
                'Email and SMS notifications require verification and may have additional charges.': '電子郵件和短信通知需要驗證，可能產生額外費用。'
            }
        };
        
        function getText(key) {
            return translations[currentLanguage][key] || key;
        }
        
        function updateInterfaceLanguage() {
            // Update navigation buttons by onclick attribute
            var browseBtn = document.querySelector('button[onclick="showSection(\'browse\')"]');
            var createBtn = document.querySelector('button[onclick="showSection(\'create\')"]');
            var myGroupsBtn = document.querySelector('button[onclick="showSection(\'my-groups\')"]');
            
            if (browseBtn) browseBtn.textContent = getText('Browse Requests');
            if (createBtn) createBtn.textContent = getText('Create Request');
            if (myGroupsBtn) myGroupsBtn.textContent = getText('My Groups');
            
            // Update filter dropdown
            var filterSelect = document.getElementById('filter-status');
            if (filterSelect) {
                var options = filterSelect.querySelectorAll('option');
                options.forEach(option => {
                    var value = option.value;
                    if (value === 'all') option.textContent = getText('All Status');
                    if (value === 'open') option.textContent = getText('Open');
                    if (value === 'almost-full') option.textContent = getText('Almost Full');
                    if (value === 'completed') option.textContent = getText('Completed');
                });
            }
            
            // Update search placeholder
            var searchInput = document.getElementById('search-requests');
            if (searchInput) {
                searchInput.placeholder = getText('Search by product name, ID, or host...');
            }
            
            // Update page titles
            var browseTitle = document.getElementById('browse-title');
            if (browseTitle) browseTitle.textContent = getText('Active Group Buy Requests');
            
            var myGroupsTitle = document.getElementById('my-groups-title');
            if (myGroupsTitle) myGroupsTitle.textContent = getText('My Group Buys');
            
            var profileTitle = document.getElementById('profile-settings-title');
            if (profileTitle) profileTitle.textContent = getText('Profile Settings');
            
            // Update create form elements
            var createTitle = document.getElementById('create-title');
            if (createTitle) createTitle.textContent = getText('Create Group Buy Request');
            
            var productsTitle = document.getElementById('products-title');
            if (productsTitle) productsTitle.textContent = getText('Products');
            
            var productsSubtitle = document.getElementById('products-subtitle');
            if (productsSubtitle) productsSubtitle.textContent = getText('Add multiple products to your group buy');
            
            var addProductText = document.getElementById('add-product-text');
            if (addProductText) addProductText.textContent = getText('Add a product to your group buy');
            
            var productSearchInput = document.getElementById('product-search');
            if (productSearchInput) productSearchInput.placeholder = getText('Search by product name or ID...');
            
            var notesLabel = document.getElementById('notes-label');
            if (notesLabel) notesLabel.textContent = getText('Additional Notes (Optional)');
            
            var notesTextarea = document.getElementById('request-notes');
            if (notesTextarea) notesTextarea.placeholder = getText('Any special requirements, pickup location preferences, etc...');
            
            var createBtn2 = document.getElementById('create-request-btn');
            if (createBtn2) createBtn2.textContent = getText('Create Group Buy Request');
            
            var createHelpText = document.getElementById('create-help-text');
            if (createHelpText) createHelpText.textContent = getText('Add at least one product to create your request');
            
            // Update product form elements
            var quantityLabel = document.getElementById('quantity-label');
            if (quantityLabel) quantityLabel.textContent = getText('Your Required Quantity (lbs)');
            
            var minOrderLabel = document.getElementById('min-order-label');
            if (minOrderLabel) minOrderLabel.textContent = getText('Minimum Order (lbs)');
            
            var addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) {
                var icon = addProductBtn.querySelector('i');
                addProductBtn.innerHTML = '';
                if (icon) addProductBtn.appendChild(icon);
                addProductBtn.appendChild(document.createTextNode(getText('Add Product')));
            }
            
            var cancelProductBtn = document.getElementById('cancel-product-btn');
            if (cancelProductBtn) cancelProductBtn.textContent = getText('Cancel');
            
            // Update profile form elements
            var fullNameLabel = document.getElementById('full-name-label');
            if (fullNameLabel) fullNameLabel.textContent = getText('Full Name');
            
            var emailLabel = document.getElementById('email-label');
            if (emailLabel) emailLabel.textContent = getText('Email');
            
            var phoneLabel = document.getElementById('phone-label');
            if (phoneLabel) phoneLabel.textContent = getText('Phone Number');
            
            var saveChangesBtn = document.getElementById('save-changes-btn');
            if (saveChangesBtn) saveChangesBtn.textContent = getText('Save Changes');
            
            var changePasswordBtn = document.getElementById('change-password-btn');
            if (changePasswordBtn) changePasswordBtn.textContent = getText('Change Password');
            
            // Update notification preferences
            var notificationPreferencesTitle = document.getElementById('notification-preferences-title');
            if (notificationPreferencesTitle) notificationPreferencesTitle.textContent = getText('Notification Preferences');
            
            var notificationTypesTitle = document.getElementById('notification-types-title');
            if (notificationTypesTitle) notificationTypesTitle.textContent = getText('Receive notifications for:');
            
            var notifyParticipantsLabel = document.getElementById('notify-participants-label');
            if (notifyParticipantsLabel) notifyParticipantsLabel.textContent = getText('New participants join my group buys');
            
            var notifyFulfilledLabel = document.getElementById('notify-fulfilled-label');
            if (notifyFulfilledLabel) notifyFulfilledLabel.textContent = getText('Orders are fulfilled/completed');
            
            var notifyQuantityLabel = document.getElementById('notify-quantity-label');
            if (notifyQuantityLabel) notifyQuantityLabel.textContent = getText('Participants adjust their quantities');
            
            var notifyCancelLabel = document.getElementById('notify-cancel-label');
            if (notifyCancelLabel) notifyCancelLabel.textContent = getText('Group buys are cancelled or participants leave');
            
            var notificationMethodsTitle = document.getElementById('notification-methods-title');
            if (notificationMethodsTitle) notificationMethodsTitle.textContent = getText('Notification methods:');
            
            var notifyBrowserLabel = document.getElementById('notify-browser-label');
            if (notifyBrowserLabel) notifyBrowserLabel.textContent = getText('Browser notifications (in-app)');
            
            var notifyEmailLabel = document.getElementById('notify-email-label');
            if (notifyEmailLabel) notifyEmailLabel.textContent = getText('Email notifications');
            
            var notifySmsLabel = document.getElementById('notify-sms-label');
            if (notifySmsLabel) notifySmsLabel.textContent = getText('SMS text messages');
            
            var notificationNote = document.getElementById('notification-note');
            if (notificationNote) notificationNote.textContent = getText('Email and SMS notifications require verification and may have additional charges.');
            
            // Update menu buttons
            var profileMenuBtn = document.getElementById('profile-menu-btn');
            if (profileMenuBtn) profileMenuBtn.textContent = getText('Profile Settings');
            
            var logoutMenuBtn = document.getElementById('logout-menu-btn');
            if (logoutMenuBtn) logoutMenuBtn.textContent = getText('Logout');
            
            var loginMenuBtn = document.getElementById('login-menu-btn');
            if (loginMenuBtn) loginMenuBtn.textContent = getText('Login');
            
            var signupMenuBtn = document.getElementById('signup-menu-btn');
            if (signupMenuBtn) signupMenuBtn.textContent = getText('Create Account');
            
            // Update login modal elements
            var loginModalTitle = document.getElementById('login-modal-title');
            if (loginModalTitle) loginModalTitle.textContent = getText('Login');
            
            var loginIdentifierLabel = document.getElementById('login-identifier-label');
            if (loginIdentifierLabel) loginIdentifierLabel.textContent = getText('Email or Phone');
            
            var loginPasswordLabel = document.getElementById('login-password-label');
            if (loginPasswordLabel) loginPasswordLabel.textContent = getText('Password');
            
            var loginSubmitBtn = document.getElementById('login-submit-btn');
            if (loginSubmitBtn) loginSubmitBtn.textContent = getText('Login');
            
            var loginSignupText = document.getElementById('login-signup-text');
            if (loginSignupText) loginSignupText.textContent = getText('Don\'t have an account?') + ' ';
            
            var loginSignupBtn = document.getElementById('login-signup-btn');
            if (loginSignupBtn) loginSignupBtn.textContent = getText('Sign up');
            
            // Update signup modal elements
            var signupModalTitle = document.getElementById('signup-modal-title');
            if (signupModalTitle) signupModalTitle.textContent = getText('Create Account');
            
            var signupNameLabel = document.getElementById('signup-name-label');
            if (signupNameLabel) signupNameLabel.textContent = getText('Full Name');
            
            var signupEmailLabel = document.getElementById('signup-email-label');
            if (signupEmailLabel) signupEmailLabel.textContent = getText('Email');
            
            var signupPhoneLabel = document.getElementById('signup-phone-label');
            if (signupPhoneLabel) signupPhoneLabel.textContent = getText('Phone Number');
            
            var signupPasswordLabel = document.getElementById('signup-password-label');
            if (signupPasswordLabel) signupPasswordLabel.textContent = getText('Password');
            
            var signupPasswordHelp = document.getElementById('signup-password-help');
            if (signupPasswordHelp) signupPasswordHelp.textContent = getText('Must be at least 8 characters');
            
            var signupSubmitBtn = document.getElementById('signup-submit-btn');
            if (signupSubmitBtn) signupSubmitBtn.textContent = getText('Create Account');
            
            var signupLoginText = document.getElementById('signup-login-text');
            if (signupLoginText) signupLoginText.textContent = getText('Already have an account?') + ' ';
            
            var signupLoginBtn = document.getElementById('signup-login-btn');
            if (signupLoginBtn) signupLoginBtn.textContent = getText('Login');
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupProductSearch();
            setupQuantityFeedback();
            setupCreateRequestForm();
            setupSearchAndFilter();
            setupChatInput();
            setupLoginForm();
            setupSignupForm();
            setupChangePasswordForm();
            setupProfileForm();
            
            updateUserInterface();
            updateInterfaceLanguage();
            renderRequests();
            lucide.createIcons();
        });
        
        // Navigation functions
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            var targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            if (sectionName === 'browse') {
                renderRequests();
            } else if (sectionName === 'my-groups') {
                renderMyGroups();
            }
            
            document.getElementById('user-menu').classList.add('hidden');
            document.getElementById('notifications-dropdown').classList.add('hidden');
        }
        
        // Authentication Functions
        function showLoginModal() {
            closeAllModals();
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
        }
        
        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }
        
        function showSignupModal() {
            closeAllModals();
            document.getElementById('signup-modal').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
        }
        
        function closeSignupModal() {
            document.getElementById('signup-modal').classList.add('hidden');
        }
        
        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('hidden');
        }
        
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('hidden');
        }
        
        function closeAllModals() {
            var modals = [
                'login-modal',
                'signup-modal', 
                'change-password-modal',
                'request-modal',
                'chat-modal'
            ];
            
            modals.forEach(modalId => {
                var modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        // User menu functions
        function toggleUserMenu() {
            var menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
        
        function toggleNotifications() {
            var dropdown = document.getElementById('notifications-dropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                renderNotifications();
            }
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
            var toggle = document.getElementById('language-toggle');
            toggle.textContent = currentLanguage === 'en' ? '中文' : 'EN';
            
            // Update all interface elements
            updateInterfaceLanguage();
            
            // Re-render all sections to show translated content
            renderRequests();
            renderMyGroups();
        }
        
        // Update user interface based on login status
        function updateUserInterface() {
            var userAvatar = document.getElementById('user-avatar');
            var userNameDisplay = document.getElementById('user-name-display');
            var loggedInMenu = document.getElementById('logged-in-menu');
            var guestMenu = document.getElementById('guest-menu');
            
            if (isLoggedIn && currentUser) {
                var user = userAccounts.find(u => u.name === currentUser);
                
                userAvatar.textContent = user.avatar;
                userNameDisplay.textContent = user.name;
                userNameDisplay.classList.remove('hidden');
                
                loggedInMenu.classList.remove('hidden');
                guestMenu.classList.add('hidden');
                
                document.getElementById('menu-user-name').textContent = user.name;
                document.getElementById('menu-user-email').textContent = user.email;
                
                document.getElementById('profile-name').textContent = user.name;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-avatar').textContent = user.avatar;
                document.getElementById('profile-full-name').value = user.name;
                document.getElementById('profile-email-input').value = user.email;
                document.getElementById('profile-phone').value = user.phone;
                
                // Load notification preferences
                if (user.notificationPreferences) {
                    document.getElementById('notify-new-participants').checked = user.notificationPreferences.newParticipants;
                    document.getElementById('notify-order-fulfilled').checked = user.notificationPreferences.orderFulfilled;
                    document.getElementById('notify-quantity-changes').checked = user.notificationPreferences.quantityChanges;
                    document.getElementById('notify-cancellations').checked = user.notificationPreferences.cancellations;
                    document.getElementById('notify-browser').checked = user.notificationPreferences.browserNotifications;
                    document.getElementById('notify-email').checked = user.notificationPreferences.emailNotifications;
                    document.getElementById('notify-sms').checked = user.notificationPreferences.smsNotifications;
                }
                
            } else {
                userAvatar.textContent = 'G';
                userNameDisplay.textContent = 'Guest';
                userNameDisplay.classList.add('hidden');
                
                loggedInMenu.classList.add('hidden');
                guestMenu.classList.remove('hidden');
                
                currentUser = 'Guest User';
            }
        }
        
        // Logout function
        function logout() {
            currentUser = null;
            isLoggedIn = false;
            userNotifications = [];
            updateUserInterface();
            showSection('browse');
            showNotification('Logged out successfully! 👋');
        }
        
        // Form handlers
        function setupLoginForm() {
            var loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var identifier = document.getElementById('login-identifier').value.trim();
                var password = document.getElementById('login-password').value;
                
                var user = userAccounts.find(u => 
                    u.email.toLowerCase() === identifier.toLowerCase() || 
                    u.phone === identifier
                );
                
                if (user && user.password === password) {
                    currentUser = user.name;
                    isLoggedIn = true;
                    
                    closeLoginModal();
                    updateUserInterface();
                    renderRequests();
                    
                    showNotification(`Welcome back, ${user.name}! 👋`);
                } else {
                    alert('Invalid email/phone or password. Please try again.');
                }
            });
        }
        
        function setupSignupForm() {
            var signupForm = document.getElementById('signup-form');
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var name = document.getElementById('signup-name').value.trim();
                var email = document.getElementById('signup-email').value.trim();
                var phone = document.getElementById('signup-phone').value.trim();
                var password = document.getElementById('signup-password').value;
                
                if (password.length < 8) {
                    alert('Password must be at least 8 characters long.');
                    return;
                }
                
                var newUser = {
                    id: userAccounts.length + 1,
                    name: name,
                    email: email,
                    phone: phone,
                    password: password,
                    avatar: name.charAt(0).toUpperCase(),
                    notificationPreferences: {
                        newParticipants: true,
                        orderFulfilled: true,
                        quantityChanges: true,
                        cancellations: true,
                        browserNotifications: true,
                        emailNotifications: false,
                        smsNotifications: false
                    }
                };
                
                userAccounts.push(newUser);
                currentUser = newUser.name;
                isLoggedIn = true;
                
                closeSignupModal();
                updateUserInterface();
                renderRequests();
                
                showNotification(`Account created successfully! Welcome to SaveGo, ${name}! 🎉`);
            });
        }
        
        function setupChangePasswordForm() {
            var form = document.getElementById('change-password-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var currentPassword = document.getElementById('current-password').value;
                var newPassword = document.getElementById('new-password').value;
                var confirmPassword = document.getElementById('confirm-password').value;
                
                var user = userAccounts.find(u => u.name === currentUser);
                
                if (!user || user.password !== currentPassword) {
                    alert('Current password is incorrect.');
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert('New password must be at least 8 characters long.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match.');
                    return;
                }
                
                user.password = newPassword;
                closeChangePasswordModal();
                showNotification('Password changed successfully! 🔒');
            });
        }
        
        function setupProfileForm() {
            var form = document.getElementById('profile-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                var user = userAccounts.find(u => u.name === currentUser);
                if (!user) return;
                
                var newName = document.getElementById('profile-full-name').value.trim();
                var newEmail = document.getElementById('profile-email-input').value.trim();
                var newPhone = document.getElementById('profile-phone').value.trim();
                
                // Update notification preferences
                user.notificationPreferences = {
                    newParticipants: document.getElementById('notify-new-participants').checked,
                    orderFulfilled: document.getElementById('notify-order-fulfilled').checked,
                    quantityChanges: document.getElementById('notify-quantity-changes').checked,
                    cancellations: document.getElementById('notify-cancellations').checked,
                    browserNotifications: document.getElementById('notify-browser').checked,
                    emailNotifications: document.getElementById('notify-email').checked,
                    smsNotifications: document.getElementById('notify-sms').checked
                };
                
                var oldName = user.name;
                user.name = newName;
                user.email = newEmail;
                user.phone = newPhone;
                
                if (oldName !== newName) {
                    currentUser = newName;
                    
                    groupBuyRequests.forEach(request => {
                        if (request.hostName === oldName) {
                            request.hostName = newName;
                        }
                        request.items.forEach(item => {
                            item.participants.forEach(participant => {
                                if (participant.name === oldName) {
                                    participant.name = newName;
                                }
                            });
                        });
                    });
                }
                
                updateUserInterface();
                showNotification('Profile updated successfully! ✅');
            });
        }
        
        // Product search functionality
        function setupProductSearch() {
            var searchInput = document.getElementById('product-search');
            var searchResults = document.getElementById('search-results');
            
            searchInput.addEventListener('input', function() {
                var query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                var filteredProducts = productDatabase.filter(product => {
                    return product.englishName.toLowerCase().includes(query) ||
                           product.chineseName.includes(query) ||
                           product.id.toLowerCase().includes(query) ||
                           product.category.toLowerCase().includes(query);
                });
                
                if (filteredProducts.length > 0) {
                    var resultsHTML = filteredProducts.map(product => `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0" onclick="selectProduct('${product.id}')">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">${product.image}</div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</div>
                                    <div class="text-sm text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</div>
                                    <div class="text-xs text-gray-500">ID: ${product.id} • ${product.caseWeight} lbs case • ${product.category}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    searchResults.innerHTML = resultsHTML;
                    searchResults.classList.remove('hidden');
                } else {
                    searchResults.innerHTML = '<div class="p-3 text-gray-500 text-center">No products found</div>';
                    searchResults.classList.remove('hidden');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }
        
        function selectProduct(productId) {
            var product = productDatabase.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product is already added
            if (selectedProducts.find(p => p.productId === productId)) {
                alert('This product is already added to your request');
                return;
            }
            
            var searchResults = document.getElementById('search-results');
            var searchInput = document.getElementById('product-search');
            var addProductForm = document.getElementById('add-product-form');
            var productPreview = document.getElementById('selected-product-preview');
            
            currentSelectedProduct = product;
            searchInput.value = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            searchResults.classList.add('hidden');
            
            productPreview.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="text-4xl">${product.image}</div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h3>
                        <p class="text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded-lg border">
                                <p class="text-sm font-medium text-gray-700 mb-1">${getText('Total Case Weight')}</p>
                                <p class="text-2xl font-bold text-indigo-600">${product.caseWeight} lbs</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border">
                                <p class="text-sm font-medium text-gray-700 mb-1">${getText('Packaging')}</p>
                                <p class="text-sm text-gray-600">${product.packaging}</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            <p><span class="font-medium">${getText('Product ID')}:</span> ${product.id}</p>
                        </div>
                    </div>
                </div>
            `;
            
            addProductForm.classList.remove('hidden');
            
            // Clear previous inputs
            document.getElementById('host-quantity').value = '';
            document.getElementById('min-order-quantity').value = '5';
            document.getElementById('quantity-feedback').classList.add('hidden');
            
            lucide.createIcons();
        }
        
        // Setup quantity input feedback
        function setupQuantityFeedback() {
            var quantityInput = document.getElementById('host-quantity');
            var minOrderInput = document.getElementById('min-order-quantity');
            var feedbackDiv = document.getElementById('quantity-feedback');
            var selectedProduct = document.getElementById('selected-product');
            
            function updateFeedback() {
                var quantity = parseInt(quantityInput.value);
                var minOrder = parseInt(minOrderInput.value) || 5;
                
                if (!currentSelectedProduct || !quantity) {
                    feedbackDiv.classList.add('hidden');
                    return;
                }
                
                var product = currentSelectedProduct;
                var remaining = product.caseWeight - quantity;
                
                if (quantity > product.caseWeight) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center space-x-2 text-red-600">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span>Cannot exceed total case weight of ${product.caseWeight} lbs</span>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                } else if (quantity > 0 && quantity < minOrder) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center space-x-2 text-yellow-600">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            <span>${currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`}</span>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                } else if (quantity >= minOrder) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center space-x-2 text-green-700">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>${getText('You take')}: <strong>${quantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</strong></span>
                            </div>
                            <div class="text-green-600 font-medium">
                                ${getText('Remaining for others')}: <strong>${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</strong>
                            </div>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                    lucide.createIcons();
                } else {
                    feedbackDiv.classList.add('hidden');
                }
            }
            
            quantityInput.addEventListener('input', updateFeedback);
            minOrderInput.addEventListener('input', updateFeedback);
        }
        
        // Add product to request
        function addProductToRequest() {
            if (!currentSelectedProduct) return;
            
            var quantity = parseInt(document.getElementById('host-quantity').value);
            var minOrder = parseInt(document.getElementById('min-order-quantity').value) || 5;
            
            if (!quantity || quantity < minOrder) {
                alert(`Please enter a valid quantity (minimum ${minOrder} lbs)`);
                return;
            }
            
            if (quantity > currentSelectedProduct.caseWeight) {
                alert(`Quantity cannot exceed ${currentSelectedProduct.caseWeight} lbs`);
                return;
            }
            
            // Add to selected products
            selectedProducts.push({
                productId: currentSelectedProduct.id,
                hostQuantity: quantity,
                minOrderQuantity: minOrder
            });
            
            // Reset form
            cancelAddProduct();
            renderSelectedProducts();
            updateCreateButtonState();
            
            showNotification(`${currentLanguage === 'zh' ? currentSelectedProduct.chineseName : currentSelectedProduct.englishName} added to your request! ✅`);
        }
        
        // Cancel adding product
        function cancelAddProduct() {
            document.getElementById('add-product-form').classList.add('hidden');
            document.getElementById('product-search').value = '';
            document.getElementById('host-quantity').value = '';
            document.getElementById('min-order-quantity').value = '5';
            document.getElementById('quantity-feedback').classList.add('hidden');
            currentSelectedProduct = null;
        }
        
        // Remove product from request
        function removeProductFromRequest(productId) {
            selectedProducts = selectedProducts.filter(p => p.productId !== productId);
            renderSelectedProducts();
            updateCreateButtonState();
            
            var product = productDatabase.find(p => p.id === productId);
            showNotification(`${currentLanguage === 'zh' ? product.chineseName : product.englishName} removed from your request`);
        }
        
        // Render selected products
        function renderSelectedProducts() {
            var container = document.getElementById('selected-products-list');
            
            if (selectedProducts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedProducts.map((selectedProduct, index) => {
                var product = productDatabase.find(p => p.id === selectedProduct.productId);
                var remaining = product.caseWeight - selectedProduct.hostQuantity;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 animate-fade-in">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <div class="text-3xl">${product.image}</div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                    <p class="text-sm text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                                    <p class="text-xs text-gray-500">ID: ${product.id}</p>
                                    
                                    <div class="mt-3 grid grid-cols-3 gap-4">
                                        <div class="bg-blue-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Your Quantity')}</p>
                                            <p class="text-lg font-bold text-blue-600">${selectedProduct.hostQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-green-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Case Total')}</p>
                                            <p class="text-lg font-bold text-green-600">${product.caseWeight} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-orange-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Remaining')}</p>
                                            <p class="text-lg font-bold text-orange-600">${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 text-xs text-gray-600">
                                        ${getText('Minimum order')}: ${selectedProduct.minOrderQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}
                                    </div>
                                </div>
                            </div>
                            <button onclick="removeProductFromRequest('${product.id}')" class="ml-4 text-red-500 hover:text-red-700 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Update create button state
        function updateCreateButtonState() {
            var createBtn = document.getElementById('create-request-btn');
            if (selectedProducts.length > 0) {
                createBtn.disabled = false;
                createBtn.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            } else {
                createBtn.disabled = true;
                createBtn.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            }
        }
        
        // Create request form handling
        function setupCreateRequestForm() {
            var form = document.getElementById('create-request-form');
            form.addEventListener('submit', handleCreateRequest);
        }
        
        function handleCreateRequest(e) {
            e.preventDefault();
            
            if (!isLoggedIn || !currentUser) {
                alert('Please log in to create a group buy request.');
                showLoginModal();
                return;
            }
            
            if (selectedProducts.length === 0) {
                alert('Please add at least one product to your request');
                return;
            }
            
            var notes = document.getElementById('request-notes').value.trim();
            
            // Create items array from selected products
            var items = selectedProducts.map(selectedProduct => {
                var product = productDatabase.find(p => p.id === selectedProduct.productId);
                return {
                    productId: selectedProduct.productId,
                    hostQuantity: selectedProduct.hostQuantity,
                    totalQuantity: product.caseWeight,
                    currentQuantity: selectedProduct.hostQuantity,
                    participants: [
                        { name: currentUser, quantity: selectedProduct.hostQuantity, isHost: true }
                    ],
                    status: "open",
                    minOrderQuantity: selectedProduct.minOrderQuantity
                };
            });
            
            var newRequest = {
                id: groupBuyRequests.length + 1,
                hostName: currentUser,
                items: items,
                notes: notes,
                createdAt: new Date(),
                chatEnabled: true
            };
            
            groupBuyRequests.unshift(newRequest);
            
            // Initialize chat for each product in the new request
            newRequest.items.forEach((item, index) => {
                var product = productDatabase.find(p => p.id === item.productId);
                var productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
                var chatKey = `${newRequest.id}-${index}`;
                
                chatMessages[chatKey] = [{
                    sender: currentUser,
                    message: `Started a new group buy for ${productName}! Looking forward to everyone joining 🎉`,
                    timestamp: new Date()
                }];
            });
            
            // Clear the form
            document.getElementById('create-request-form').reset();
            selectedProducts = [];
            currentSelectedProduct = null;
            renderSelectedProducts();
            updateCreateButtonState();
            cancelAddProduct();
            
            // Show success and redirect
            showNotification(`Group buy request created successfully with ${selectedProducts.length > 0 ? selectedProducts.length : items.length} product${items.length > 1 ? 's' : ''}! 🎉`);
            showSection('browse');
        }
        
        // Search and filter functionality
        function setupSearchAndFilter() {
            var searchInput = document.getElementById('search-requests');
            var filterSelect = document.getElementById('filter-status');
            
            searchInput.addEventListener('input', renderRequests);
            filterSelect.addEventListener('change', renderRequests);
        }
        
        // Chat access control
        function canAccessChat(request) {
            if (!isLoggedIn) return false;
            
            // Check if user is host or participant
            var isHost = request.hostName === currentUser;
            var isParticipant = request.items.some(item => 
                item.participants.some(p => p.name === currentUser && !p.isHost)
            );
            
            if (!isHost && !isParticipant) return false;
            
            // Check if at least one item is completed (fulfilled)
            var hasCompletedItem = request.items.some(item => item.status === 'completed');
            
            return hasCompletedItem;
        }
        
        // Chat functionality
        function setupChatInput() {
            var chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        function sendMessage() {
            var input = document.getElementById('chat-input');
            var message = input.value.trim();
            
            if (!message || !currentChatRequestId) return;
            
            if (!isLoggedIn) {
                alert('Please log in to send messages');
                return;
            }
            
            var newMessage = {
                sender: currentUser,
                message: message,
                timestamp: new Date()
            };
            
            if (!chatMessages[currentChatRequestId]) {
                chatMessages[currentChatRequestId] = [];
            }
            
            chatMessages[currentChatRequestId].push(newMessage);
            
            input.value = '';
            renderChatMessages();
            
            // Scroll to bottom
            var messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function renderChatMessages() {
            var container = document.getElementById('chat-messages');
            var messages = chatMessages[currentChatRequestId] || [];
            
            container.innerHTML = messages.map(message => {
                var isCurrentUser = message.sender === currentUser;
                return `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="chat-bubble ${isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-900'} px-4 py-2 rounded-lg">
                            <div class="font-medium text-sm mb-1">${message.sender}</div>
                            <div>${message.message}</div>
                            <div class="text-xs opacity-75 mt-1">${formatChatTime(message.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatChatTime(timestamp) {
            return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function openChatModal(requestId) {
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Check if user can access chat
            if (!canAccessChat(request)) {
                alert('Chat is only available when the order is fulfilled and you are a participant or host.');
                return;
            }
            
            currentChatRequestId = requestId;
            document.getElementById('chat-modal-title').textContent = `Group Chat - ${request.hostName}`;
            document.getElementById('chat-modal').classList.remove('hidden');
            
            renderChatMessages();
            
            // Scroll to bottom
            setTimeout(() => {
                var messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        function closeChatModal() {
            document.getElementById('chat-modal').classList.add('hidden');
            currentChatRequestId = null;
        }
        
        // Notification functions
        function showNotification(message) {
            // Create a temporary notification element
            var notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function renderNotifications() {
            var container = document.getElementById('notifications-list');
            
            if (userNotifications.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No notifications</div>';
                return;
            }
            
            container.innerHTML = userNotifications.map(notification => {
                var icon = '🔔';
                if (notification.type === 'join') icon = '👋';
                if (notification.type === 'complete') icon = '✅';
                if (notification.type === 'leave') icon = '👋';
                if (notification.type === 'cancelled') icon = '❌';
                
                return `
                    <div class="p-3 border-b hover:bg-gray-50 cursor-pointer ${notification.read ? '' : 'bg-blue-50'}" onclick="markNotificationRead(${notification.id})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${notification.title}</p>
                                <p class="text-sm text-gray-600">${notification.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(notification.timestamp)}</p>
                            </div>
                            ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function markNotificationRead(notificationId) {
            var notification = userNotifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                renderNotifications();
            }
        }
        
        function clearAllNotifications() {
            userNotifications = [];
            renderNotifications();
        }
        
        // Render functions
        function renderRequests() {
            var container = document.getElementById('requests-grid');
            var searchQuery = document.getElementById('search-requests').value.toLowerCase();
            var statusFilter = document.getElementById('filter-status').value;
            
            var filteredRequests = groupBuyRequests.filter(request => {
                // Search filter
                var matchesSearch = !searchQuery || 
                    request.hostName.toLowerCase().includes(searchQuery) ||
                    request.items.some(item => {
                        var product = productDatabase.find(p => p.id === item.productId);
                        return product && (
                            product.englishName.toLowerCase().includes(searchQuery) ||
                            product.chineseName.toLowerCase().includes(searchQuery) ||
                            product.id.toLowerCase().includes(searchQuery)
                        );
                    });
                
                // Status filter
                var matchesStatus = statusFilter === 'all' || 
                    request.items.some(item => {
                        if (statusFilter === 'open') return item.status === 'open';
                        if (statusFilter === 'almost-full') return item.status === 'almost-full';
                        if (statusFilter === 'completed') return item.status === 'completed';
                        return true;
                    });
                
                return matchesSearch && matchesStatus;
            });
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="search" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('No requests found')}</h3>
                        <p class="text-gray-600">${getText('Try adjusting your search or filter criteria')}</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = filteredRequests.map(request => {
                var isHost = isLoggedIn && request.hostName === currentUser;
                var isParticipating = isLoggedIn && request.items.some(item => 
                    item.participants.some(p => p.name === currentUser)
                ) && !isHost;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${request.hostName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${request.hostName}</h3>
                                    <p class="text-sm text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${request.chatEnabled ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '聊天活躍' : 'Chat Active'}</span>` : ''}
                                ${isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : ''}
                                ${isParticipating ? `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '您正在參與' : 'You\'re participating'}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            ${request.items.length > 1 ? `
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-sm text-gray-600">${request.items.length} products in this group buy</span>
                                    <button onclick="toggleProductsView(${request.id})" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center space-x-1">
                                        <span id="toggle-text-${request.id}">Show all products</span>
                                        <i data-lucide="chevron-down" id="toggle-icon-${request.id}" class="w-4 h-4 toggle-icon"></i>
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div id="products-container-${request.id}" class="space-y-4 products-container ${request.items.length > 1 ? 'max-h-48 overflow-hidden' : ''}">
                                ${request.items.map(item => {
                                    var product = productDatabase.find(p => p.id === item.productId);
                                    var progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                                    var remaining = item.totalQuantity - item.currentQuantity;
                                    
                                    var statusColor = 'bg-blue-500';
                                    if (item.status === 'almost-full') statusColor = 'bg-yellow-500';
                                    if (item.status === 'completed') statusColor = 'bg-green-500';
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center space-x-3 mb-3">
                                                <div class="text-2xl">${product.image}</div>
                                                <div class="flex-1">
                                                    <h4 class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                                    <p class="text-sm text-gray-600">${product.id} • ${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'} ${currentLanguage === 'zh' ? '箱' : 'case'}</p>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                                    <span>${item.currentQuantity}/${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                    <span>${remaining} ${currentLanguage === 'zh' ? '磅剩餘' : 'lbs remaining'}</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="progress-bar h-2 rounded-full ${statusColor}" style="width: ${progressPercentage}%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-sm text-gray-600">
                                                <span class="font-medium">${item.participants.length} ${getText('participants')}:</span>
                                                ${item.participants.slice(0, 3).map(p => p.name).join(', ')}
                                                ${item.participants.length > 3 ? ` +${item.participants.length - 3} more` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        ${request.notes ? `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-700">${request.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-2">
                            <button onclick="openRequestModal(${request.id})" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                ${currentLanguage === 'zh' ? '查看詳情' : 'View Details'}
                            </button>
                            ${isHost ? `
                                <button onclick="hostOptOut(${request.id})" class="bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '取消請求' : 'Cancel Request'}
                                </button>
                            ` : isParticipating ? `
                                <button onclick="participantOptOut(${request.id})" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '退出' : 'Opt Out'}
                                </button>
                            ` : ''}
                            ${canAccessChat(request) ? `
                                <button onclick="openChatModal(${request.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '聊天💬' : 'Chat💬'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function renderMyGroups() {
            var container = document.getElementById('my-groups-grid');
            
            if (!isLoggedIn || !currentUser || currentUser === 'Guest User') {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="user" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('Please log in')}</h3>
                        <p class="text-gray-600 mb-4">${getText('You need to be logged in to view your group buys')}</p>
                        <button onclick="showLoginModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                            ${getText('Login')}
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            var userRequests = groupBuyRequests.filter(request => {
                // Show if user is the host
                if (request.hostName === currentUser) {
                    return true;
                }
                
                // Show if user is a participant in any item (but not as host)
                return request.items.some(item => 
                    item.participants.some(p => p.name === currentUser && !p.isHost)
                );
            });
            
            if (userRequests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="shopping-bag" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('No group buys yet')}</h3>
                        <p class="text-gray-600 mb-4">${getText('You haven\'t created or joined any group buys')}</p>
                        <button onclick="showSection('browse')" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                            ${getText('Browse Requests')}
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = userRequests.map(request => {
                var isHost = request.hostName === currentUser;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${request.hostName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${request.hostName}</h3>
                                    <p class="text-sm text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '參與者' : 'Participant'}</span>`}
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-4">
                            ${request.items.map(item => {
                                var product = productDatabase.find(p => p.id === item.productId);
                                var progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                                var remaining = item.totalQuantity - item.currentQuantity;
                                
                                return `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-3 mb-3">
                                            <div class="text-2xl">${product.image}</div>
                                            <div class="flex-1">
                                                <h4 class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                                <p class="text-sm text-gray-600">${product.id} • ${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'} ${currentLanguage === 'zh' ? '箱' : 'case'}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                                <span>${item.currentQuantity}/${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                <span>${remaining} ${currentLanguage === 'zh' ? '磅剩餘' : 'lbs remaining'}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="progress-bar h-2 rounded-full bg-blue-500" style="width: ${progressPercentage}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="openRequestModal(${request.id})" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                ${currentLanguage === 'zh' ? '查看詳情' : 'View Details'}
                            </button>
                            ${isHost ? `
                                <button onclick="hostOptOut(${request.id})" class="bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '取消請求' : 'Cancel Request'}
                                </button>
                            ` : isParticipating ? `
                                <button onclick="participantOptOut(${request.id})" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '退出' : 'Opt Out'}
                                </button>
                            ` : ''}
                            ${canAccessChat(request) ? `
                                <button onclick="openChatModal(${request.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '聊天💬' : 'Chat💬'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function openRequestModal(requestId) {
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            var isHost = isLoggedIn && request.hostName === currentUser;
            var isParticipating = isLoggedIn && request.items.some(item => 
                item.participants.some(p => p.name === currentUser)
            ) && !isHost;
            
            var modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Group Buy by ${request.hostName}</h2>
                            <p class="text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                        </div>
                        <button onclick="closeRequestModal()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        ${request.items.map((item, itemIndex) => {
                            var product = productDatabase.find(p => p.id === item.productId);
                            var progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                            var remaining = item.totalQuantity - item.currentQuantity;
                            var canJoin = remaining >= 5 && !isHost && !isParticipating;
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-6">
                                    <div class="flex items-start space-x-4 mb-4">
                                        <div class="text-4xl">${product.image}</div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h3>
                                            <p class="text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                                            <p class="text-sm text-gray-500">ID: ${product.id} • ${product.packaging}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '總箱重量' : 'Total Case'}</p>
                                            <p class="text-2xl font-bold text-blue-600">${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '已承諾' : 'Committed'}</p>
                                            <p class="text-2xl font-bold text-green-600">${item.currentQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-orange-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '剩餘' : 'Remaining'}</p>
                                            <p class="text-2xl font-bold text-orange-600">${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                                            <span>${currentLanguage === 'zh' ? '進度' : 'Progress'}</span>
                                            <span>${Math.round(progressPercentage)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                            <div class="progress-bar h-3 rounded-full bg-gradient-to-r from-blue-500 to-green-500" style="width: ${progressPercentage}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-gray-900 mb-2">${getText('Participants')} (${item.participants.length})</h4>
                                        <div class="space-y-2">
                                            ${item.participants.map((participant, pIndex) => {
                                                var canAdjust = (isHost && participant.isHost) || (!isHost && participant.name === currentUser && !participant.isHost);
                                                var maxAdjustable = item.totalQuantity - item.currentQuantity + participant.quantity;
                                                var minOrder = item.minOrderQuantity || 5;
                                                
                                                return `
                                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                        <div class="flex items-center space-x-2">
                                                            <div class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                                                ${participant.name.charAt(0)}
                                                            </div>
                                                            <span class="text-sm font-medium">${participant.name}</span>
                                                            ${participant.isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : ''}
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            ${canAdjust ? `
                                                                <div class="flex items-center space-x-1">
                                                                    <input type="number" 
                                                                           id="adjust-qty-${requestId}-${itemIndex}-${pIndex}" 
                                                                           value="${participant.quantity}" 
                                                                           min="${minOrder}" 
                                                                           max="${maxAdjustable}"
                                                                           class="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                                                    <button onclick="adjustQuantity(${requestId}, ${itemIndex}, ${pIndex})" 
                                                                            class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                                                                        ${getText('Update')}
                                                                    </button>
                                                                </div>
                                                            ` : `
                                                                <span class="text-sm text-gray-600">${participant.quantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                            `}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    ${canJoin ? `
                                        <div class="border-t pt-4">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-1">
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">${getText('Your quantity (lbs)')}</label>
                                                    <input type="number" id="join-quantity-${itemIndex}" min="${item.minOrderQuantity || 5}" max="${remaining}" placeholder="${getText('Min')} ${item.minOrderQuantity || 5} ${currentLanguage === 'zh' ? '磅' : 'lbs'}" 
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                                    <p class="text-xs text-gray-500 mt-1">${getText('Min')}: ${item.minOrderQuantity || 5} ${currentLanguage === 'zh' ? '磅' : 'lbs'} • ${getText('Available')}: ${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                                </div>
                                                <button onclick="joinRequest(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                    ${getText('Join')}
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${isParticipating && !isHost ? `
                                        <div class="border-t pt-4 flex space-x-3">
                                            <button onclick="optOutRequest(${request.id}, ${itemIndex})" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                                Opt Out
                                            </button>
                                            ${item.status === 'completed' ? `
                                                <button onclick="openProductChat(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                    Chat💬
                                                </button>
                                            ` : ''}
                                        </div>
                                    ` : isHost && item.status === 'completed' ? `
                                        <div class="border-t pt-4">
                                            <button onclick="openProductChat(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                Chat💬
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        ${request.notes ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-900 mb-2">${currentLanguage === 'zh' ? '附加說明' : 'Additional Notes'}</h4>
                                <p class="text-gray-700">${request.notes}</p>
                            </div>
                        ` : ''}
                        

                    </div>
                </div>
            `;
            
            document.getElementById('request-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeRequestModal() {
            document.getElementById('request-modal').classList.add('hidden');
        }
        
        function joinRequest(requestId, itemIndex) {
            if (!isLoggedIn) {
                alert('Please log in to join a group buy');
                showLoginModal();
                return;
            }
            
            var quantityInput = document.getElementById(`join-quantity-${itemIndex}`);
            var quantity = parseInt(quantityInput.value);
            
            if (!quantity || quantity < 5) {
                alert('Please enter a valid quantity (minimum 5 lbs)');
                return;
            }
            
            var request = groupBuyRequests.find(r => r.id === requestId);
            var item = request.items[itemIndex];
            var remaining = item.totalQuantity - item.currentQuantity;
            var minOrder = item.minOrderQuantity || 5;
            
            if (quantity < minOrder) {
                alert(currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`);
                return;
            }
            
            if (quantity > remaining) {
                alert(`Only ${remaining} lbs remaining`);
                return;
            }
            
            // Add participant
            item.participants.push({
                name: currentUser,
                quantity: quantity,
                isHost: false
            });
            
            item.currentQuantity += quantity;
            
            // Update status and check if completed
            var newRemaining = item.totalQuantity - item.currentQuantity;
            if (newRemaining === 0) {
                item.status = 'completed';
                // Notify host about completion
                var product = productDatabase.find(p => p.id === item.productId);
                addNotification(request.hostName, 'Order Fulfilled', `Your ${currentLanguage === 'zh' ? product.chineseName : product.englishName} group buy is now complete!`, 'complete');
            } else if (newRemaining <= 5) {
                item.status = 'almost-full';
            }
            
            // Notify host about new participant
            addNotification(request.hostName, 'New Participant', `${currentUser} joined your group buy!`, 'join');
            
            closeRequestModal();
            renderRequests();
            renderMyGroups();
            
            var product = productDatabase.find(p => p.id === item.productId);
            showNotification(`Successfully joined ${currentLanguage === 'zh' ? product.chineseName : product.englishName} group buy! 🎉`);
        }
        
        function optOutRequest(requestId, itemIndex) {
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            var item = request.items[itemIndex];
            var product = productDatabase.find(p => p.id === item.productId);
            var productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            
            if (!confirm(`Are you sure you want to opt out of ${productName}? This will make your quantity available for others to join.`)) {
                return;
            }
            
            // Find and remove participant from this specific product
            var participantIndex = item.participants.findIndex(p => p.name === currentUser && !p.isHost);
            if (participantIndex !== -1) {
                var participant = item.participants[participantIndex];
                var releasedQuantity = participant.quantity;
                
                item.currentQuantity -= participant.quantity;
                item.participants.splice(participantIndex, 1);
                
                // Update status - make quantities available to others
                var remaining = item.totalQuantity - item.currentQuantity;
                if (remaining === 0) {
                    item.status = 'completed';
                } else if (remaining <= 5) {
                    item.status = 'almost-full';
                } else {
                    item.status = 'open';
                }
                
                // Notify host about participant leaving this specific product
                addNotification(request.hostName, 'Participant Left Product', `${currentUser} has opted out of ${productName}. ${releasedQuantity} lbs is now available for others to join.`, 'leave');
                
                closeRequestModal();
                
                // Force refresh all views
                setTimeout(() => {
                    renderRequests();
                    renderMyGroups();
                }, 100);
                
                showNotification(`Successfully opted out of ${productName}. Your ${releasedQuantity} lbs is now available for others to join.`);
            }
        }
        
        // Open product-specific chat
        function openProductChat(requestId, itemIndex) {
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            var item = request.items[itemIndex];
            var product = productDatabase.find(p => p.id === item.productId);
            
            // Check if user is participant in this specific product
            var isParticipant = item.participants.some(p => p.name === currentUser);
            if (!isParticipant) {
                alert('You can only access chat for products you are participating in.');
                return;
            }
            
            // Check if product is completed
            if (item.status !== 'completed') {
                alert('Product chat is only available when the order is fulfilled.');
                return;
            }
            
            var chatKey = `${requestId}-${itemIndex}`;
            currentChatRequestId = chatKey;
            
            var productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            document.getElementById('chat-modal-title').textContent = `${productName} Chat - ${request.hostName}`;
            document.getElementById('chat-modal').classList.remove('hidden');
            
            // Initialize chat if it doesn't exist
            if (!chatMessages[chatKey]) {
                chatMessages[chatKey] = [{
                    sender: 'System',
                    message: `Welcome to the ${productName} group chat! The order has been fulfilled and is ready for coordination.`,
                    timestamp: new Date()
                }];
            }
            
            renderChatMessages();
            
            // Scroll to bottom
            setTimeout(() => {
                var messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Host opt-out function - cancels entire request
        function hostOptOut(requestId) {
            if (!confirm('Are you sure you want to cancel this entire group buy request? This will void the order for all participants.')) {
                return;
            }
            
            var requestIndex = groupBuyRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) return;
            
            var request = groupBuyRequests[requestIndex];
            
            // Add notification for all participants (except host)
            request.items.forEach(item => {
                item.participants.forEach(participant => {
                    if (participant.name !== currentUser) {
                        addNotification(participant.name, 'Group Buy Cancelled', `The group buy hosted by ${currentUser} has been cancelled.`, 'cancelled');
                    }
                });
            });
            
            // Remove the request completely from the array
            groupBuyRequests.splice(requestIndex, 1);
            
            // Remove chat messages for all products in this request
            request.items.forEach((item, index) => {
                var chatKey = `${requestId}-${index}`;
                delete chatMessages[chatKey];
            });
            delete chatMessages[requestId];
            
            // Close modal if open
            closeRequestModal();
            
            // Immediately refresh all views to show the request is gone
            renderRequests();
            renderMyGroups();
            
            showNotification('Group buy request cancelled and removed successfully. All participants have been notified.');
        }
        
        // Participant opt-out function - removes from specific products
        function participantOptOut(requestId) {
            if (!confirm('Are you sure you want to opt out of this group buy?')) {
                return;
            }
            
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            var optedOutProducts = [];
            var totalReleasedQuantity = 0;
            
            // Remove participant from all items in the request
            request.items.forEach(item => {
                var participantIndex = item.participants.findIndex(p => p.name === currentUser && !p.isHost);
                if (participantIndex !== -1) {
                    var participant = item.participants[participantIndex];
                    totalReleasedQuantity += participant.quantity;
                    item.currentQuantity -= participant.quantity;
                    item.participants.splice(participantIndex, 1);
                    
                    // Update status - make quantities available to others
                    var remaining = item.totalQuantity - item.currentQuantity;
                    if (remaining === 0) {
                        item.status = 'completed';
                    } else if (remaining <= 5) {
                        item.status = 'almost-full';
                    } else {
                        item.status = 'open';
                    }
                    
                    var product = productDatabase.find(p => p.id === item.productId);
                    optedOutProducts.push(`${currentLanguage === 'zh' ? product.chineseName : product.englishName} (${participant.quantity} lbs)`);
                }
            });
            
            // Notify host about participant leaving
            if (optedOutProducts.length > 0) {
                addNotification(request.hostName, 'Participant Left', `${currentUser} has opted out of your group buy. ${optedOutProducts.join(', ')} quantities are now available for others to join.`, 'leave');
            }
            
            // Close modal if open
            closeRequestModal();
            
            // Immediately refresh all views to reflect the changes
            renderRequests();
            renderMyGroups();
            
            if (optedOutProducts.length > 0) {
                showNotification(`Successfully opted out of: ${optedOutProducts.join(', ')}. These quantities are now available for others to join.`);
            }
        }
        
        // Adjust participant quantity
        function adjustQuantity(requestId, itemIndex, participantIndex) {
            var request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            var item = request.items[itemIndex];
            var participant = item.participants[participantIndex];
            var product = productDatabase.find(p => p.id === item.productId);
            
            var newQuantityInput = document.getElementById(`adjust-qty-${requestId}-${itemIndex}-${participantIndex}`);
            var newQuantity = parseInt(newQuantityInput.value);
            var oldQuantity = participant.quantity;
            var minOrder = item.minOrderQuantity || 5;
            
            if (!newQuantity || newQuantity < minOrder) {
                alert(currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`);
                newQuantityInput.value = oldQuantity;
                return;
            }
            
            // Calculate available space
            var currentWithoutThis = item.currentQuantity - oldQuantity;
            var maxPossible = item.totalQuantity - currentWithoutThis;
            
            if (newQuantity > maxPossible) {
                alert(`Maximum available quantity is ${maxPossible} lbs`);
                newQuantityInput.value = oldQuantity;
                return;
            }
            
            // Update quantities
            var quantityDiff = newQuantity - oldQuantity;
            participant.quantity = newQuantity;
            item.currentQuantity += quantityDiff;
            
            // Update status
            var remaining = item.totalQuantity - item.currentQuantity;
            if (remaining === 0) {
                item.status = 'completed';
            } else if (remaining <= 5) {
                item.status = 'almost-full';
            } else {
                item.status = 'open';
            }
            
            // Notify others about quantity change
            var productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            var changeType = quantityDiff > 0 ? 'increased' : 'decreased';
            var absChange = Math.abs(quantityDiff);
            
            // Notify host if participant adjusted
            if (!participant.isHost) {
                addNotification(request.hostName, 'Quantity Adjusted', `${participant.name} ${changeType} their ${productName} order by ${absChange} lbs.`, 'quantity');
            }
            
            // Force refresh all views
            setTimeout(() => {
                renderRequests();
                renderMyGroups();
                openRequestModal(requestId); // Refresh the modal with updated data
            }, 100);
            
            showNotification(`Quantity updated! ${changeType === 'increased' ? 'Added' : 'Removed'} ${absChange} lbs ${changeType === 'increased' ? 'to' : 'from'} your ${productName} order.`);
        }
        
        // Add notification function
        function addNotification(userName, title, message, type) {
            var targetUser = userAccounts.find(u => u.name === userName);
            if (!targetUser || !targetUser.notificationPreferences) return;
            
            // Check if user wants this type of notification
            var shouldNotify = false;
            switch(type) {
                case 'join':
                    shouldNotify = targetUser.notificationPreferences.newParticipants;
                    break;
                case 'complete':
                    shouldNotify = targetUser.notificationPreferences.orderFulfilled;
                    break;
                case 'quantity':
                    shouldNotify = targetUser.notificationPreferences.quantityChanges;
                    break;
                case 'leave':
                case 'cancelled':
                    shouldNotify = targetUser.notificationPreferences.cancellations;
                    break;
                default:
                    shouldNotify = true;
            }
            
            if (!shouldNotify) return;
            
            // Only show browser notifications if user is currently logged in and has browser notifications enabled
            if (userName === currentUser && targetUser.notificationPreferences.browserNotifications) {
                userNotifications.unshift({
                    id: Date.now(),
                    title: title,
                    message: message,
                    type: type,
                    timestamp: new Date(),
                    read: false
                });
                
                updateNotificationBadge();
            }
            
            // Simulate email notification (would integrate with email service in real app)
            if (targetUser.notificationPreferences.emailNotifications) {
                console.log(`📧 Email sent to ${targetUser.email}: ${title} - ${message}`);
                if (userName === currentUser) {
                    showNotification(`📧 Email notification sent to ${targetUser.email}`);
                }
            }
            
            // Simulate SMS notification (would integrate with SMS service in real app)
            if (targetUser.notificationPreferences.smsNotifications) {
                console.log(`📱 SMS sent to ${targetUser.phone}: ${title} - ${message}`);
                if (userName === currentUser) {
                    showNotification(`📱 SMS notification sent to ${targetUser.phone}`);
                }
            }
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            var badge = document.getElementById('notification-badge');
            var unreadCount = userNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Utility functions
        function formatTimeAgo(date) {
            var now = new Date();
            var diff = now - date;
            var minutes = Math.floor(diff / 60000);
            var hours = Math.floor(diff / 3600000);
            var days = Math.floor(diff / 86400000);
            
            if (currentLanguage === 'zh') {
                if (minutes < 1) return '剛剛';
                if (minutes < 60) return `${minutes}分鐘前`;
                if (hours < 24) return `${hours}小時前`;
                return `${days}天前`;
            } else {
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }
        }
        
        // Toggle products view function
        function toggleProductsView(requestId) {
            var container = document.getElementById(`products-container-${requestId}`);
            var toggleText = document.getElementById(`toggle-text-${requestId}`);
            var toggleIcon = document.getElementById(`toggle-icon-${requestId}`);
            
            if (container.classList.contains('max-h-48')) {
                // Expand view
                container.classList.remove('max-h-48', 'overflow-hidden');
                container.classList.add('max-h-none');
                toggleText.textContent = 'Show less';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Collapse view
                container.classList.remove('max-h-none');
                container.classList.add('max-h-48', 'overflow-hidden');
                toggleText.textContent = 'Show all products';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            var userMenu = document.getElementById('user-menu');
            var userMenuButton = document.querySelector('button[onclick="toggleUserMenu()"]');
            var notificationsDropdown = document.getElementById('notifications-dropdown');
            var notificationsButton = document.querySelector('button[onclick="toggleNotifications()"]');
            
            if (userMenuButton && !userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
            
            if (notificationsButton && !notificationsButton.contains(e.target) && !notificationsDropdown.contains(e.target)) {
                notificationsDropdown.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98dc100c87a7465c',t:'MTc2MDMyOTQxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
<!-- ORDER MATTERS: Supabase CDN -> supabase-init (creates global `supabase`) -> original scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script defer="" src="supabase-init-safe.js"></script>
<script src="https://cdn.tailwindcss.com">
async function setQuantityItem(requestItemId, minOrder, remaining){
  if(!currentUser){ alert("Please log in"); return; }
  const input = document.querySelector("#join-qty-"+requestItemId);
  const qty = parseInt(input.value||"0",10);
  if(isNaN(qty) || qty<0){ alert("Invalid quantity"); return; }
  if(qty>remaining){ if(!confirm("Quantity exceeds remaining. Continue?")) return; }
  try{
    const { data, error } = await supabase.rpc("set_quantity_request_item", { p_request_item_id: requestItemId, p_quantity: qty });
    if(error) throw error;
    await renderRequests(); // refresh cards
    // also refresh the open modal
    const open = !document.querySelector("#request-modal").classList.contains("hidden");
    if(open){ const idText = document.querySelector("#modal-content")?.querySelector("h3")?.textContent || ""; }
  }catch(ex){ alert(ex.message); }
}

async function optOutItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Opt out of this product? Your quantity will be set to 0.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("You have opted out of this product.");
  }catch(ex){ alert(ex.message); }
}

async function cancelItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel this product for everyone? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("Product cancelled.");
  }catch(ex){ alert(ex.message); }
}


async function cancelWholeRequest(requestId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel the entire request and delete all products? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("cancel_request", { p_request_id: requestId });
    if(error) throw error;
    document.querySelector("#request-modal").classList.add("hidden");
    await renderRequests();
    alert("Request cancelled.");
  }catch(ex){ alert(ex.message); }
}

</script><script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js">
async function setQuantityItem(requestItemId, minOrder, remaining){
  if(!currentUser){ alert("Please log in"); return; }
  const input = document.querySelector("#join-qty-"+requestItemId);
  const qty = parseInt(input.value||"0",10);
  if(isNaN(qty) || qty<0){ alert("Invalid quantity"); return; }
  if(qty>remaining){ if(!confirm("Quantity exceeds remaining. Continue?")) return; }
  try{
    const { data, error } = await supabase.rpc("set_quantity_request_item", { p_request_item_id: requestItemId, p_quantity: qty });
    if(error) throw error;
    await renderRequests(); // refresh cards
    // also refresh the open modal
    const open = !document.querySelector("#request-modal").classList.contains("hidden");
    if(open){ const idText = document.querySelector("#modal-content")?.querySelector("h3")?.textContent || ""; }
  }catch(ex){ alert(ex.message); }
}

async function optOutItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Opt out of this product? Your quantity will be set to 0.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("You have opted out of this product.");
  }catch(ex){ alert(ex.message); }
}

async function cancelItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel this product for everyone? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("Product cancelled.");
  }catch(ex){ alert(ex.message); }
}


async function cancelWholeRequest(requestId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel the entire request and delete all products? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("cancel_request", { p_request_id: requestId });
    if(error) throw error;
    document.querySelector("#request-modal").classList.add("hidden");
    await renderRequests();
    alert("Request cancelled.");
  }catch(ex){ alert(ex.message); }
}

</script><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
async function setQuantityItem(requestItemId, minOrder, remaining){
  if(!currentUser){ alert("Please log in"); return; }
  const input = document.querySelector("#join-qty-"+requestItemId);
  const qty = parseInt(input.value||"0",10);
  if(isNaN(qty) || qty<0){ alert("Invalid quantity"); return; }
  if(qty>remaining){ if(!confirm("Quantity exceeds remaining. Continue?")) return; }
  try{
    const { data, error } = await supabase.rpc("set_quantity_request_item", { p_request_item_id: requestItemId, p_quantity: qty });
    if(error) throw error;
    await renderRequests(); // refresh cards
    // also refresh the open modal
    const open = !document.querySelector("#request-modal").classList.contains("hidden");
    if(open){ const idText = document.querySelector("#modal-content")?.querySelector("h3")?.textContent || ""; }
  }catch(ex){ alert(ex.message); }
}

async function optOutItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Opt out of this product? Your quantity will be set to 0.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("You have opted out of this product.");
  }catch(ex){ alert(ex.message); }
}

async function cancelItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel this product for everyone? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("Product cancelled.");
  }catch(ex){ alert(ex.message); }
}


async function cancelWholeRequest(requestId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel the entire request and delete all products? This cannot be undone.")) return;
  try{
    const { data, error } = await supabase.rpc("cancel_request", { p_request_id: requestId });
    if(error) throw error;
    document.querySelector("#request-modal").classList.add("hidden");
    await renderRequests();
    alert("Request cancelled.");
  }catch(ex){ alert(ex.message); }
}

</script>
<script>
    var SUPABASE_URL = "https://bwlqwrlsibmqttndymzu.supabase.co";
    var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3bHF3cmxzaWJtcXR0bmR5bXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDA0MzcsImV4cCI6MjA3NjA3NjQzN30.QQ8Lncmyl_VfP4a_hc9JP-W9YdlcRl21-8N4LTi2WDM";
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, storageKey:"savego-auth" } });
    lucide.createIcons();

    var currentUser = null;
    function toggleUserMenu(){ document.querySelector("#user-menu").classList.toggle("hidden"); }
    function showSection(name){ document.querySelectorAll(".section").forEach(s=>s.classList.add("hidden")); document.querySelector("#"+name+"-section").classList.remove("hidden"); if(name==="browse") renderRequests(); if(name==="my-groups") renderMyGroups(); }

    async function loadSession(){
      var { data:{ user } } = await supabase.auth.getUser();
      currentUser = user || null;
      var avatar=document.querySelector("#user-avatar"), name=document.querySelector("#user-name-display");
      var logged=document.querySelector("#logged-in-menu"), guest=document.querySelector("#guest-menu");
      if(currentUser){ avatar.textContent=(currentUser.email||"U").charAt(0).toUpperCase(); name.textContent=currentUser.email||"User"; name.classList.remove("hidden"); logged.classList.remove("hidden"); guest.classList.add("hidden"); await ensureProfile(currentUser); loadProfile(); }
      else{ avatar.textContent="G"; name.textContent="Guest"; name.classList.add("hidden"); logged.classList.add("hidden"); guest.classList.remove("hidden"); }
    }
    async function ensureProfile(user){ var { data } = await supabase.from("profiles").select("id").eq("id", user.id).maybeSingle(); if(!data){ await supabase.from("profiles").insert({ id:user.id, email:user.email, full_name:user.email?.split("@")[0]||"User" }); } }
    async function loadProfile(){ if(!currentUser) return; var { data:p } = await supabase.from("profiles").select("*").eq("id", currentUser.id).maybeSingle(); if(!p) return; document.querySelector("#menu-user-name").textContent=p.full_name||currentUser.email?.split("@")[0]||"User"; document.querySelector("#menu-user-email").textContent=p.email||currentUser.email||""; document.querySelector("#profile-name").textContent=p.full_name||currentUser.email?.split("@")[0]||"User"; document.querySelector("#profile-email").textContent=p.email||currentUser.email||""; document.querySelector("#profile-avatar").textContent=(p.full_name||"U").charAt(0).toUpperCase(); document.querySelector("#profile-full-name").value=p.full_name||""; document.querySelector("#profile-email-input").value=p.email||currentUser.email||""; document.querySelector("#profile-phone").value=p.phone||""; }
    async function logout(){ await supabase.auth.signOut(); currentUser=null; loadSession(); showSection("browse"); }

    // Auth
    function showLoginModal(){ document.querySelector("#login-modal").classList.remove("hidden"); }
    function closeLoginModal(){ document.querySelector("#login-modal").classList.add("hidden"); }
    function showSignupModal(){ document.querySelector("#signup-modal").classList.remove("hidden"); }
    function closeSignupModal(){ document.querySelector("#signup-modal").classList.add("hidden"); }
    document.querySelector("#login-form").addEventListener("submit", async (e)=>{ e.preventDefault(); var email=document.querySelector("#login-identifier").value.trim(); var password=document.querySelector("#login-password").value; var { error }=await supabase.auth.signInWithPassword({ email, password }); if(error){ alert(error.message); return; } closeLoginModal(); await loadSession(); renderRequests(); });
    document.querySelector("#signup-form").addEventListener("submit", async (e)=>{ e.preventDefault(); var full_name=document.querySelector("#signup-name").value.trim(); var email=document.querySelector("#signup-email").value.trim(); var phone=document.querySelector("#signup-phone").value.trim(); var password=document.querySelector("#signup-password").value; if(password.length<8){ alert("Password must be at least 8 characters"); return; } var { data, error }=await supabase.auth.signUp({ email, password }); if(error){ alert(error.message); return; } if(data.user){ await supabase.from("profiles").upsert({ id:data.user.id, email, full_name, phone }); } closeSignupModal(); await loadSession(); });

    // Product search
    var productSeed=[
      { id:"P001", english_name:"Premium Organic Apples", chinese_name:"优质有机苹果", case_weight:40, packaging:"Cardboard box, 40 individual apples", image:"🍎", category:"Fruits" },
      { id:"P002", english_name:"Fresh Atlantic Salmon", chinese_name:"新鲜大西洋三文鱼", case_weight:25, packaging:"Vacuum sealed, ice packed", image:"🐟", category:"Seafood" },
      { id:"P003", english_name:"Organic Baby Spinach", chinese_name:"有机嫩菠菜", case_weight:15, packaging:"Plastic containers, pre-washed", image:"🥬", category:"Vegetables" },
      { id:"P004", english_name:"Premium Wagyu Beef", chinese_name:"优质和牛肉", case_weight:30, packaging:"Vacuum sealed portions", image:"🥩", category:"Meat" },
      { id:"P005", english_name:"Imported Italian Pasta", chinese_name:"进口意大利面条", case_weight:20, packaging:"Individual 1lb packages", image:"🍝", category:"Pantry" },
      { id:"P006", english_name:"Organic Blueberries", chinese_name:"有机蓝莓", case_weight:12, packaging:"Plastic pint containers", image:"🫐", category:"Fruits" }
    ];
    var selectedProducts = []; var currentSelectedProduct=null;
    function attachCreateFormHandlers(){
      var input = document.querySelector("#product-search"); var results=document.querySelector("#search-results");
      input.addEventListener("input", async function(){
        var q=this.value.trim().toLowerCase(); if(!q){ results.classList.add("hidden"); results.innerHTML=""; return; }
        var local=productSeed.filter(p => (p.english_name+p.chinese_name+p.id).toLowerCase().includes(q));
        var { data: db } = await supabase.from("products").select("*").or(`english_name.ilike.%${q}%,chinese_name.ilike.%${q}%,id.ilike.%${q}%`).limit(10);
        var all=[...local, ...(db||[])];
        if(!all.length){ results.innerHTML='<div class="p-3 text-gray-500 text-center">No products found</div>'; results.classList.remove("hidden"); return; }
        results.innerHTML = all.map(p=>`
          <button type="button" data-pid="${p.id}" class="w-full text-left p-3 hover:bg-gray-50 border-b last:border-b-0">
            <div class="flex items-center gap-3">
              <div class="text-2xl">${p.image||"📦"}</div>
              <div><div class="font-medium">${p.english_name}</div><div class="text-xs text-gray-500">ID: ${p.id} • ${p.case_weight||"?"} lbs</div></div>
            </div>
          </button>`).join("");
        results.classList.remove("hidden");
        results.querySelectorAll("[data-pid]").forEach(btn => btn.onclick = ()=> selectProduct(all.find(p=>p.id===btn.dataset.pid)));
      });
      document.addEventListener("click",(e)=>{ if(!input.contains(e.target) && !results.contains(e.target)) results.classList.add("hidden"); });
      document.querySelector("#add-product-btn").onclick = addProductToList;
      document.querySelector("#cancel-product-btn").onclick = ()=>{ document.querySelector("#add-product-form").classList.add("hidden"); document.querySelector("#selected-product-preview").innerHTML=""; };
      document.querySelector("#create-request-form").addEventListener("submit", submitCreate);
    }
    function selectProduct(p){
      currentSelectedProduct=p;
      var prev=document.querySelector("#selected-product-preview");
      prev.innerHTML = `<div class="flex items-start gap-4"><div class="text-4xl">${p.image||"📦"}</div>
        <div><div class="font-semibold">${p.english_name}</div><div class="text-sm text-gray-600">ID: ${p.id}</div>
        <div class="mt-2 grid grid-cols-2 gap-3"><div class="bg-white p-3 rounded border"><div class="text-sm text-gray-600">Total Case</div><div class="text-xl font-bold">${p.case_weight||"?"} lbs</div></div><div class="bg-white p-3 rounded border"><div class="text-sm text-gray-600">Packaging</div><div class="text-sm">${p.packaging||"-"}</div></div></div></div></div>`;
      document.querySelector("#add-product-form").classList.remove("hidden");
      document.querySelector("#host-quantity").value=""; document.querySelector("#min-order-quantity").value="5";
    }
    function addProductToList(){
      var meta=currentSelectedProduct; if(!meta) return;
      var qty=parseInt(document.querySelector("#host-quantity").value||"0",10);
      var min=parseInt(document.querySelector("#min-order-quantity").value||"5",10);
      if(!qty || qty<min){ alert(`Enter a valid qty (min ${min})`); return; }
      if(meta.case_weight && qty>meta.case_weight){ alert(`Qty cannot exceed ${meta.case_weight} lbs`); return; }
      supabase.from("products").upsert({ id:meta.id, english_name:meta.english_name, chinese_name:meta.chinese_name||null, case_weight:meta.case_weight||null, packaging:meta.packaging||null, category:meta.category||null, image:meta.image||"📦" }, { onConflict:"id" });
      selectedProducts.push({ productId: meta.id, name: meta.english_name, image: meta.image||"📦", caseWeight: meta.case_weight||null, hostQuantity: qty, minOrderQuantity: min });
      renderSelectedProducts();
      document.querySelector("#add-product-form").classList.add("hidden"); document.querySelector("#selected-product-preview").innerHTML="";
      document.querySelector("#create-request-btn").disabled = selectedProducts.length===0;
    }
    function renderSelectedProducts(){
      var wrap=document.querySelector("#selected-products-list");
      wrap.innerHTML = selectedProducts.map((sp,i)=>`
        <div class="bg-white border rounded-lg p-4 flex items-center justify-between">
          <div class="flex items-center gap-3"><div class="text-2xl">${sp.image}</div><div><div class="font-medium">${sp.name} • ${sp.productId}</div><div class="text-xs text-gray-600">Host qty: ${sp.hostQuantity} lbs • Min: ${sp.minOrderQuantity} lbs</div></div></div>
          <button type="button" class="px-3 py-1 text-sm border rounded-lg" data-remove="${i}">Remove</button>
        </div>`).join("");
      document.querySelectorAll("[data-remove]").forEach(b => b.onclick = ()=>{ selectedProducts.splice(parseInt(b.dataset.remove,10),1); renderSelectedProducts(); document.querySelector("#create-request-btn").disabled = selectedProducts.length===0; });
    }
    async function submitCreate(e){
      e.preventDefault();
      if(!currentUser){ alert("Please log in"); return; }
      if(!selectedProducts.length){ alert("Add at least one product"); return; }
      var notes=document.querySelector("#request-notes").value||"";
      var { data:req, error:e1 } = await supabase.from("group_requests").insert({ host_id: currentUser.id, notes }).select("id").single();
      if(e1){ alert(e1.message); return; }
      for(var sp of selectedProducts){
        var total = sp.caseWeight || (sp.hostQuantity*2);
        var { data:item, error:e2 } = await supabase.from("request_items").insert({ request_id:req.id, product_id:sp.productId, total_quantity:total, current_quantity:0, min_order_quantity:sp.minOrder_quantity||sp.minOrderQuantity||5, status:"open" }).select("id").single();
        if(e2){ console.error(e2); continue; }
        await supabase.from("participants").insert({ request_item_id:item.id, user_id:currentUser.id, quantity:sp.hostQuantity, is_host:true });
        await supabase.rpc("add_quantity", { p_request_item_id:item.id, p_add_qty:sp.hostQuantity });
      }
      selectedProducts=[]; renderSelectedProducts(); document.querySelector("#request-notes").value=""; document.querySelector("#create-request-btn").disabled=true;
      showSection("browse");
    }

    // Browse (combined)
    async function renderRequests(){
      var grid=document.querySelector("#requests-grid");
      grid.innerHTML = "<div class='col-span-full text-center text-gray-500'>Loading...</div>";
      var term=(document.querySelector("#search-requests").value||"").toLowerCase(); var status=document.querySelector("#filter-status").value;
      try{
        var { data, error } = await supabase.rpc("browse_requests_combined");
        if(error) throw error;
        var rows=(data||[]).filter(r => {
          var text = (r.host_email||"") + JSON.stringify(r.items||[]);
          return text.toLowerCase().includes(term) && (status==="all" ? true : r.status===status);
        });
        if(!rows.length){ grid.innerHTML = "<div class='col-span-full text-center text-gray-500'>No requests found.</div>"; return; }
        grid.innerHTML = rows.map(r => {
          var remaining = r.total_quantity - r.current_quantity;
          var pct = Math.round((r.current_quantity / r.total_quantity)*100);
          var items = r.items || [];
          var firstImage = items[0]?.image || "📦";
          return `<div class="bg-white rounded-xl border p-5 shadow-sm card-hover">
            <div class="flex items-start gap-3 mb-3">
              <div class="text-3xl">${firstImage}</div>
              <div class="flex-1">
                <div class="font-semibold">${items.map(it=>it.english_name).join(', ')}</div>
                <div class="text-xs text-gray-500">Host: ${r.host_full_name||"Host"}</div>
              </div>
            </div>
            <div class="grid grid-cols-3 gap-3 text-sm mb-3">
              <div class="bg-blue-50 p-3 rounded"><div class="text-gray-600">Total</div><div class="text-xl font-bold text-blue-700">${r.total_quantity} lbs</div></div>
              <div class="bg-green-50 p-3 rounded"><div class="text-gray-600">Committed</div><div class="text-xl font-bold text-green-700">${r.current_quantity} lbs</div></div>
              <div class="bg-orange-50 p-3 rounded"><div class="text-gray-600">Remaining</div><div class="text-xl font-bold text-orange-700">${remaining} lbs</div></div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-3"><div class="progress-bar h-2 rounded-full" style="width:${pct}%"></div></div>
            <div class="text-xs text-gray-600 mb-3">${items.length} product(s)</div>
            <div class="flex gap-2">
              <button type="button" onclick="openDetail(${r.request_id})" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">View / Join</button>

            </div>
          </div>`;
        }).join("");
      }catch(ex){
        grid.innerHTML = `<div class="col-span-full bg-red-50 border border-red-200 text-red-700 p-3 rounded">❌ Failed to load. Install SQL patch (combined RPC) first. Error: ${ex.message}</div>`;
      }
    }
    document.querySelector("#search-requests").addEventListener("input", renderRequests);
    document.querySelector("#filter-status").addEventListener("change", renderRequests);

    // Detail (combined)
    async function openDetail(requestId){
      var { data: rows, error } = await supabase.rpc("request_detail_combined", { p_request_id: requestId });
      if(error || !rows?.length){ alert(error?.message||"Failed"); return; }
      var r = rows[0]; var items = r.items || [];
      var modal=document.querySelector("#request-modal"), body=document.querySelector("#modal-content");
      var header = `<div class="p-5 border-b flex items-center justify-between">
          <div><h3 class="text-xl font-semibold">Group Request #${r.request_id}</h3><p class="text-sm text-gray-600">Host: ${r.host_full_name||"Host"} • Created: ${new Date(r.created_at).toLocaleString()}</p></div>
          <div class="flex items-center gap-2">
            ${r.i_am_host ? `<button type='button' onclick='cancelWholeRequest(${r.request_id})' class='px-3 py-2 border rounded-lg text-red-600'>Cancel Entire Request</button>` : ''}
            <button type="button" onclick="document.querySelector('#request-modal').classList.add('hidden')" class="text-gray-600"><i data-lucide='x' class="w-6 h-6"></i></button>
          </div>
        </div>`;
      var list = items.map(it => {
        var remaining = (it.total_quantity||0) - (it.current_quantity||0);
        var pct = it.total_quantity ? Math.round((it.current_quantity/it.total_quantity)*100) : 0;
        var plist = (it.participants||[]).map(p=>`
          <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
            <div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xs">${(p.full_name||"U").charAt(0).toUpperCase()}</div><div class="text-sm">${p.full_name||"User"} ${p.is_host?'<span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 ml-1">Host</span>':""}</div></div>
            <div class="text-sm">${p.quantity} lbs</div>
          </div>`).join("");
        var iAmHost = !!(it.participants||[]).find(x=>x.user_id === (currentUser&&currentUser.id) && x.is_host);
        var canAdjust = !(it.status==='cancelled' || it.status==='completed' || it.status==='fulfilled' || it.status==='fullfilled');
        return `<div class="p-5 border-b last:border-b-0">
          
          <div class="flex items-start gap-3 mb-2"><div class="text-2xl">${it.image||"📦"}</div><div class="flex-1"><div class="font-semibold">${it.english_name} • ${it.product_id}</div><div class="text-xs text-gray-500">Min: ${it.min_order_quantity} lbs</div></div></div>
          <div class="grid grid-cols-3 gap-3 text-sm mb-2">
            <div class="bg-blue-50 p-3 rounded"><div class="text-gray-600">Total</div><div class="text-xl font-bold text-blue-700">${it.total_quantity} lbs</div></div>
            <div class="bg-green-50 p-3 rounded"><div class="text-gray-600">Committed</div><div class="text-xl font-bold text-green-700">${it.current_quantity} lbs</div></div>
            <div class="bg-orange-50 p-3 rounded"><div class="text-gray-600">Remaining</div><div class="text-xl font-bold text-orange-700">${remaining} lbs</div></div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mb-3"><div class="progress-bar h-2 rounded-full" style="width:${pct}%"></div></div>
          <h4 class="font-semibold mb-2">Participants (${(it.participants||[]).length})</h4>
          <div class="space-y-2">${plist || '<div class="text-sm text-gray-500">No participants yet</div>'}</div>
          <div class="border-t pt-3 mt-3">
            <label class="block text-sm font-medium mb-1">Adjust Your Quantity (lbs)</label>
            <input id="join-qty-${it.request_item_id}" type="number" min="${it.min_order_quantity}" max="${remaining}" class="w-full px-3 py-2 border rounded-lg" placeholder="Min ${it.min_order_quantity} lbs" ${!canAdjust?'disabled':''}>
            <div class="mt-3 flex gap-2 flex-wrap">
              <button type="button" onclick="setQuantityItem(${it.request_item_id}, ${it.min_order_quantity}, ${remaining})" class="flex-1 bg-green-600 text-white py-2 rounded-lg" ${!canAdjust?'disabled':''}>Save Quantity</button>
              ${iAmHost ? `<button type='button' onclick='cancelItem(${it.request_item_id})' class='px-3 py-2 border rounded-lg text-red-600'>Cancel Product</button>` : `<button type='button' onclick='optOutItem(${it.request_item_id})' class='px-3 py-2 border rounded-lg'>Opt out</button>`}
              ${it.status==='completed' ? `<button type='button' onclick='openChatItem(${it.request_item_id})' class='px-3 py-2 border rounded-lg'>Chat💬</button>` : `<button type='button' disabled class='px-3 py-2 border rounded-lg opacity-50 cursor-not-allowed' title='Chat available after fulfillment'>Chat🔒</button>`}
            </div>
          </div>
        </div>`;
      }).join("");
      body.innerHTML = header + `<div>${list}</div>`;
      lucide.createIcons();
      modal.classList.remove("hidden");
    }
    async function joinOrUpdateCombined(requestItemId, minOrder, remaining){
      if(!currentUser){ alert("Please log in"); return; }
      var input=document.querySelector("#join-qty-"+requestItemId);
      var qty=parseInt(input.value||"0",10);
      if(!qty || qty<minOrder || qty>remaining){ alert("Invalid quantity"); return; }
      var { error:e1 } = await supabase.from("participants").upsert({ request_item_id: requestItemId, user_id: currentUser.id, quantity: qty, is_host:false }, { onConflict:"request_item_id,user_id" });
      if(e1){ alert(e1.message); return; }
      await supabase.rpc("recalc_request_item", { p_request_item_id: requestItemId });
      renderRequests();
    }

    // Chat (uses rpc chat_list to avoid relational embed issues)
    var chatSub=null; var currentChatRequestItemId=null;
    async function openChatItem(requestItemId){
      currentChatRequestItemId=requestItemId;
      document.querySelector("#chat-modal").classList.remove("hidden");
      await loadChatMessages();
      if(chatSub){ await chatSub.unsubscribe(); chatSub=null; }
      chatSub = supabase.channel("chat:item:"+requestItemId)
        .on("postgres_changes", { event:"INSERT", schema:"public", table:"chat_messages", filter:`request_item_id=eq.${requestItemId}` }, payload => { appendChat(payload.new); })
        .subscribe();
      document.querySelector("#chat-input").focus();
    }
    function closeChatModal(){ document.querySelector("#chat-modal").classList.add("hidden"); if(chatSub){ chatSub.unsubscribe(); chatSub=null; } currentChatRequestItemId=null; }
    async function loadChatMessages(){
      var box=document.querySelector("#chat-messages"); box.innerHTML="";
      var { data, error } = await supabase.rpc("chat_list_by_item", { p_request_item_id: currentChatRequestItemId });
      if(error){ box.innerHTML = "<div class='text-gray-500 p-4'>Failed to load chat.</div>"; return; }
      for(var m of data){ appendChat(m); }
      box.scrollTop = box.scrollHeight;
    }
    function appendChat(msg){
      var box=document.querySelector("#chat-messages");
      var sender = msg.full_name || msg.sender_name || "User";
      var mine = currentUser && msg.user_id === currentUser.id;
      var row=document.createElement("div");
      row.className="flex " + (mine ? "justify-end" : "justify-start");
      row.innerHTML = `<div class="chat-bubble ${mine?'bg-indigo-600 text-white':'bg-gray-100 text-gray-800'} px-3 py-2 rounded-lg"><div class="text-xs opacity-80 mb-0.5">${sender}</div>${escapeHtml(msg.message||"")}</div>`;
      box.appendChild(row);
    }
    async function sendMessage(){
      if(!currentUser){ alert("Please log in"); return; }
      var input=document.querySelector("#chat-input"); var text=input.value.trim(); if(!text) return;
      var { error } = await supabase.from("chat_messages").insert({ request_item_id: currentChatRequestItemId, user_id: currentUser.id, message: text, sender_name: null });
      if(error){ alert(error.message); return; }
      input.value="";
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // Profile save
    document.querySelector("#profile-form").addEventListener("submit", async (e)=>{
      e.preventDefault(); if(!currentUser) return alert("Please log in");
      var full_name=document.querySelector("#profile-full-name").value.trim();
      var email=document.querySelector("#profile-email-input").value.trim();
      var phone=document.querySelector("#profile-phone").value.trim();
      var { error:e1 } = await supabase.from("profiles").update({ full_name, email, phone }).eq("id", currentUser.id);
      if(e1){ alert(e1.message); return; }
      if(email && email !== currentUser.email){ var { error:e2 } = await supabase.auth.updateUser({ email }); if(e2) alert("Email change needs verification: "+e2.message); }
      await loadSession();
      alert("Profile saved");
    });

    // My groups
    async function renderMyGroups(){
      var grid=document.querySelector("#my-groups-grid"); if(!currentUser){ grid.innerHTML="<div class='text-gray-500'>Log in to see your groups.</div>"; return; }
      var { data, error } = await supabase.rpc("my_groups"); if(error){ grid.innerHTML="<div class='text-red-600'>Failed to load.</div>"; return; }
      if(!data.length){ grid.innerHTML="<div class='text-gray-500'>No groups yet.</div>"; return; }
      grid.innerHTML = data.map(r=>`<div class="bg-white rounded-xl border p-5 shadow-sm"><div class="font-semibold mb-1">${r.english_name} • ${r.product_id}</div><div class="text-xs text-gray-600 mb-2">Role: ${r.is_host?'Host':'Participant'} • Qty: ${r.quantity} lbs</div><div class="flex gap-2"><button type="button" onclick="openDetail(${r.request_id})" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Open</button><button type="button" onclick="openChat(${r.request_id})" class="px-3 py-2 border rounded-lg">Chat💬</button></div></div>`).join("");
    }

    // Init
    document.addEventListener("DOMContentLoaded", async ()=>{
      await loadSession();
      attachCreateFormHandlers();
      showSection("browse");
    });
  
async function setQuantityItem(requestItemId, minOrder, remaining){
  if(!currentUser){ alert("Please log in"); return; }
  var input = document.querySelector("#join-qty-"+requestItemId);
  var qty = parseInt(input.value||"0",10);
  if(isNaN(qty) || qty<0){ alert("Invalid quantity"); return; }
  if(qty>remaining){ if(!confirm("Quantity exceeds remaining. Continue?")) return; }
  try{
    var { data, error } = await supabase.rpc("set_quantity_request_item", { p_request_item_id: requestItemId, p_quantity: qty });
    if(error) throw error;
    await renderRequests(); // refresh cards
    // also refresh the open modal
    var open = !document.querySelector("#request-modal").classList.contains("hidden");
    if(open){ var idText = document.querySelector("#modal-content")?.querySelector("h3")?.textContent || ""; }
  }catch(ex){ alert(ex.message); }
}

async function optOutItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Opt out of this product? Your quantity will be set to 0.")) return;
  try{
    var { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("You have opted out of this product.");
  }catch(ex){ alert(ex.message); }
}

async function cancelItem(requestItemId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel this product for everyone? This cannot be undone.")) return;
  try{
    var { data, error } = await supabase.rpc("opt_out_request_item", { p_request_item_id: requestItemId });
    if(error) throw error;
    await renderRequests();
    alert("Product cancelled.");
  }catch(ex){ alert(ex.message); }
}


async function cancelWholeRequest(requestId){
  if(!currentUser){ alert("Please log in"); return; }
  if(!confirm("Cancel the entire request and delete all products? This cannot be undone.")) return;
  try{
    var { data, error } = await supabase.rpc("cancel_request", { p_request_id: requestId });
    if(error) throw error;
    document.querySelector("#request-modal").classList.add("hidden");
    await renderRequests();
    alert("Request cancelled.");
  }catch(ex){ alert(ex.message); }
}

</script><script>
(function(){
  if(!window.supabase || !supabase.channel) return;
  if(window._chatSubV9) try{ window._chatSubV9.unsubscribe(); }catch(_){}
  
window._chatSubV9 = supabase.channel('chat-realtime-v9')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, (payload)=>{
    try {
      var box = document.querySelector('#chat-messages');
      var openItemId = window.currentChatRequestItemId || window.currentOpenRequestId;
      // Only append if the message belongs to the currently open product chat
      if (box && payload.new && payload.new.request_item_id === openItemId) {
        if (typeof appendChat === 'function') {
          appendChat(payload.new);
        } else {
          var row = document.createElement('div');
          row.className = 'text-sm text-gray-800';
          row.textContent = payload.new.message || '';
          box.appendChild(row);
        }
        // auto-scroll
        box.scrollTop = box.scrollHeight;
      }
    } catch (e) {
      console.error('chat realtime append error', e);
    }
  })
  .subscribe();

})();
</script><script>
// v9.2 chat fixes: enter-to-send + instant append + auto-refresh after insert
(function(){
  function bindChatHandlers(){
    var input = document.querySelector('#chat-input');
    var sendBtn = document.querySelector('#chat-send');
    if(input && !input._enterBound){
      input.addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          await window.sendChat?.();
        }
      });
      input._enterBound = true;
    }
    if(sendBtn && !sendBtn._clickBound){
      sendBtn.addEventListener('click', async ()=>{ await window.sendChat?.(); });
      sendBtn._clickBound = true;
    }
  }

  // Fallback render if app doesn't provide loadChat/appendChat
  async function refreshChatFallback(){
    try{
      var box = document.querySelector('#chat-messages');
      if(!box || !window.currentChatRequestItemId || !window.supabase?.rpc) return;
      var { data, error } = await supabase.rpc('chat_list_by_item', { p_request_item_id: window.currentChatRequestItemId });
      if(error) throw error;
      box.innerHTML = '';
      (data||[]).forEach(msg=>{
        var row = document.createElement('div');
        row.className = 'mb-2';
        row.innerHTML = `<div class="text-xs opacity-60">${(msg.full_name||msg.sender_name||'User')}</div><div class="text-sm">${(msg.message||'')}</div>`;
        box.appendChild(row);
      });
      box.scrollTop = box.scrollHeight;
    }catch(ex){ console.error('refreshChatFallback error', ex); }
  }

  // Strong send function that always appends + refreshes
  window.sendChat = async function(){
    try{
      var input = document.querySelector('#chat-input');
      if(!input) return;
      var text = (input.value||'').trim();
      if(!text){ return; }
      if(!window.currentChatRequestItemId || !window.supabase) { alert('Chat not ready'); return; }
      // Insert
      var { error } = await supabase.from('chat_messages').insert({
        request_item_id: window.currentChatRequestItemId,
        message: text
      });
      if(error){ alert(error.message||'Failed to send'); return; }
      // Optimistic append
      var box = document.querySelector('#chat-messages');
      if(box){
        var row = document.createElement('div');
        row.className = 'mb-2';
        row.innerHTML = `<div class="text-xs opacity-60">You</div><div class="text-sm">${text}</div>`;
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;
      }
      input.value='';
      // Ensure we show the canonical, server-enriched view
      if(typeof window.loadChat === 'function'){
        await window.loadChat();
      }else{
        await refreshChatFallback();
      }
    }catch(ex){
      console.error('sendChat error', ex);
    }
  };

  // Wrap openChatItem to (a) set currentChatRequestItemId and (b) bind handlers
  function wrapOpenChat(){
    if(typeof window.openChatItem !== 'function' || window.openChatItem._wrappedEnterSend) return;
    var original = window.openChatItem;
    window.openChatItem = async function(requestItemId){
      window.currentChatRequestItemId = requestItemId;
      var res = await original.apply(this, arguments);
      // bind after next tick so modal DOM exists
      setTimeout(()=>{ bindChatHandlers(); }, 50);
      return res;
    };
    window.openChatItem._wrappedEnterSend = true;
  }

  // Also try to bind when modal DOM changes
  var observer = new MutationObserver(()=>{ bindChatHandlers(); });
  observer.observe(document.documentElement, { childList: true, subtree: true });

  document.addEventListener('DOMContentLoaded', ()=>{
    wrapOpenChat();
    bindChatHandlers();
  });
})();
</script><script>
// v9.3: ensure user_id is included on insert and message appears instantly
(function(){
  async function getCurrentUserId(){
    try{
      if(window.currentUser && currentUser.id) return currentUser.id;
      if(window.supabase?.auth?.getUser){
        var { data } = await supabase.auth.getUser();
        return data?.user?.id || null;
      }
    }catch(_){}
    return null;
  }

  // Override sendChat to always include user_id and show immediately
  var origSend = window.sendChat;
  window.sendChat = async function(){
    var input = document.querySelector('#chat-input') || document.querySelector('textarea[data-role="chat-input"]');
    if(!input) return;
    var text = (input.value||'').trim();
    if(!text) return;
    var rid = window.currentChatRequestItemId;
    if(!rid){ alert('Chat not ready'); return; }

    var uid = await getCurrentUserId();
    // optimistic append
    var box = document.querySelector('#chat-messages');
    if(box){
      var row = document.createElement('div');
      row.className = 'mb-2';
      row.innerHTML = `<div class="text-xs opacity-60">You</div><div class="text-sm">${text}</div>`;
      box.appendChild(row);
      box.scrollTop = box.scrollHeight;
    }

    // server insert (with user_id + request_item_id)
    try{
      var { error } = await supabase.from('chat_messages').insert({
        request_item_id: rid,
        user_id: uid,            // include user_id explicitly
        message: text,
        sender_name: null
      });
      if(error){ alert(error.message||'Failed to send'); }
    }catch(ex){ console.error(ex); }

    input.value='';
  };

  // Bind Enter-to-send again in case DOM changed
  function bindEnter(){
    var input = document.querySelector('#chat-input') || document.querySelector('textarea[data-role="chat-input"]');
    if(!input || input._enterV93) return;
    input.addEventListener('keydown', async (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        await window.sendChat();
      }
    });
    input._enterV93 = true;
  }

  // Run now and on DOM updates
  bindEnter();
  var mo = new MutationObserver(()=>bindEnter());
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script><script>
(function(){
  var indicator = document.getElementById('updating-indicator');
  var fab = document.getElementById('cancel-request-fab');
  var refreshTimer = null;
  var currentOpenRequestId = null;
  function showUpdating(){ if(indicator) indicator.classList.add('show'); }
  function hideUpdating(){ if(indicator) indicator.classList.remove('show'); }

  function debounceRefresh(){
    showUpdating();
    if(refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(async ()=>{
      try{
        if (typeof renderRequests === 'function') await renderRequests();
        var mySec = document.querySelector('#my-groups-section');
        if (mySec && !mySec.classList.contains('hidden') && typeof renderMyGroups === 'function') {
          await renderMyGroups();
        }
        if(currentOpenRequestId && typeof supabase?.rpc === 'function'){
          try{
            var { data: rows } = await supabase.rpc('request_detail_combined', { p_request_id: currentOpenRequestId });
            if(!rows || !rows.length){ hideFab(); }
            else { if(typeof openDetail === 'function') openDetail(currentOpenRequestId); }
          }catch(_){ hideFab(); }
        }
      } finally { hideUpdating(); }
    }, 250);
  }

  function showFab(){ if(fab) fab.classList.add('show'); }
  function hideFab(){ if(fab) fab.classList.remove('show'); currentOpenRequestId = null; }

  async function startRealtime(){
    if(!window.supabase || !supabase.channel) return;
    if(window._reqSub){ try{ await window._reqSub.unsubscribe(); }catch(e){} }
    window._reqSub = supabase.channel('requests-realtime-v9')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'request_items' }, debounceRefresh)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'group_requests' }, debounceRefresh)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, debounceRefresh)
      .subscribe();

    if(window._chatSubV9){ try{ await window._chatSubV9.unsubscribe(); }catch(e){} }
    window._chatSubV9 = supabase.channel('chat-realtime-v9')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, (payload)=>{
        var box = document.querySelector('#chat-messages');
        if(box){
          try{
            if(typeof appendChat === 'function'){ appendChat(payload.new); }
            else {
              var div = document.createElement('div');
              div.className = 'text-sm text-gray-700';
              div.textContent = payload.new.message || '';
              box.appendChild(div);
            }
            box.scrollTop = box.scrollHeight;
          }catch(_){ debounceRefresh(); }
        }else{ debounceRefresh(); }
      })
      .subscribe();
  }

  function wrapOpenDetail(){
    if(typeof openDetail !== 'function' || openDetail._wrappedV9) return;
    var original = openDetail;
    window.openDetail = async function(requestId){
      currentOpenRequestId = requestId;
      var res = await original.apply(this, arguments);
      try{
        if(typeof supabase?.rpc === 'function'){
          var { data } = await supabase.rpc('is_host_for_request', { p_request_id: requestId });
          if(data === true){ showFab(); } else { hideFab(); }
        } else { hideFab(); }
      }catch(_){ hideFab(); }
      return res;
    };
    window.openDetail._wrappedV9 = true;
  }

  if(fab){
    fab.addEventListener('click', async ()=>{
      if(!currentOpenRequestId) return;
      if(!confirm('Cancel the entire request and delete all products? This cannot be undone.')) return;
      try{
        showUpdating();
        var { error } = await supabase.rpc('cancel_request', { p_request_id: currentOpenRequestId });
        if(error) throw error;
        hideFab();
        if (typeof renderRequests === 'function') await renderRequests();
        if (typeof renderMyGroups === 'function') await renderMyGroups();
        var modal = document.querySelector('#request-modal');
        if(modal) modal.classList.add('hidden');
      }catch(ex){ alert(ex.message || 'Failed to cancel request'); }
      finally{ hideUpdating(); }
    });
  }

  // Auto-scroll chat for any new nodes
  var chatBox = document.querySelector('#chat-messages');
  if(chatBox){
    var obs = new MutationObserver(()=>{ chatBox.scrollTop = chatBox.scrollHeight; });
    obs.observe(chatBox, { childList: true });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    wrapOpenDetail();
    await startRealtime();
  });
})();
</script>
</body>
</html>
