<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SG Group Buy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge { @apply inline-flex items-center justify-center rounded-full bg-red-600 text-white text-[10px] leading-none px-1.5 py-0.5; min-width: 16px; }
    .btn { @apply inline-flex items-center justify-center rounded-2xl bg-blue-600 px-4 py-2 text-white font-medium transition hover:bg-blue-700; }
    .card { @apply rounded-2xl border border-gray-200 p-4 shadow-sm; }
    .input { @apply w-full rounded-xl border border-gray-300 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500; }
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="#" class="flex items-center gap-2" onclick="showSection('list');return false;">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=" alt="Logo" class="h-8 w-auto select-none" />
      </a>
      <nav class="flex items-center gap-3 text-sm">
        <button class="underline" onclick="showSection('list')">探索團購</button>
        <button class="underline" onclick="showSection('create')">發起團購</button>
        <div class="relative">
          <button id="notifToggle" class="relative rounded-xl border px-3 py-1.5">
            通知
            <span id="notifBadge" class="badge absolute -top-1 -right-1 hidden">0</span>
          </button>
          <div id="notifPanel" class="hidden absolute right-0 mt-2 w-80 rounded-xl border bg-white shadow">
            <div id="notifList" class="max-h-80 overflow-auto"></div>
          </div>
        </div>
        <button id="langToggle" class="rounded-xl border px-3 py-1.5">EN</button>
      </nav>
    </div>
  </header>

  <section id="auth-notify" class="max-w-6xl mx-auto mt-4 px-4 py-3 border rounded-2xl">
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <h3 class="font-semibold mb-2">帳號登入 / 註冊（Email）</h3>
        <input id="authEmail" class="input" placeholder="Email" type="email" />
        <input id="authPass" class="input mt-2" placeholder="密碼" type="password" />
        <div class="flex gap-2 mt-2">
          <button class="btn" id="btnSignup">註冊</button>
          <button class="btn" id="btnLogin">登入</button>
          <button class="btn bg-gray-600 hover:bg-gray-700" id="btnLogout">登出</button>
        </div>
        <button class="btn bg-emerald-600 hover:bg-emerald-700 mt-2" id="btnForgotEmail">以 Email 重設密碼</button>
        <div id="authMsg" class="mt-2 text-sm text-blue-700"></div>
      </div>
      <div>
        <h3 class="font-semibold mb-2">手機簡訊登入（密碼免）</h3>
        <input id="smsPhone" class="input" placeholder="手機號碼（含國碼，如 +852...）" />
        <div class="flex gap-2 mt-2">
          <button class="btn" id="btnSmsSend">傳送驗證碼</button>
          <button class="btn bg-emerald-600 hover:bg-emerald-700" id="btnSmsVerify">驗證登入</button>
        </div>
        <input id="smsCode" class="input mt-2" placeholder="簡訊驗證碼" />
        <div id="smsMsg" class="mt-2 text-sm text-blue-700"></div>
      </div>
      <div>
        <h3 class="font-semibold mb-2">通知設定</h3>
        <div class="flex flex-wrap gap-2">
          <button class="btn" id="btnBrowserNotify">允許瀏覽器通知</button>
          <input id="notifyEmail" class="input" placeholder="Email for alerts（可選）" />
          <input id="notifyPhone" class="input" placeholder="Phone for SMS（可選，含國碼）" />
          <button class="btn bg-sky-600 hover:bg-sky-700" id="btnTestNotify">測試通知</button>
        </div>
        <div id="notifyMsg" class="mt-2 text-sm text-blue-700"></div>
      </div>
    </div>
  </section>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <section id="section-list" class="space-y-4">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-2xl font-semibold">團購列表</h1>
        <input id="searchInput" class="input max-w-md" placeholder="搜尋商品或團購…" />
      </div>
      <div id="listGrid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <section id="section-create" class="hidden space-y-4">
      <h2 class="text-2xl font-semibold">發起團購</h2>
      <div class="card space-y-3">
        <div class="grid sm:grid-cols-2 gap-3">
          <input id="productId" class="input" placeholder="商品代碼（例：P001）" />
          <input id="hostQty" class="input" placeholder="主辦人數量" type="number" min="1" value="5" />
          <input id="totalQty" class="input" placeholder="總數量" type="number" min="1" value="20" />
          <input id="minOrder" class="input" placeholder="最小起訂量" type="number" min="1" value="5" />
        </div>
        <textarea id="notes" class="input" placeholder="備註（取貨地點、時間等）"></textarea>
        <button class="btn" onclick="createGroup()">建立請求</button>
        <div id="createMsg" class="text-sm text-gray-600"></div>
      </div>
    </section>

    <section id="section-detail" class="hidden space-y-4">
      <button class="underline text-sm" onclick="showSection('list')">← 返回列表</button>
      <div id="detailWrap" class="space-y-6"></div>
    </section>
  </main>

  <script type="module">
    import {{ createClient }} from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    if (!window.SaveGoSupabase?.supabase) {{
      window.SaveGoSupabase = window.SaveGoSupabase || {{}};
      window.SaveGoSupabase.supabase = createClient(
        "https://bwlqwrlsibmqttndymzu.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3bHF3cmxzaWJtcXR0bmR5bXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDA0MzcsImV4cCI6MjA3NjA3NjQzN30.QQ8Lncmyl_VfP4a_hc9JP-W9YdlcRl21-8N4LTi2WDM",
        {{ auth: {{ persistSession: true, autoRefreshToken: true, detectSessionInUrl: true, storage: window.localStorage }} }}
      );
    }}
    const supabase = window.SaveGoSupabase.supabase;

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    function showSection(which) {{
      $('#section-list').classList.toggle('hidden', which !== 'list');
      $('#section-create').classList.toggle('hidden', which !== 'create');
      $('#section-detail').classList.toggle('hidden', which !== 'detail');
    }}
    function progress(it) {{
      const cur = it.currentQuantity || 0; const tot = Math.max(1, it.totalQuantity || 1);
      return Math.min(100, Math.round(100 * cur / tot));
    }}
    function isFulfilled(gb) {{ return (gb.items || []).every(it => (it.currentQuantity||0) >= (it.totalQuantity||0)); }}

    let lang = 'zh'; $('#langToggle').onclick = () => {{ lang = lang==='zh'?'en':'zh'; $('#langToggle').textContent = lang==='zh'?'EN':'中文'; renderList(); if (currentDetailId) renderDetail(currentDetailId); }};

    // Notifications
    const notifPanel = $('#notifPanel'); const notifBadge = $('#notifBadge');
    let uiNotifications = [];
    $('#notifToggle').onclick = async () => {{ notifPanel.classList.toggle('hidden'); if (!uiNotifications.length) await hydrateNotifications(); renderNotifications(); }};
    function renderNotifications(){{
      const list = $('#notifList');
      if (!uiNotifications.length){{ list.innerHTML = '<div class="p-4 text-center text-gray-500">沒有通知</div>'; notifBadge.classList.add('hidden'); return; }}
      notifBadge.classList.remove('hidden'); notifBadge.textContent = String(uiNotifications.length);
      list.innerHTML = uiNotifications.map((n,i)=>`
        <button class="w-full text-left p-3 border-b hover:bg-gray-50" data-idx="${{i}}">
          <div class="text-sm text-gray-900">${{n.text}}</div>
          <div class="text-xs text-gray-500">${{new Date(n.created_at).toLocaleString()}}</div>
        </button>`).join('');
      $$('#notifList [data-idx]').forEach(btn=>btn.onclick=async(e)=>{{ const i=+e.currentTarget.dataset.idx; const n=uiNotifications.splice(i,1)[0]; renderNotifications(); if(n?.id) await supabase.from('notifications').update({{read:true}}).eq('id', n.id); }});
    }}
    async function hydrateNotifications(){{
      const {{ data: {{ user }} }} = await supabase.auth.getUser(); if(!user) return;
      const {{ data }} = await supabase.from('notifications').select('*').eq('user_id', user.id).order('created_at', {{ascending:false}});
      uiNotifications = data||[];
    }}

    // Auth UI
    async function updateAuthUI(user){{ const msg=$('#authMsg'); if(msg) msg.textContent = user ? `已登入：${{user.email||user.phone}}` : '未登入'; }}
    const {{ data: {{ session }} }} = await supabase.auth.getSession(); updateAuthUI(session?.user||null);
    supabase.auth.onAuthStateChange((_evt, session)=>updateAuthUI(session?.user||null));

    $('#btnSignup').onclick = async () => {{ try{{ const email=$('#authEmail').value.trim(); const password=$('#authPass').value; const {{ error }} = await supabase.auth.signUp({{ email, password, options: {{ emailRedirectTo: window.location.origin }} }}); if(error) throw error; $('#authMsg').textContent='註冊成功，請查收驗證信（若已關閉驗證則可直接登入）。'; }}catch(e){{ $('#authMsg').textContent=e.message||'註冊失敗'; }} }};
    $('#btnLogin').onclick = async () => {{ try{{ const email=$('#authEmail').value.trim(); const password=$('#authPass').value; const {{ error }} = await supabase.auth.signInWithPassword({{ email, password }}); if(error) throw error; $('#authMsg').textContent='登入成功'; await hydrateNotifications(); renderNotifications(); }}catch(e){{ $('#authMsg').textContent=e.message||'登入失敗'; }} }};
    $('#btnLogout').onclick = async () => {{ await supabase.auth.signOut(); $('#authMsg').textContent='已登出'; uiNotifications=[]; renderNotifications(); }};
    $('#btnForgotEmail').onclick = async () => {{ try{{ const email=$('#authEmail').value.trim(); const {{ error }} = await supabase.auth.resetPasswordForEmail(email,{{ redirectTo: window.location.origin + '/reset' }}); if(error) throw error; $('#authMsg').textContent='已寄送重設密碼連結至 Email。'; }}catch(e){{ $('#authMsg').textContent=e.message||'寄送失敗'; }} }};

    // SMS
    $('#btnSmsSend').onclick = async () => {{ try{{ const phone=$('#smsPhone').value.trim(); const {{ error }} = await supabase.auth.signInWithOtp({{ phone }}); if(error) throw error; $('#smsMsg').textContent='已傳送驗證碼。'; }}catch(e){{ $('#smsMsg').textContent=e.message||'傳送失敗'; }} }};
    $('#btnSmsVerify').onclick = async () => {{ try{{ const phone=$('#smsPhone').value.trim(); const token=$('#smsCode').value.trim(); const {{ error }} = await supabase.auth.verifyOtp({{ phone, token, type:'sms' }}); if(error) throw error; $('#smsMsg').textContent='手機登入成功。'; await hydrateNotifications(); renderNotifications(); }}catch(e){{ $('#smsMsg').textContent=e.message||'驗證失敗'; }} }};

    // Browser notifications
    $('#btnBrowserNotify').onclick = async () => {{ try{{ const perm = await Notification.requestPermission(); if(perm!=='granted') return $('#notifyMsg').textContent='已拒絕或尚未允許通知。'; new Notification('通知已啟用', {{ body:'您將會在瀏覽器中收到提醒。' }}); $('#notifyMsg').textContent='瀏覽器通知已啟用。'; }}catch(e){{ $('#notifyMsg').textContent=e.message||'通知權限失敗'; }} }};
    $('#btnTestNotify').onclick = async () => {{ try{{ new Notification('測試通知', {{ body:'這是一則測試訊息。' }}); $('#notifyMsg').textContent='已嘗試顯示瀏覽器通知。'; }}catch(e){{ $('#notifyMsg').textContent=e.message||'測試失敗'; }} }};

    // Data flows
    let groupBuys = [];
    async function loadList(){{ const {{ data, error }} = await supabase.from('groupbuys').select('*, items:groupbuy_items(*, participants:participants(*))').order('created_at',{{ascending:false}}).limit(50); if(error){{console.warn(error.message); return;}} groupBuys = (data||[]).map(gb => ({{ id: gb.id, hostName: gb.host_name||'—', items: (gb.items||[]).map(it=>({{ productId: it.product_id, hostQuantity: it.host_quantity, totalQuantity: it.total_quantity, currentQuantity: it.current_quantity, minOrder: it.min_order||5, status: it.status||'open' }})), notes: gb.notes||'', status: gb.status||'open', createdAt: gb.created_at ? new Date(gb.created_at) : new Date() }})); }}
    function renderList(){{
      const grid = $('#listGrid'); const q=($('#searchInput').value||'').toLowerCase();
      const items = groupBuys.filter(gb => !q || (gb.items||[]).some(it => String(it.productId||'').toLowerCase().includes(q)));
      grid.innerHTML = items.map(gb=>{{ const it=gb.items?.[0]||{{}}; const p=progress({{currentQuantity:it.currentQuantity,totalQuantity:it.totalQuantity}}); return `
        <div class="card flex flex-col gap-2">
          <div class="text-sm text-gray-600">主辦人：${{gb.hostName}}</div>
          <div class="text-xs text-gray-600">進度：${{it.currentQuantity||0}} / ${{it.totalQuantity||0}}</div>
          <div class="w-full h-2 bg-gray-100 rounded overflow-hidden"><div class="h-2 bg-blue-500" style="width:${{p}}%"></div></div>
          <div class="flex justify-between items-center mt-2">
            <button class="underline" onclick="openDetail('${{gb.id}}')">詳情</button>
            <span class="text-xs px-2 py-1 rounded bg-gray-100">${{gb.status}}</span>
          </div>
        </div>`; }}).join('') || '<div class="text-gray-500">—</div>';
    }}
    document.getElementById('searchInput').addEventListener('input', renderList);

    let currentDetailId = null;
    async function openDetail(id){{ currentDetailId = id; const {{ data, error }} = await supabase.from('groupbuys').select('*, items:groupbuy_items(*, participants:participants(*))').eq('id', id).single(); if(error) return; const gb = {{ id: data.id, hostName: data.host_name||'—', items:(data.items||[]).map(it=>({{ productId: it.product_id, hostQuantity: it.host_quantity, totalQuantity: it.total_quantity, currentQuantity: it.current_quantity, minOrder: it.min_order||5, status: it.status||'open' }})), notes: data.notes||'', status:data.status||'open' }}; renderDetailFromObj(gb); showSection('detail'); }}
    function renderDetailFromObj(gb){{
      const it = gb.items?.[0]||{{}}; const fulfilled = isFulfilled(gb);
      document.getElementById('detailWrap').innerHTML = `
        <div class="grid gap-6 md:grid-cols-2">
          <div class="rounded-2xl border border-gray-200 h-64 md:h-96"></div>
          <div class="space-y-3">
            <h1 class="text-3xl font-bold">團購詳情</h1>
            <p class="text-gray-600">${{gb.notes||'—'}}</p>
            <div class="text-sm text-gray-600">MOQ: <strong>${{it.minOrder??5}}</strong> · 已加入: <strong>${{it.currentQuantity??0}}</strong> / <strong>${{it.totalQuantity??0}}</strong></div>
            <div class="flex gap-3 items-center">
              <div class="flex items-center gap-2">
                <input id="joinQty" type="number" min="1" value="1" class="input w-24" />
                <button class="btn" onclick="joinGroup('${{gb.id}}')">參加</button>
              </div>
              <button class="rounded-2xl px-3 py-2 border" data-optout-id="${{gb.id}}">主辦人退出</button>
            </div>
            <div id="detailMsg" class="text-sm text-blue-700"></div>
          </div>
        </div>
        <div class="card space-y-2">
          <div class="font-medium">在此請求中再添加產品</div>
          <div class="grid grid-cols-3 gap-2">
            <input id="addProductId" class="input" placeholder="商品代碼 (P001)"/>
            <input id="addHostQty" class="input" type="number" min="1" value="1" placeholder="主辦人數量" />
            <input id="addTotalQty" class="input" type="number" min="1" value="10" placeholder="總數量" />
          </div>
          <button class="btn" onclick="addItem('${{gb.id}}')">新增</button>
        </div>
        <section class="card space-y-2">
          <div class="font-medium">群聊</div>
          ${{fulfilled ? '<div class="text-sm text-gray-600">（此處可接入即時聊天服務。）</div>' : '<div class="text-sm text-gray-600">只有全部數量滿足後才能聊天。</div>'}}
        </section>`;
    }}
    window.openDetail = openDetail;

    async function joinGroup(id){{
      const qty = Math.max(1, parseInt(document.getElementById('joinQty').value||'1',10));
      const {{ data:item, error:ierr }} = await supabase.from('groupbuy_items').select('id,total_quantity,current_quantity').eq('groupbuy_id', id).order('created_at').limit(1).single();
      if (ierr) return document.getElementById('detailMsg').textContent = '找不到團購';
      if (item.current_quantity + qty > item.total_quantity) return document.getElementById('detailMsg').textContent='超出剩餘數量';
      const {{ data: {{ user }} }} = await supabase.auth.getUser(); if(!user) return document.getElementById('detailMsg').textContent='請先登入';
      await supabase.from('groupbuy_items').update({{ current_quantity: item.current_quantity + qty }}).eq('id', item.id);
      await supabase.from('participants').insert({{ groupbuy_item_id:item.id, user_id:user.id, quantity:qty, is_host:false }});
      document.getElementById('detailMsg').textContent='加入成功'; await openDetail(id); await loadList(); renderList();
    }}
    async function addItem(id){{
      const product_id = document.getElementById('addProductId').value.trim();
      const host_quantity = Math.max(1, parseInt(document.getElementById('addHostQty').value||'1',10));
      const total_quantity = Math.max(1, parseInt(document.getElementById('addTotalQty').value||'1',10));
      const {{ data: {{ user }} }} = await supabase.auth.getUser(); if(!user) return document.getElementById('detailMsg').textContent='請先登入';
      const {{ data: group }} = await supabase.from('groupbuys').select('host_user').eq('id', id).single();
      if(!group || group.host_user !== user.id) return document.getElementById('detailMsg').textContent='只有主辦人可以添加產品';
      const {{ error }} = await supabase.from('groupbuy_items').insert({{ groupbuy_id:id, product_id, host_quantity, total_quantity, current_quantity:host_quantity, min_order:5 }});
      if(error) return document.getElementById('detailMsg').textContent=error.message; document.getElementById('detailMsg').textContent='已添加商品'; await openDetail(id);
    }}
    async function createGroup(){{
      const item = {{ product_id: document.getElementById('productId').value.trim(), host_quantity: Math.max(1, parseInt(document.getElementById('hostQty').value||'1',10)), total_quantity: Math.max(1, parseInt(document.getElementById('totalQty').value||'1',10)), min_order: Math.max(1, parseInt(document.getElementById('minOrder').value||'1',10)) }};
      const notes = document.getElementById('notes').value.trim();
      const {{ data: {{ user }} }} = await supabase.auth.getUser(); if(!user) return document.getElementById('createMsg').textContent='請先登入';
      const {{ data: gb, error: e1 }} = await supabase.from('groupbuys').insert({{ host_user:user.id, notes }}).select('*').single();
      if(e1) return document.getElementById('createMsg').textContent=e1.message;
      await supabase.from('groupbuy_items').insert({{ groupbuy_id:gb.id, product_id:item.product_id, host_quantity:item.host_quantity, total_quantity:item.total_quantity, current_quantity:item.host_quantity, min_order:item.min_order }});
      const {{ data: gbi }} = await supabase.from('groupbuy_items').select('id').eq('groupbuy_id', gb.id).order('created_at', {{ascending:false}}).limit(1).single();
      await supabase.from('participants').insert({{ groupbuy_item_id:gbi.id, user_id:user.id, quantity:item.host_quantity, is_host:true }});
      document.getElementById('createMsg').textContent='已建立'; await loadList(); renderList(); showSection('list');
    }}

    document.addEventListener('click', async (e)=>{{ const btn=e.target.closest('[data-optout-id]'); if(!btn) return; const id=btn.getAttribute('data-optout-id'); const original=btn.textContent; btn.disabled=true; btn.textContent='作廢中…'; try{{ const {{ data: {{ user }} }} } = await supabase.auth.getUser(); if(!user) throw new Error('請先登入'); const {{ data: group }} = await supabase.from('groupbuys').select('host_user').eq('id', id).single(); if(!group || group.host_user !== user.id) throw new Error('只有主辦人可以作廢'); await supabase.from('groupbuys').update({{status:'void'}}).eq('id', id); await supabase.from('groupbuy_items').update({{status:'void'}}).eq('groupbuy_id', id); alert('主辦人已退出，團購已作廢。'); await loadList(); renderList(); if(currentDetailId===id) await openDetail(id); }}catch(err){{ alert(err.message||'失敗'); }} finally{{ btn.disabled=false; btn.textContent=original; }} }});

    document.getElementById('searchInput').placeholder = '搜尋商品或團購…';
    await loadList(); renderList();
  </script>
</body>
</html>
