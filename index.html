<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Converted File</title>
</head>
<body>
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaveGo - Group Buying Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .animate-pulse-hover:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.5s ease;
        }
        
        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .search-dropdown {
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
        }
        
        .products-container {
            transition: max-height 0.3s ease-in-out;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center">
                        <i data-lucide="shopping-bag" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-900">SaveGo</span>
                </div>
                
                <div class="hidden md:flex items-center space-x-8">
                    <button onclick="showSection('browse')" class="text-gray-600 hover:text-gray-900 transition-colors">Browse Requests</button>
                    <button onclick="showSection('create')" class="text-gray-600 hover:text-gray-900 transition-colors">Create Request</button>
                    <button onclick="showSection('my-groups')" class="text-gray-600 hover:text-gray-900 transition-colors">My Groups</button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="toggleLanguage()" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <span id="language-toggle">中文</span>
                    </button>
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 text-gray-600 hover:text-gray-900 transition-colors relative">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notifications-dropdown" class="absolute right-0 top-full mt-2 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                            <div class="p-4 border-b">
                                <h3 class="font-semibold text-gray-900">Notifications</h3>
                            </div>
                            <div id="notifications-list" class="max-h-64 overflow-y-auto">
                                <div class="p-4 text-center text-gray-500">No notifications</div>
                            </div>
                            <div class="p-3 border-t text-center">
                                <button onclick="clearAllNotifications()" class="text-sm text-gray-600 hover:text-gray-800">Clear All</button>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50 transition-colors">
                            <div id="user-avatar" class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                G
                            </div>
                            <span id="user-name-display" class="text-sm font-medium text-gray-700 hidden md:block">Guest</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                        </button>
                        <div id="user-menu" class="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden">
                            <div id="logged-in-menu" class="hidden">
                                <div class="p-3 border-b">
                                    <p class="font-medium text-gray-900" id="menu-user-name">User Name</p>
                                    <p class="text-sm text-gray-600" id="menu-user-email">user@email.com</p>
                                </div>
                                <button onclick="showSection('profile')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="profile-menu-btn">Profile Settings</button>
                                <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50" id="logout-menu-btn">Logout</button>
                            </div>
                            <div id="guest-menu">
                                <button onclick="showLoginModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="login-menu-btn">Login</button>
                                <button onclick="showSignupModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" id="signup-menu-btn">Create Account</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Browse Section -->
        <div id="browse-section" class="section">
            <div class="mb-8">
                <h1 id="browse-title" class="text-3xl font-bold text-gray-900 mb-4">Active Group Buy Requests</h1>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="search-requests" placeholder="Search by product name, ID, or host..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="all">All Status</option>
                        <option value="open">Open</option>
                        <option value="almost-full">Almost Full</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>
            
            <div id="requests-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Requests will be populated here -->
            </div>
        </div>

        <!-- Create Request Section -->
        <div id="create-section" class="section hidden">
            <div class="max-w-2xl mx-auto">
                <h1 id="create-title" class="text-3xl font-bold text-gray-900 mb-8">Create Group Buy Request</h1>
                
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <form id="create-request-form">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 id="products-title" class="text-lg font-semibold text-gray-900">Products</h3>
                                <span id="products-subtitle" class="text-sm text-gray-600">Add multiple products to your group buy</span>
                            </div>
                            
                            <div id="selected-products-list" class="space-y-4 mb-4">
                                <!-- Selected products will appear here -->
                            </div>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                                <div class="text-center mb-4">
                                    <i data-lucide="plus-circle" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                    <p id="add-product-text" class="text-gray-600">Add a product to your group buy</p>
                                </div>
                                
                                <div class="relative mb-4">
                                    <input type="text" id="product-search" placeholder="Search by product name or ID..." 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <div id="search-results" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg mt-1 search-dropdown hidden">
                                        <!-- Search results will appear here -->
                                    </div>
                                </div>
                                
                                <div id="add-product-form" class="hidden">
                                    <div id="selected-product-preview" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <!-- Selected product preview will appear here -->
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label id="quantity-label" class="block text-sm font-medium text-gray-700 mb-2">Your Required Quantity (lbs)</label>
                                            <input type="number" id="host-quantity" min="1" placeholder="e.g., 10" 
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label id="min-order-label" class="block text-sm font-medium text-gray-700 mb-2">Minimum Order (lbs)</label>
                                            <input type="number" id="min-order-quantity" min="1" placeholder="e.g., 5" value="5"
                                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    
                                    <div id="quantity-feedback" class="mb-4 text-sm hidden">
                                        <!-- Dynamic feedback will appear here -->
                                    </div>
                                    
                                    <div class="flex space-x-3">
                                        <button type="button" onclick="addProductToRequest()" id="add-product-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                            <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                            Add Product
                                        </button>
                                        <button type="button" onclick="cancelAddProduct()" id="cancel-product-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label id="notes-label" class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
                            <textarea id="request-notes" rows="3" placeholder="Any special requirements, pickup location preferences, etc..." 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" id="create-request-btn" disabled>
                            Create Group Buy Request
                        </button>
                        <p id="create-help-text" class="text-sm text-gray-500 text-center mt-2">Add at least one product to create your request</p>
                    </form>
                </div>
            </div>
        </div>

        <!-- My Groups Section -->
        <div id="my-groups-section" class="section hidden">
            <h1 id="my-groups-title" class="text-3xl font-bold text-gray-900 mb-8">My Group Buys</h1>
            <div id="my-groups-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- User's groups will be populated here -->
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="section hidden">
            <div class="max-w-2xl mx-auto">
                <h1 id="profile-settings-title" class="text-3xl font-bold text-gray-900 mb-8">Profile Settings</h1>
                
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <div class="flex items-center space-x-6 mb-8">
                        <div id="profile-avatar" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            U
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900" id="profile-name">User Name</h2>
                            <p class="text-gray-600" id="profile-email">user@email.com</p>
                        </div>
                    </div>
                    
                    <form id="profile-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label id="full-name-label" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                <input type="text" id="profile-full-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div>
                                <label id="email-label" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="profile-email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label id="phone-label" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="profile-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        
                        <div class="mb-6">
                            <h3 id="notification-preferences-title" class="text-lg font-semibold text-gray-900 mb-4">Notification Preferences</h3>
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 id="notification-types-title" class="font-medium text-gray-900 mb-3">Receive notifications for:</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-new-participants" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-participants-label" class="ml-2 text-sm text-gray-700">New participants join my group buys</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-order-fulfilled" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-fulfilled-label" class="ml-2 text-sm text-gray-700">Orders are fulfilled/completed</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-quantity-changes" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-quantity-label" class="ml-2 text-sm text-gray-700">Participants adjust their quantities</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-cancellations" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-cancel-label" class="ml-2 text-sm text-gray-700">Group buys are cancelled or participants leave</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 id="notification-methods-title" class="font-medium text-gray-900 mb-3">Notification methods:</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-browser" checked class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-browser-label" class="ml-2 text-sm text-gray-700">Browser notifications (in-app)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-email" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-email-label" class="ml-2 text-sm text-gray-700">Email notifications</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="notify-sms" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span id="notify-sms-label" class="ml-2 text-sm text-gray-700">SMS text messages</span>
                                        </label>
                                    </div>
                                    <p id="notification-note" class="text-xs text-gray-500 mt-2">Email and SMS notifications require verification and may have additional charges.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" id="save-changes-btn" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                Save Changes
                            </button>
                            <button type="button" onclick="showChangePasswordModal()" id="change-password-btn" class="bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                                Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div id="request-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div id="modal-content">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full h-[600px] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="chat-modal-title">Group Chat</h3>
                <button onclick="closeChatModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3">
                <!-- Chat messages will appear here -->
            </div>
            <div class="p-4 border-t">
                <div class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type your message..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <button onclick="sendMessage()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="login-modal-title" class="text-2xl font-bold text-gray-900">Login</h2>
                    <button onclick="closeLoginModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="login-form">
                    <div class="mb-4">
                        <label id="login-identifier-label" class="block text-sm font-medium text-gray-700 mb-2">Email or Phone</label>
                        <input type="text" id="login-identifier" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-6">
                        <label id="login-password-label" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" id="login-submit-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors mb-4">
                        Login
                    </button>
                    
                    <div class="text-center">
                        <span id="login-signup-text" class="text-sm text-gray-600">Don't have an account? </span>
                        <button type="button" onclick="showSignupModal()" id="login-signup-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                            Sign up
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="signup-modal-title" class="text-2xl font-bold text-gray-900">Create Account</h2>
                    <button onclick="closeSignupModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="signup-form">
                    <div class="mb-4">
                        <label id="signup-name-label" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="signup-name" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-4">
                        <label id="signup-email-label" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="signup-email" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-4">
                        <label id="signup-phone-label" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="signup-phone" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-6">
                        <label id="signup-password-label" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="signup-password" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <p id="signup-password-help" class="text-xs text-gray-500 mt-1">Must be at least 8 characters</p>
                    </div>
                    
                    <button type="submit" id="signup-submit-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors mb-4">
                        Create Account
                    </button>
                    
                    <div class="text-center">
                        <span id="signup-login-text" class="text-sm text-gray-600">Already have an account? </span>
                        <button type="button" onclick="showLoginModal()" id="signup-login-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                            Login
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Change Password</h2>
                    <button onclick="closeChangePasswordModal()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="change-password-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                        <input type="password" id="current-password" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input type="password" id="new-password" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                        <input type="password" id="confirm-password" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                        Change Password
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Sample product database
        const productDatabase = [
            {
                id: "P001",
                englishName: "Premium Organic Apples",
                chineseName: "优质有机苹果",
                caseWeight: 40,
                packaging: "Cardboard box, 40 individual apples",
                image: "🍎",
                category: "Fruits"
            },
            {
                id: "P002", 
                englishName: "Fresh Atlantic Salmon",
                chineseName: "新鲜大西洋三文鱼",
                caseWeight: 25,
                packaging: "Vacuum sealed, ice packed",
                image: "🐟",
                category: "Seafood"
            },
            {
                id: "P003",
                englishName: "Organic Baby Spinach",
                chineseName: "有机嫩菠菜",
                caseWeight: 15,
                packaging: "Plastic containers, pre-washed",
                image: "🥬",
                category: "Vegetables"
            },
            {
                id: "P004",
                englishName: "Premium Wagyu Beef",
                chineseName: "优质和牛肉",
                caseWeight: 30,
                packaging: "Vacuum sealed portions",
                image: "🥩",
                category: "Meat"
            },
            {
                id: "P005",
                englishName: "Imported Italian Pasta",
                chineseName: "进口意大利面条",
                caseWeight: 20,
                packaging: "Individual 1lb packages",
                image: "🍝",
                category: "Pantry"
            },
            {
                id: "P006",
                englishName: "Organic Blueberries",
                chineseName: "有机蓝莓",
                caseWeight: 12,
                packaging: "Plastic pint containers",
                image: "🫐",
                category: "Fruits"
            }
        ];
        
        // User accounts database
        let userAccounts = [
            {
                id: 1,
                name: "Sarah Chen",
                email: "sarah.chen@email.com",
                phone: "+1-555-0101",
                password: "password123",
                avatar: "S",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 2,
                name: "David Kim",
                email: "david.kim@email.com",
                phone: "+1-555-0102",
                password: "password123",
                avatar: "D",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 3,
                name: "Emma Liu",
                email: "emma.liu@email.com",
                phone: "+1-555-0103",
                password: "password123",
                avatar: "E",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            },
            {
                id: 4,
                name: "Mike Johnson",
                email: "mike.johnson@email.com",
                phone: "+1-555-0104",
                password: "password123",
                avatar: "M",
                notificationPreferences: {
                    newParticipants: true,
                    orderFulfilled: true,
                    quantityChanges: true,
                    cancellations: true,
                    browserNotifications: true,
                    emailNotifications: false,
                    smsNotifications: false
                }
            }
        ];
        
        // Current user session
        let currentUser = null;
        let isLoggedIn = false;
        
        // Notifications system
        let userNotifications = [];
        
        // Sample group buy requests
        let groupBuyRequests = [
            {
                id: 1,
                hostName: "Sarah Chen",
                items: [
                    {
                        productId: "P001",
                        hostQuantity: 10,
                        totalQuantity: 40,
                        currentQuantity: 25,
                        participants: [
                            { name: "Sarah Chen", quantity: 10, isHost: true },
                            { name: "Mike Johnson", quantity: 8 },
                            { name: "Lisa Wang", quantity: 7 }
                        ],
                        status: "open"
                    }
                ],
                notes: "Pickup available in downtown area. Prefer weekend pickup.",
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000),
                chatEnabled: true
            },
            {
                id: 2,
                hostName: "David Kim",
                items: [
                    {
                        productId: "P002",
                        hostQuantity: 5,
                        totalQuantity: 25,
                        currentQuantity: 25,
                        participants: [
                            { name: "David Kim", quantity: 5, isHost: true },
                            { name: "Emma Liu", quantity: 8 },
                            { name: "John Smith", quantity: 6 },
                            { name: "Amy Zhang", quantity: 6 }
                        ],
                        status: "completed"
                    }
                ],
                notes: "Fresh delivery required. Split payment via Venmo.",
                createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                chatEnabled: true
            }
        ];
        
        // Chat messages for each request
        let chatMessages = {
            1: [
                { sender: "Sarah Chen", message: "Hi everyone! Thanks for joining my apple group buy 🍎", timestamp: new Date(Date.now() - 60 * 60 * 1000) },
                { sender: "Mike Johnson", message: "Thanks for organizing! When are you thinking for pickup?", timestamp: new Date(Date.now() - 45 * 60 * 1000) },
                { sender: "Sarah Chen", message: "I was thinking this Saturday around 2 PM at the farmer's market?", timestamp: new Date(Date.now() - 30 * 60 * 1000) },
                { sender: "Lisa Wang", message: "Saturday works for me! Should we split the payment now or at pickup?", timestamp: new Date(Date.now() - 15 * 60 * 1000) }
            ],
            2: [
                { sender: "David Kim", message: "Salmon group buy almost full! Just 2 lbs left 🐟", timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000) },
                { sender: "Emma Liu", message: "This is so fresh! Can't wait to try it", timestamp: new Date(Date.now() - 90 * 60 * 1000) },
                { sender: "John Smith", message: "I can help with pickup if needed", timestamp: new Date(Date.now() - 60 * 60 * 1000) }
            ]
        };
        
        let currentChatRequestId = null;
        let currentLanguage = 'zh';
        let selectedProducts = []; // Array to store products being added to the request
        let currentSelectedProduct = null; // Currently selected product for adding
        
        // Language translation system
        const translations = {
            en: {
                'Browse Requests': 'Browse Requests',
                'Create Request': 'Create Request', 
                'My Groups': 'My Groups',
                'View Details': 'View Details',
                'Cancel Request': 'Cancel Request',
                'Opt Out': 'Opt Out',
                'Chat💬': 'Chat💬',
                'Host': 'Host',
                'Participant': 'Participant',
                'Login': 'Login',
                'Logout': 'Logout',
                'Profile Settings': 'Profile Settings',
                'Create Account': 'Create Account',
                'No requests found': 'No requests found',
                'Try adjusting your search or filter criteria': 'Try adjusting your search or filter criteria',
                'No group buys yet': 'No group buys yet',
                'You haven\'t created or joined any group buys': 'You haven\'t created or joined any group buys',
                'Please log in': 'Please log in',
                'You need to be logged in to view your group buys': 'You need to be logged in to view your group buys',
                'All Status': 'All Status',
                'Open': 'Open',
                'Almost Full': 'Almost Full',
                'Completed': 'Completed',
                'Search by product name, ID, or host...': 'Search by product name, ID, or host...',
                'Create Group Buy Request': 'Create Group Buy Request',
                'Products': 'Products',
                'Add multiple products to your group buy': 'Add multiple products to your group buy',
                'Add a product to your group buy': 'Add a product to your group buy',
                'Search by product name or ID...': 'Search by product name or ID...',
                'Additional Notes (Optional)': 'Additional Notes (Optional)',
                'Any special requirements, pickup location preferences, etc...': 'Any special requirements, pickup location preferences, etc...',
                'Add at least one product to create your request': 'Add at least one product to create your request',
                'participants': 'participants',
                'Your Quantity': 'Your Quantity',
                'Case Total': 'Case Total',
                'Remaining': 'Remaining',
                'Minimum order': 'Minimum order',
                'You take': 'You take',
                'Remaining for others': 'Remaining for others',
                'Progress': 'Progress',
                'Participants': 'Participants',
                'Your quantity (lbs)': 'Your quantity (lbs)',
                'Min': 'Min',
                'Available': 'Available',
                'Join': 'Join',
                'Update': 'Update',
                'Total Case': 'Total Case',
                'Committed': 'Committed',
                'Active Group Buy Requests': 'Active Group Buy Requests',
                'My Group Buys': 'My Group Buys'
            },
            zh: {
                'Browse Requests': '瀏覽請求',
                'Create Request': '創建請求',
                'My Groups': '我的團購',
                'View Details': '查看詳情',
                'Cancel Request': '取消請求',
                'Opt Out': '退出',
                'Chat💬': '聊天💬',
                'Host': '主辦人',
                'Participant': '參與者',
                'Login': '登入',
                'Logout': '登出',
                'Profile Settings': '個人設定',
                'Create Account': '創建帳戶',
                'Email or Phone': '電子郵件或電話',
                'Password': '密碼',
                'Don\'t have an account?': '還沒有帳戶？',
                'Sign up': '註冊',
                'Full Name': '全名',
                'Email': '電子郵件',
                'Phone Number': '電話號碼',
                'Must be at least 8 characters': '必須至少8個字符',
                'Already have an account?': '已經有帳戶了？',
                'No requests found': '找不到請求',
                'Try adjusting your search or filter criteria': '請嘗試調整搜索或篩選條件',
                'No group buys yet': '尚無團購',
                'You haven\'t created or joined any group buys': '您尚未創建或加入任何團購',
                'Please log in': '請登入',
                'You need to be logged in to view your group buys': '您需要登入才能查看您的團購',
                'All Status': '所有狀態',
                'Open': '開放中',
                'Almost Full': '即將滿額',
                'Completed': '已完成',
                'Search by product name, ID, or host...': '按產品名稱、ID或主辦人搜索...',
                'Create Group Buy Request': '創建團購請求',
                'Products': '產品',
                'Add multiple products to your group buy': '為您的團購添加多個產品',
                'Add a product to your group buy': '為您的團購添加產品',
                'Search by product name or ID...': '按產品名稱或ID搜索...',
                'Additional Notes (Optional)': '附加說明（可選）',
                'Any special requirements, pickup location preferences, etc...': '任何特殊要求、取貨地點偏好等...',
                'Add at least one product to create your request': '至少添加一個產品才能創建請求',
                'Total Case Weight': '總箱重量',
                'Packaging': '包裝',
                'Product ID': '產品編號',
                'Your Required Quantity (lbs)': '您需要的數量（磅）',
                'Minimum Order (lbs)': '最小訂購量（磅）',
                'Add Product': '添加產品',
                'Cancel': '取消',
                'participants': '參與者',
                'Your Quantity': '您的數量',
                'Case Total': '箱總重',
                'Remaining': '剩餘',
                'Minimum order': '最小訂購量',
                'You take': '您需要',
                'Remaining for others': '其他人剩餘',
                'Progress': '進度',
                'Participants': '參與者',
                'Your quantity (lbs)': '您的數量（磅）',
                'Min': '最少',
                'Available': '可用',
                'Join': '加入',
                'Update': '更新',
                'Total Case': '總箱重',
                'Committed': '已承諾',
                'Active Group Buy Requests': '活躍團購請求',
                'My Group Buys': '我的團購',
                'Profile Settings': '個人設定',
                'Full Name': '全名',
                'Email': '電子郵件',
                'Phone Number': '電話號碼',
                'Save Changes': '保存更改',
                'Change Password': '更改密碼',
                'Notification Preferences': '通知偏好',
                'Receive notifications for:': '接收以下通知：',
                'New participants join my group buys': '新參與者加入我的團購',
                'Orders are fulfilled/completed': '訂單已完成/履行',
                'Participants adjust their quantities': '參與者調整數量',
                'Group buys are cancelled or participants leave': '團購被取消或參與者離開',
                'Notification methods:': '通知方式：',
                'Browser notifications (in-app)': '瀏覽器通知（應用內）',
                'Email notifications': '電子郵件通知',
                'SMS text messages': '短信通知',
                'Email and SMS notifications require verification and may have additional charges.': '電子郵件和短信通知需要驗證，可能產生額外費用。'
            }
        };
        
        function getText(key) {
            return translations[currentLanguage][key] || key;
        }
        
        function updateInterfaceLanguage() {
            // Update navigation buttons by onclick attribute
            const browseBtn = document.querySelector('button[onclick="showSection(\'browse\')"]');
            const createBtn = document.querySelector('button[onclick="showSection(\'create\')"]');
            const myGroupsBtn = document.querySelector('button[onclick="showSection(\'my-groups\')"]');
            
            if (browseBtn) browseBtn.textContent = getText('Browse Requests');
            if (createBtn) createBtn.textContent = getText('Create Request');
            if (myGroupsBtn) myGroupsBtn.textContent = getText('My Groups');
            
            // Update filter dropdown
            const filterSelect = document.getElementById('filter-status');
            if (filterSelect) {
                const options = filterSelect.querySelectorAll('option');
                options.forEach(option => {
                    const value = option.value;
                    if (value === 'all') option.textContent = getText('All Status');
                    if (value === 'open') option.textContent = getText('Open');
                    if (value === 'almost-full') option.textContent = getText('Almost Full');
                    if (value === 'completed') option.textContent = getText('Completed');
                });
            }
            
            // Update search placeholder
            const searchInput = document.getElementById('search-requests');
            if (searchInput) {
                searchInput.placeholder = getText('Search by product name, ID, or host...');
            }
            
            // Update page titles
            const browseTitle = document.getElementById('browse-title');
            if (browseTitle) browseTitle.textContent = getText('Active Group Buy Requests');
            
            const myGroupsTitle = document.getElementById('my-groups-title');
            if (myGroupsTitle) myGroupsTitle.textContent = getText('My Group Buys');
            
            const profileTitle = document.getElementById('profile-settings-title');
            if (profileTitle) profileTitle.textContent = getText('Profile Settings');
            
            // Update create form elements
            const createTitle = document.getElementById('create-title');
            if (createTitle) createTitle.textContent = getText('Create Group Buy Request');
            
            const productsTitle = document.getElementById('products-title');
            if (productsTitle) productsTitle.textContent = getText('Products');
            
            const productsSubtitle = document.getElementById('products-subtitle');
            if (productsSubtitle) productsSubtitle.textContent = getText('Add multiple products to your group buy');
            
            const addProductText = document.getElementById('add-product-text');
            if (addProductText) addProductText.textContent = getText('Add a product to your group buy');
            
            const productSearchInput = document.getElementById('product-search');
            if (productSearchInput) productSearchInput.placeholder = getText('Search by product name or ID...');
            
            const notesLabel = document.getElementById('notes-label');
            if (notesLabel) notesLabel.textContent = getText('Additional Notes (Optional)');
            
            const notesTextarea = document.getElementById('request-notes');
            if (notesTextarea) notesTextarea.placeholder = getText('Any special requirements, pickup location preferences, etc...');
            
            const createBtn2 = document.getElementById('create-request-btn');
            if (createBtn2) createBtn2.textContent = getText('Create Group Buy Request');
            
            const createHelpText = document.getElementById('create-help-text');
            if (createHelpText) createHelpText.textContent = getText('Add at least one product to create your request');
            
            // Update product form elements
            const quantityLabel = document.getElementById('quantity-label');
            if (quantityLabel) quantityLabel.textContent = getText('Your Required Quantity (lbs)');
            
            const minOrderLabel = document.getElementById('min-order-label');
            if (minOrderLabel) minOrderLabel.textContent = getText('Minimum Order (lbs)');
            
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) {
                const icon = addProductBtn.querySelector('i');
                addProductBtn.innerHTML = '';
                if (icon) addProductBtn.appendChild(icon);
                addProductBtn.appendChild(document.createTextNode(getText('Add Product')));
            }
            
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            if (cancelProductBtn) cancelProductBtn.textContent = getText('Cancel');
            
            // Update profile form elements
            const fullNameLabel = document.getElementById('full-name-label');
            if (fullNameLabel) fullNameLabel.textContent = getText('Full Name');
            
            const emailLabel = document.getElementById('email-label');
            if (emailLabel) emailLabel.textContent = getText('Email');
            
            const phoneLabel = document.getElementById('phone-label');
            if (phoneLabel) phoneLabel.textContent = getText('Phone Number');
            
            const saveChangesBtn = document.getElementById('save-changes-btn');
            if (saveChangesBtn) saveChangesBtn.textContent = getText('Save Changes');
            
            const changePasswordBtn = document.getElementById('change-password-btn');
            if (changePasswordBtn) changePasswordBtn.textContent = getText('Change Password');
            
            // Update notification preferences
            const notificationPreferencesTitle = document.getElementById('notification-preferences-title');
            if (notificationPreferencesTitle) notificationPreferencesTitle.textContent = getText('Notification Preferences');
            
            const notificationTypesTitle = document.getElementById('notification-types-title');
            if (notificationTypesTitle) notificationTypesTitle.textContent = getText('Receive notifications for:');
            
            const notifyParticipantsLabel = document.getElementById('notify-participants-label');
            if (notifyParticipantsLabel) notifyParticipantsLabel.textContent = getText('New participants join my group buys');
            
            const notifyFulfilledLabel = document.getElementById('notify-fulfilled-label');
            if (notifyFulfilledLabel) notifyFulfilledLabel.textContent = getText('Orders are fulfilled/completed');
            
            const notifyQuantityLabel = document.getElementById('notify-quantity-label');
            if (notifyQuantityLabel) notifyQuantityLabel.textContent = getText('Participants adjust their quantities');
            
            const notifyCancelLabel = document.getElementById('notify-cancel-label');
            if (notifyCancelLabel) notifyCancelLabel.textContent = getText('Group buys are cancelled or participants leave');
            
            const notificationMethodsTitle = document.getElementById('notification-methods-title');
            if (notificationMethodsTitle) notificationMethodsTitle.textContent = getText('Notification methods:');
            
            const notifyBrowserLabel = document.getElementById('notify-browser-label');
            if (notifyBrowserLabel) notifyBrowserLabel.textContent = getText('Browser notifications (in-app)');
            
            const notifyEmailLabel = document.getElementById('notify-email-label');
            if (notifyEmailLabel) notifyEmailLabel.textContent = getText('Email notifications');
            
            const notifySmsLabel = document.getElementById('notify-sms-label');
            if (notifySmsLabel) notifySmsLabel.textContent = getText('SMS text messages');
            
            const notificationNote = document.getElementById('notification-note');
            if (notificationNote) notificationNote.textContent = getText('Email and SMS notifications require verification and may have additional charges.');
            
            // Update menu buttons
            const profileMenuBtn = document.getElementById('profile-menu-btn');
            if (profileMenuBtn) profileMenuBtn.textContent = getText('Profile Settings');
            
            const logoutMenuBtn = document.getElementById('logout-menu-btn');
            if (logoutMenuBtn) logoutMenuBtn.textContent = getText('Logout');
            
            const loginMenuBtn = document.getElementById('login-menu-btn');
            if (loginMenuBtn) loginMenuBtn.textContent = getText('Login');
            
            const signupMenuBtn = document.getElementById('signup-menu-btn');
            if (signupMenuBtn) signupMenuBtn.textContent = getText('Create Account');
            
            // Update login modal elements
            const loginModalTitle = document.getElementById('login-modal-title');
            if (loginModalTitle) loginModalTitle.textContent = getText('Login');
            
            const loginIdentifierLabel = document.getElementById('login-identifier-label');
            if (loginIdentifierLabel) loginIdentifierLabel.textContent = getText('Email or Phone');
            
            const loginPasswordLabel = document.getElementById('login-password-label');
            if (loginPasswordLabel) loginPasswordLabel.textContent = getText('Password');
            
            const loginSubmitBtn = document.getElementById('login-submit-btn');
            if (loginSubmitBtn) loginSubmitBtn.textContent = getText('Login');
            
            const loginSignupText = document.getElementById('login-signup-text');
            if (loginSignupText) loginSignupText.textContent = getText('Don\'t have an account?') + ' ';
            
            const loginSignupBtn = document.getElementById('login-signup-btn');
            if (loginSignupBtn) loginSignupBtn.textContent = getText('Sign up');
            
            // Update signup modal elements
            const signupModalTitle = document.getElementById('signup-modal-title');
            if (signupModalTitle) signupModalTitle.textContent = getText('Create Account');
            
            const signupNameLabel = document.getElementById('signup-name-label');
            if (signupNameLabel) signupNameLabel.textContent = getText('Full Name');
            
            const signupEmailLabel = document.getElementById('signup-email-label');
            if (signupEmailLabel) signupEmailLabel.textContent = getText('Email');
            
            const signupPhoneLabel = document.getElementById('signup-phone-label');
            if (signupPhoneLabel) signupPhoneLabel.textContent = getText('Phone Number');
            
            const signupPasswordLabel = document.getElementById('signup-password-label');
            if (signupPasswordLabel) signupPasswordLabel.textContent = getText('Password');
            
            const signupPasswordHelp = document.getElementById('signup-password-help');
            if (signupPasswordHelp) signupPasswordHelp.textContent = getText('Must be at least 8 characters');
            
            const signupSubmitBtn = document.getElementById('signup-submit-btn');
            if (signupSubmitBtn) signupSubmitBtn.textContent = getText('Create Account');
            
            const signupLoginText = document.getElementById('signup-login-text');
            if (signupLoginText) signupLoginText.textContent = getText('Already have an account?') + ' ';
            
            const signupLoginBtn = document.getElementById('signup-login-btn');
            if (signupLoginBtn) signupLoginBtn.textContent = getText('Login');
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupProductSearch();
            setupQuantityFeedback();
            setupCreateRequestForm();
            setupSearchAndFilter();
            setupChatInput();
            setupLoginForm();
            setupSignupForm();
            setupChangePasswordForm();
            setupProfileForm();
            
            updateUserInterface();
            updateInterfaceLanguage();
            renderRequests();
            lucide.createIcons();
        });
        
        // Navigation functions
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            if (sectionName === 'browse') {
                renderRequests();
            } else if (sectionName === 'my-groups') {
                renderMyGroups();
            }
            
            document.getElementById('user-menu').classList.add('hidden');
            document.getElementById('notifications-dropdown').classList.add('hidden');
        }
        
        // Authentication Functions
        function showLoginModal() {
            closeAllModals();
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
        }
        
        function closeLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }
        
        function showSignupModal() {
            closeAllModals();
            document.getElementById('signup-modal').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
        }
        
        function closeSignupModal() {
            document.getElementById('signup-modal').classList.add('hidden');
        }
        
        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('hidden');
        }
        
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('hidden');
        }
        
        function closeAllModals() {
            const modals = [
                'login-modal',
                'signup-modal', 
                'change-password-modal',
                'request-modal',
                'chat-modal'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        // User menu functions
        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('hidden');
        }
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                renderNotifications();
            }
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
            const toggle = document.getElementById('language-toggle');
            toggle.textContent = currentLanguage === 'en' ? '中文' : 'EN';
            
            // Update all interface elements
            updateInterfaceLanguage();
            
            // Re-render all sections to show translated content
            renderRequests();
            renderMyGroups();
        }
        
        // Update user interface based on login status
        function updateUserInterface() {
            const userAvatar = document.getElementById('user-avatar');
            const userNameDisplay = document.getElementById('user-name-display');
            const loggedInMenu = document.getElementById('logged-in-menu');
            const guestMenu = document.getElementById('guest-menu');
            
            if (isLoggedIn && currentUser) {
                const user = userAccounts.find(u => u.name === currentUser);
                
                userAvatar.textContent = user.avatar;
                userNameDisplay.textContent = user.name;
                userNameDisplay.classList.remove('hidden');
                
                loggedInMenu.classList.remove('hidden');
                guestMenu.classList.add('hidden');
                
                document.getElementById('menu-user-name').textContent = user.name;
                document.getElementById('menu-user-email').textContent = user.email;
                
                document.getElementById('profile-name').textContent = user.name;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-avatar').textContent = user.avatar;
                document.getElementById('profile-full-name').value = user.name;
                document.getElementById('profile-email-input').value = user.email;
                document.getElementById('profile-phone').value = user.phone;
                
                // Load notification preferences
                if (user.notificationPreferences) {
                    document.getElementById('notify-new-participants').checked = user.notificationPreferences.newParticipants;
                    document.getElementById('notify-order-fulfilled').checked = user.notificationPreferences.orderFulfilled;
                    document.getElementById('notify-quantity-changes').checked = user.notificationPreferences.quantityChanges;
                    document.getElementById('notify-cancellations').checked = user.notificationPreferences.cancellations;
                    document.getElementById('notify-browser').checked = user.notificationPreferences.browserNotifications;
                    document.getElementById('notify-email').checked = user.notificationPreferences.emailNotifications;
                    document.getElementById('notify-sms').checked = user.notificationPreferences.smsNotifications;
                }
                
            } else {
                userAvatar.textContent = 'G';
                userNameDisplay.textContent = 'Guest';
                userNameDisplay.classList.add('hidden');
                
                loggedInMenu.classList.add('hidden');
                guestMenu.classList.remove('hidden');
                
                currentUser = 'Guest User';
            }
        }
        
        // Logout function
        function logout() {
            currentUser = null;
            isLoggedIn = false;
            userNotifications = [];
            updateUserInterface();
            showSection('browse');
            showNotification('Logged out successfully! 👋');
        }
        
        // Form handlers
        function setupLoginForm() {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const identifier = document.getElementById('login-identifier').value.trim();
                const password = document.getElementById('login-password').value;
                
                const user = userAccounts.find(u => 
                    u.email.toLowerCase() === identifier.toLowerCase() || 
                    u.phone === identifier
                );
                
                if (user && user.password === password) {
                    currentUser = user.name;
                    isLoggedIn = true;
                    
                    closeLoginModal();
                    updateUserInterface();
                    renderRequests();
                    
                    showNotification(`Welcome back, ${user.name}! 👋`);
                } else {
                    alert('Invalid email/phone or password. Please try again.');
                }
            });
        }
        
        function setupSignupForm() {
            const signupForm = document.getElementById('signup-form');
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const phone = document.getElementById('signup-phone').value.trim();
                const password = document.getElementById('signup-password').value;
                
                if (password.length < 8) {
                    alert('Password must be at least 8 characters long.');
                    return;
                }
                
                const newUser = {
                    id: userAccounts.length + 1,
                    name: name,
                    email: email,
                    phone: phone,
                    password: password,
                    avatar: name.charAt(0).toUpperCase(),
                    notificationPreferences: {
                        newParticipants: true,
                        orderFulfilled: true,
                        quantityChanges: true,
                        cancellations: true,
                        browserNotifications: true,
                        emailNotifications: false,
                        smsNotifications: false
                    }
                };
                
                userAccounts.push(newUser);
                currentUser = newUser.name;
                isLoggedIn = true;
                
                closeSignupModal();
                updateUserInterface();
                renderRequests();
                
                showNotification(`Account created successfully! Welcome to SaveGo, ${name}! 🎉`);
            });
        }
        
        function setupChangePasswordForm() {
            const form = document.getElementById('change-password-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                const user = userAccounts.find(u => u.name === currentUser);
                
                if (!user || user.password !== currentPassword) {
                    alert('Current password is incorrect.');
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert('New password must be at least 8 characters long.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match.');
                    return;
                }
                
                user.password = newPassword;
                closeChangePasswordModal();
                showNotification('Password changed successfully! 🔒');
            });
        }
        
        function setupProfileForm() {
            const form = document.getElementById('profile-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const user = userAccounts.find(u => u.name === currentUser);
                if (!user) return;
                
                const newName = document.getElementById('profile-full-name').value.trim();
                const newEmail = document.getElementById('profile-email-input').value.trim();
                const newPhone = document.getElementById('profile-phone').value.trim();
                
                // Update notification preferences
                user.notificationPreferences = {
                    newParticipants: document.getElementById('notify-new-participants').checked,
                    orderFulfilled: document.getElementById('notify-order-fulfilled').checked,
                    quantityChanges: document.getElementById('notify-quantity-changes').checked,
                    cancellations: document.getElementById('notify-cancellations').checked,
                    browserNotifications: document.getElementById('notify-browser').checked,
                    emailNotifications: document.getElementById('notify-email').checked,
                    smsNotifications: document.getElementById('notify-sms').checked
                };
                
                const oldName = user.name;
                user.name = newName;
                user.email = newEmail;
                user.phone = newPhone;
                
                if (oldName !== newName) {
                    currentUser = newName;
                    
                    groupBuyRequests.forEach(request => {
                        if (request.hostName === oldName) {
                            request.hostName = newName;
                        }
                        request.items.forEach(item => {
                            item.participants.forEach(participant => {
                                if (participant.name === oldName) {
                                    participant.name = newName;
                                }
                            });
                        });
                    });
                }
                
                updateUserInterface();
                showNotification('Profile updated successfully! ✅');
            });
        }
        
        // Product search functionality
        function setupProductSearch() {
            const searchInput = document.getElementById('product-search');
            const searchResults = document.getElementById('search-results');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                const filteredProducts = productDatabase.filter(product => {
                    return product.englishName.toLowerCase().includes(query) ||
                           product.chineseName.includes(query) ||
                           product.id.toLowerCase().includes(query) ||
                           product.category.toLowerCase().includes(query);
                });
                
                if (filteredProducts.length > 0) {
                    const resultsHTML = filteredProducts.map(product => `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0" onclick="selectProduct('${product.id}')">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">${product.image}</div>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</div>
                                    <div class="text-sm text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</div>
                                    <div class="text-xs text-gray-500">ID: ${product.id} • ${product.caseWeight} lbs case • ${product.category}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    searchResults.innerHTML = resultsHTML;
                    searchResults.classList.remove('hidden');
                } else {
                    searchResults.innerHTML = '<div class="p-3 text-gray-500 text-center">No products found</div>';
                    searchResults.classList.remove('hidden');
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }
        
        function selectProduct(productId) {
            const product = productDatabase.find(p => p.id === productId);
            if (!product) return;
            
            // Check if product is already added
            if (selectedProducts.find(p => p.productId === productId)) {
                alert('This product is already added to your request');
                return;
            }
            
            const searchResults = document.getElementById('search-results');
            const searchInput = document.getElementById('product-search');
            const addProductForm = document.getElementById('add-product-form');
            const productPreview = document.getElementById('selected-product-preview');
            
            currentSelectedProduct = product;
            searchInput.value = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            searchResults.classList.add('hidden');
            
            productPreview.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="text-4xl">${product.image}</div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h3>
                        <p class="text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded-lg border">
                                <p class="text-sm font-medium text-gray-700 mb-1">${getText('Total Case Weight')}</p>
                                <p class="text-2xl font-bold text-indigo-600">${product.caseWeight} lbs</p>
                            </div>
                            <div class="bg-white p-3 rounded-lg border">
                                <p class="text-sm font-medium text-gray-700 mb-1">${getText('Packaging')}</p>
                                <p class="text-sm text-gray-600">${product.packaging}</p>
                            </div>
                        </div>
                        <div class="mt-3 text-sm text-gray-600">
                            <p><span class="font-medium">${getText('Product ID')}:</span> ${product.id}</p>
                        </div>
                    </div>
                </div>
            `;
            
            addProductForm.classList.remove('hidden');
            
            // Clear previous inputs
            document.getElementById('host-quantity').value = '';
            document.getElementById('min-order-quantity').value = '5';
            document.getElementById('quantity-feedback').classList.add('hidden');
            
            lucide.createIcons();
        }
        
        // Setup quantity input feedback
        function setupQuantityFeedback() {
            const quantityInput = document.getElementById('host-quantity');
            const minOrderInput = document.getElementById('min-order-quantity');
            const feedbackDiv = document.getElementById('quantity-feedback');
            const selectedProduct = document.getElementById('selected-product');
            
            function updateFeedback() {
                const quantity = parseInt(quantityInput.value);
                const minOrder = parseInt(minOrderInput.value) || 5;
                
                if (!currentSelectedProduct || !quantity) {
                    feedbackDiv.classList.add('hidden');
                    return;
                }
                
                const product = currentSelectedProduct;
                const remaining = product.caseWeight - quantity;
                
                if (quantity > product.caseWeight) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center space-x-2 text-red-600">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span>Cannot exceed total case weight of ${product.caseWeight} lbs</span>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                } else if (quantity > 0 && quantity < minOrder) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center space-x-2 text-yellow-600">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            <span>${currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`}</span>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                } else if (quantity >= minOrder) {
                    feedbackDiv.innerHTML = `
                        <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center space-x-2 text-green-700">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>${getText('You take')}: <strong>${quantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</strong></span>
                            </div>
                            <div class="text-green-600 font-medium">
                                ${getText('Remaining for others')}: <strong>${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</strong>
                            </div>
                        </div>
                    `;
                    feedbackDiv.classList.remove('hidden');
                    lucide.createIcons();
                } else {
                    feedbackDiv.classList.add('hidden');
                }
            }
            
            quantityInput.addEventListener('input', updateFeedback);
            minOrderInput.addEventListener('input', updateFeedback);
        }
        
        // Add product to request
        function addProductToRequest() {
            if (!currentSelectedProduct) return;
            
            const quantity = parseInt(document.getElementById('host-quantity').value);
            const minOrder = parseInt(document.getElementById('min-order-quantity').value) || 5;
            
            if (!quantity || quantity < minOrder) {
                alert(`Please enter a valid quantity (minimum ${minOrder} lbs)`);
                return;
            }
            
            if (quantity > currentSelectedProduct.caseWeight) {
                alert(`Quantity cannot exceed ${currentSelectedProduct.caseWeight} lbs`);
                return;
            }
            
            // Add to selected products
            selectedProducts.push({
                productId: currentSelectedProduct.id,
                hostQuantity: quantity,
                minOrderQuantity: minOrder
            });
            
            // Reset form
            cancelAddProduct();
            renderSelectedProducts();
            updateCreateButtonState();
            
            showNotification(`${currentLanguage === 'zh' ? currentSelectedProduct.chineseName : currentSelectedProduct.englishName} added to your request! ✅`);
        }
        
        // Cancel adding product
        function cancelAddProduct() {
            document.getElementById('add-product-form').classList.add('hidden');
            document.getElementById('product-search').value = '';
            document.getElementById('host-quantity').value = '';
            document.getElementById('min-order-quantity').value = '5';
            document.getElementById('quantity-feedback').classList.add('hidden');
            currentSelectedProduct = null;
        }
        
        // Remove product from request
        function removeProductFromRequest(productId) {
            selectedProducts = selectedProducts.filter(p => p.productId !== productId);
            renderSelectedProducts();
            updateCreateButtonState();
            
            const product = productDatabase.find(p => p.id === productId);
            showNotification(`${currentLanguage === 'zh' ? product.chineseName : product.englishName} removed from your request`);
        }
        
        // Render selected products
        function renderSelectedProducts() {
            const container = document.getElementById('selected-products-list');
            
            if (selectedProducts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = selectedProducts.map((selectedProduct, index) => {
                const product = productDatabase.find(p => p.id === selectedProduct.productId);
                const remaining = product.caseWeight - selectedProduct.hostQuantity;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 animate-fade-in">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <div class="text-3xl">${product.image}</div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                    <p class="text-sm text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                                    <p class="text-xs text-gray-500">ID: ${product.id}</p>
                                    
                                    <div class="mt-3 grid grid-cols-3 gap-4">
                                        <div class="bg-blue-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Your Quantity')}</p>
                                            <p class="text-lg font-bold text-blue-600">${selectedProduct.hostQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-green-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Case Total')}</p>
                                            <p class="text-lg font-bold text-green-600">${product.caseWeight} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-orange-50 p-2 rounded">
                                            <p class="text-xs font-medium text-gray-700">${getText('Remaining')}</p>
                                            <p class="text-lg font-bold text-orange-600">${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-2 text-xs text-gray-600">
                                        ${getText('Minimum order')}: ${selectedProduct.minOrderQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}
                                    </div>
                                </div>
                            </div>
                            <button onclick="removeProductFromRequest('${product.id}')" class="ml-4 text-red-500 hover:text-red-700 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Update create button state
        function updateCreateButtonState() {
            const createBtn = document.getElementById('create-request-btn');
            if (selectedProducts.length > 0) {
                createBtn.disabled = false;
                createBtn.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            } else {
                createBtn.disabled = true;
                createBtn.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            }
        }
        
        // Create request form handling
        function setupCreateRequestForm() {
            const form = document.getElementById('create-request-form');
            form.addEventListener('submit', handleCreateRequest);
        }
        
        function handleCreateRequest(e) {
            e.preventDefault();
            
            if (!isLoggedIn || !currentUser) {
                alert('Please log in to create a group buy request.');
                showLoginModal();
                return;
            }
            
            if (selectedProducts.length === 0) {
                alert('Please add at least one product to your request');
                return;
            }
            
            const notes = document.getElementById('request-notes').value.trim();
            
            // Create items array from selected products
            const items = selectedProducts.map(selectedProduct => {
                const product = productDatabase.find(p => p.id === selectedProduct.productId);
                return {
                    productId: selectedProduct.productId,
                    hostQuantity: selectedProduct.hostQuantity,
                    totalQuantity: product.caseWeight,
                    currentQuantity: selectedProduct.hostQuantity,
                    participants: [
                        { name: currentUser, quantity: selectedProduct.hostQuantity, isHost: true }
                    ],
                    status: "open",
                    minOrderQuantity: selectedProduct.minOrderQuantity
                };
            });
            
            const newRequest = {
                id: groupBuyRequests.length + 1,
                hostName: currentUser,
                items: items,
                notes: notes,
                createdAt: new Date(),
                chatEnabled: true
            };
            
            groupBuyRequests.unshift(newRequest);
            
            // Initialize chat for each product in the new request
            newRequest.items.forEach((item, index) => {
                const product = productDatabase.find(p => p.id === item.productId);
                const productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
                const chatKey = `${newRequest.id}-${index}`;
                
                chatMessages[chatKey] = [{
                    sender: currentUser,
                    message: `Started a new group buy for ${productName}! Looking forward to everyone joining 🎉`,
                    timestamp: new Date()
                }];
            });
            
            // Clear the form
            document.getElementById('create-request-form').reset();
            selectedProducts = [];
            currentSelectedProduct = null;
            renderSelectedProducts();
            updateCreateButtonState();
            cancelAddProduct();
            
            // Show success and redirect
            showNotification(`Group buy request created successfully with ${selectedProducts.length > 0 ? selectedProducts.length : items.length} product${items.length > 1 ? 's' : ''}! 🎉`);
            showSection('browse');
        }
        
        // Search and filter functionality
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('search-requests');
            const filterSelect = document.getElementById('filter-status');
            
            searchInput.addEventListener('input', renderRequests);
            filterSelect.addEventListener('change', renderRequests);
        }
        
        // Chat access control
        function canAccessChat(request) {
            if (!isLoggedIn) return false;
            
            // Check if user is host or participant
            const isHost = request.hostName === currentUser;
            const isParticipant = request.items.some(item => 
                item.participants.some(p => p.name === currentUser && !p.isHost)
            );
            
            if (!isHost && !isParticipant) return false;
            
            // Check if at least one item is completed (fulfilled)
            const hasCompletedItem = request.items.some(item => item.status === 'completed');
            
            return hasCompletedItem;
        }
        
        // Chat functionality
        function setupChatInput() {
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !currentChatRequestId) return;
            
            if (!isLoggedIn) {
                alert('Please log in to send messages');
                return;
            }
            
            const newMessage = {
                sender: currentUser,
                message: message,
                timestamp: new Date()
            };
            
            if (!chatMessages[currentChatRequestId]) {
                chatMessages[currentChatRequestId] = [];
            }
            
            chatMessages[currentChatRequestId].push(newMessage);
            
            input.value = '';
            renderChatMessages();
            
            // Scroll to bottom
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            const messages = chatMessages[currentChatRequestId] || [];
            
            container.innerHTML = messages.map(message => {
                const isCurrentUser = message.sender === currentUser;
                return `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="chat-bubble ${isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-900'} px-4 py-2 rounded-lg">
                            <div class="font-medium text-sm mb-1">${message.sender}</div>
                            <div>${message.message}</div>
                            <div class="text-xs opacity-75 mt-1">${formatChatTime(message.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatChatTime(timestamp) {
            return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function openChatModal(requestId) {
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Check if user can access chat
            if (!canAccessChat(request)) {
                alert('Chat is only available when the order is fulfilled and you are a participant or host.');
                return;
            }
            
            currentChatRequestId = requestId;
            document.getElementById('chat-modal-title').textContent = `Group Chat - ${request.hostName}`;
            document.getElementById('chat-modal').classList.remove('hidden');
            
            renderChatMessages();
            
            // Scroll to bottom
            setTimeout(() => {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        function closeChatModal() {
            document.getElementById('chat-modal').classList.add('hidden');
            currentChatRequestId = null;
        }
        
        // Notification functions
        function showNotification(message) {
            // Create a temporary notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            
            if (userNotifications.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No notifications</div>';
                return;
            }
            
            container.innerHTML = userNotifications.map(notification => {
                let icon = '🔔';
                if (notification.type === 'join') icon = '👋';
                if (notification.type === 'complete') icon = '✅';
                if (notification.type === 'leave') icon = '👋';
                if (notification.type === 'cancelled') icon = '❌';
                
                return `
                    <div class="p-3 border-b hover:bg-gray-50 cursor-pointer ${notification.read ? '' : 'bg-blue-50'}" onclick="markNotificationRead(${notification.id})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900">${notification.title}</p>
                                <p class="text-sm text-gray-600">${notification.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(notification.timestamp)}</p>
                            </div>
                            ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function markNotificationRead(notificationId) {
            const notification = userNotifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                renderNotifications();
            }
        }
        
        function clearAllNotifications() {
            userNotifications = [];
            renderNotifications();
        }
        
        // Render functions
        function renderRequests() {
            const container = document.getElementById('requests-grid');
            const searchQuery = document.getElementById('search-requests').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            
            let filteredRequests = groupBuyRequests.filter(request => {
                // Search filter
                const matchesSearch = !searchQuery || 
                    request.hostName.toLowerCase().includes(searchQuery) ||
                    request.items.some(item => {
                        const product = productDatabase.find(p => p.id === item.productId);
                        return product && (
                            product.englishName.toLowerCase().includes(searchQuery) ||
                            product.chineseName.toLowerCase().includes(searchQuery) ||
                            product.id.toLowerCase().includes(searchQuery)
                        );
                    });
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || 
                    request.items.some(item => {
                        if (statusFilter === 'open') return item.status === 'open';
                        if (statusFilter === 'almost-full') return item.status === 'almost-full';
                        if (statusFilter === 'completed') return item.status === 'completed';
                        return true;
                    });
                
                return matchesSearch && matchesStatus;
            });
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="search" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('No requests found')}</h3>
                        <p class="text-gray-600">${getText('Try adjusting your search or filter criteria')}</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = filteredRequests.map(request => {
                const isHost = isLoggedIn && request.hostName === currentUser;
                const isParticipating = isLoggedIn && request.items.some(item => 
                    item.participants.some(p => p.name === currentUser)
                ) && !isHost;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${request.hostName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${request.hostName}</h3>
                                    <p class="text-sm text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${request.chatEnabled ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '聊天活躍' : 'Chat Active'}</span>` : ''}
                                ${isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : ''}
                                ${isParticipating ? `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '您正在參與' : 'You\'re participating'}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            ${request.items.length > 1 ? `
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-sm text-gray-600">${request.items.length} products in this group buy</span>
                                    <button onclick="toggleProductsView(${request.id})" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center space-x-1">
                                        <span id="toggle-text-${request.id}">Show all products</span>
                                        <i data-lucide="chevron-down" id="toggle-icon-${request.id}" class="w-4 h-4 toggle-icon"></i>
                                    </button>
                                </div>
                            ` : ''}
                            
                            <div id="products-container-${request.id}" class="space-y-4 products-container ${request.items.length > 1 ? 'max-h-48 overflow-hidden' : ''}">
                                ${request.items.map(item => {
                                    const product = productDatabase.find(p => p.id === item.productId);
                                    const progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                                    const remaining = item.totalQuantity - item.currentQuantity;
                                    
                                    let statusColor = 'bg-blue-500';
                                    if (item.status === 'almost-full') statusColor = 'bg-yellow-500';
                                    if (item.status === 'completed') statusColor = 'bg-green-500';
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4">
                                            <div class="flex items-center space-x-3 mb-3">
                                                <div class="text-2xl">${product.image}</div>
                                                <div class="flex-1">
                                                    <h4 class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                                    <p class="text-sm text-gray-600">${product.id} • ${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'} ${currentLanguage === 'zh' ? '箱' : 'case'}</p>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                                    <span>${item.currentQuantity}/${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                    <span>${remaining} ${currentLanguage === 'zh' ? '磅剩餘' : 'lbs remaining'}</span>
                                                </div>
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="progress-bar h-2 rounded-full ${statusColor}" style="width: ${progressPercentage}%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-sm text-gray-600">
                                                <span class="font-medium">${item.participants.length} ${getText('participants')}:</span>
                                                ${item.participants.slice(0, 3).map(p => p.name).join(', ')}
                                                ${item.participants.length > 3 ? ` +${item.participants.length - 3} more` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        ${request.notes ? `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-700">${request.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-2">
                            <button onclick="openRequestModal(${request.id})" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                ${currentLanguage === 'zh' ? '查看詳情' : 'View Details'}
                            </button>
                            ${isHost ? `
                                <button onclick="hostOptOut(${request.id})" class="bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '取消請求' : 'Cancel Request'}
                                </button>
                            ` : isParticipating ? `
                                <button onclick="participantOptOut(${request.id})" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '退出' : 'Opt Out'}
                                </button>
                            ` : ''}
                            ${canAccessChat(request) ? `
                                <button onclick="openChatModal(${request.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '聊天💬' : 'Chat💬'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function renderMyGroups() {
            const container = document.getElementById('my-groups-grid');
            
            if (!isLoggedIn || !currentUser || currentUser === 'Guest User') {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="user" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('Please log in')}</h3>
                        <p class="text-gray-600 mb-4">${getText('You need to be logged in to view your group buys')}</p>
                        <button onclick="showLoginModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                            ${getText('Login')}
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            const userRequests = groupBuyRequests.filter(request => {
                // Show if user is the host
                if (request.hostName === currentUser) {
                    return true;
                }
                
                // Show if user is a participant in any item (but not as host)
                return request.items.some(item => 
                    item.participants.some(p => p.name === currentUser && !p.isHost)
                );
            });
            
            if (userRequests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-gray-400 mb-4">
                            <i data-lucide="shopping-bag" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">${getText('No group buys yet')}</h3>
                        <p class="text-gray-600 mb-4">${getText('You haven\'t created or joined any group buys')}</p>
                        <button onclick="showSection('browse')" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                            ${getText('Browse Requests')}
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = userRequests.map(request => {
                const isHost = request.hostName === currentUser;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover animate-fade-in">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${request.hostName.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${request.hostName}</h3>
                                    <p class="text-sm text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : `<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '參與者' : 'Participant'}</span>`}
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-4">
                            ${request.items.map(item => {
                                const product = productDatabase.find(p => p.id === item.productId);
                                const progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                                const remaining = item.totalQuantity - item.currentQuantity;
                                
                                return `
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-center space-x-3 mb-3">
                                            <div class="text-2xl">${product.image}</div>
                                            <div class="flex-1">
                                                <h4 class="font-medium text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h4>
                                                <p class="text-sm text-gray-600">${product.id} • ${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'} ${currentLanguage === 'zh' ? '箱' : 'case'}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="flex justify-between text-sm text-gray-600 mb-1">
                                                <span>${item.currentQuantity}/${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                <span>${remaining} ${currentLanguage === 'zh' ? '磅剩餘' : 'lbs remaining'}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="progress-bar h-2 rounded-full bg-blue-500" style="width: ${progressPercentage}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="openRequestModal(${request.id})" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                ${currentLanguage === 'zh' ? '查看詳情' : 'View Details'}
                            </button>
                            ${isHost ? `
                                <button onclick="hostOptOut(${request.id})" class="bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '取消請求' : 'Cancel Request'}
                                </button>
                            ` : isParticipating ? `
                                <button onclick="participantOptOut(${request.id})" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '退出' : 'Opt Out'}
                                </button>
                            ` : ''}
                            ${canAccessChat(request) ? `
                                <button onclick="openChatModal(${request.id})" class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    ${currentLanguage === 'zh' ? '聊天💬' : 'Chat💬'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function openRequestModal(requestId) {
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const isHost = isLoggedIn && request.hostName === currentUser;
            const isParticipating = isLoggedIn && request.items.some(item => 
                item.participants.some(p => p.name === currentUser)
            ) && !isHost;
            
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Group Buy by ${request.hostName}</h2>
                            <p class="text-gray-600">${formatTimeAgo(request.createdAt)}</p>
                        </div>
                        <button onclick="closeRequestModal()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        ${request.items.map((item, itemIndex) => {
                            const product = productDatabase.find(p => p.id === item.productId);
                            const progressPercentage = (item.currentQuantity / item.totalQuantity) * 100;
                            const remaining = item.totalQuantity - item.currentQuantity;
                            const canJoin = remaining >= 5 && !isHost && !isParticipating;
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-6">
                                    <div class="flex items-start space-x-4 mb-4">
                                        <div class="text-4xl">${product.image}</div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-semibold text-gray-900">${currentLanguage === 'zh' ? product.chineseName : product.englishName}</h3>
                                            <p class="text-gray-600">${currentLanguage === 'zh' ? product.englishName : product.chineseName}</p>
                                            <p class="text-sm text-gray-500">ID: ${product.id} • ${product.packaging}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '總箱重量' : 'Total Case'}</p>
                                            <p class="text-2xl font-bold text-blue-600">${item.totalQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '已承諾' : 'Committed'}</p>
                                            <p class="text-2xl font-bold text-green-600">${item.currentQuantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                        <div class="bg-orange-50 p-4 rounded-lg">
                                            <p class="text-sm font-medium text-gray-700">${currentLanguage === 'zh' ? '剩餘' : 'Remaining'}</p>
                                            <p class="text-2xl font-bold text-orange-600">${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                                            <span>${currentLanguage === 'zh' ? '進度' : 'Progress'}</span>
                                            <span>${Math.round(progressPercentage)}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                            <div class="progress-bar h-3 rounded-full bg-gradient-to-r from-blue-500 to-green-500" style="width: ${progressPercentage}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-gray-900 mb-2">${getText('Participants')} (${item.participants.length})</h4>
                                        <div class="space-y-2">
                                            ${item.participants.map((participant, pIndex) => {
                                                const canAdjust = (isHost && participant.isHost) || (!isHost && participant.name === currentUser && !participant.isHost);
                                                const maxAdjustable = item.totalQuantity - item.currentQuantity + participant.quantity;
                                                const minOrder = item.minOrderQuantity || 5;
                                                
                                                return `
                                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                        <div class="flex items-center space-x-2">
                                                            <div class="w-6 h-6 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                                                ${participant.name.charAt(0)}
                                                            </div>
                                                            <span class="text-sm font-medium">${participant.name}</span>
                                                            ${participant.isHost ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${currentLanguage === 'zh' ? '主辦人' : 'Host'}</span>` : ''}
                                                        </div>
                                                        <div class="flex items-center space-x-2">
                                                            ${canAdjust ? `
                                                                <div class="flex items-center space-x-1">
                                                                    <input type="number" 
                                                                           id="adjust-qty-${requestId}-${itemIndex}-${pIndex}" 
                                                                           value="${participant.quantity}" 
                                                                           min="${minOrder}" 
                                                                           max="${maxAdjustable}"
                                                                           class="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                                                    <button onclick="adjustQuantity(${requestId}, ${itemIndex}, ${pIndex})" 
                                                                            class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                                                                        ${getText('Update')}
                                                                    </button>
                                                                </div>
                                                            ` : `
                                                                <span class="text-sm text-gray-600">${participant.quantity} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</span>
                                                            `}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    ${canJoin ? `
                                        <div class="border-t pt-4">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-1">
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">${getText('Your quantity (lbs)')}</label>
                                                    <input type="number" id="join-quantity-${itemIndex}" min="${item.minOrderQuantity || 5}" max="${remaining}" placeholder="${getText('Min')} ${item.minOrderQuantity || 5} ${currentLanguage === 'zh' ? '磅' : 'lbs'}" 
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                                    <p class="text-xs text-gray-500 mt-1">${getText('Min')}: ${item.minOrderQuantity || 5} ${currentLanguage === 'zh' ? '磅' : 'lbs'} • ${getText('Available')}: ${remaining} ${currentLanguage === 'zh' ? '磅' : 'lbs'}</p>
                                                </div>
                                                <button onclick="joinRequest(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                    ${getText('Join')}
                                                </button>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${isParticipating && !isHost ? `
                                        <div class="border-t pt-4 flex space-x-3">
                                            <button onclick="optOutRequest(${request.id}, ${itemIndex})" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                                Opt Out
                                            </button>
                                            ${item.status === 'completed' ? `
                                                <button onclick="openProductChat(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                    Chat💬
                                                </button>
                                            ` : ''}
                                        </div>
                                    ` : isHost && item.status === 'completed' ? `
                                        <div class="border-t pt-4">
                                            <button onclick="openProductChat(${request.id}, ${itemIndex})" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                                Chat💬
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        ${request.notes ? `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium text-gray-900 mb-2">${currentLanguage === 'zh' ? '附加說明' : 'Additional Notes'}</h4>
                                <p class="text-gray-700">${request.notes}</p>
                            </div>
                        ` : ''}
                        

                    </div>
                </div>
            `;
            
            document.getElementById('request-modal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeRequestModal() {
            document.getElementById('request-modal').classList.add('hidden');
        }
        
        function joinRequest(requestId, itemIndex) {
            if (!isLoggedIn) {
                alert('Please log in to join a group buy');
                showLoginModal();
                return;
            }
            
            const quantityInput = document.getElementById(`join-quantity-${itemIndex}`);
            const quantity = parseInt(quantityInput.value);
            
            if (!quantity || quantity < 5) {
                alert('Please enter a valid quantity (minimum 5 lbs)');
                return;
            }
            
            const request = groupBuyRequests.find(r => r.id === requestId);
            const item = request.items[itemIndex];
            const remaining = item.totalQuantity - item.currentQuantity;
            const minOrder = item.minOrderQuantity || 5;
            
            if (quantity < minOrder) {
                alert(currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`);
                return;
            }
            
            if (quantity > remaining) {
                alert(`Only ${remaining} lbs remaining`);
                return;
            }
            
            // Add participant
            item.participants.push({
                name: currentUser,
                quantity: quantity,
                isHost: false
            });
            
            item.currentQuantity += quantity;
            
            // Update status and check if completed
            const newRemaining = item.totalQuantity - item.currentQuantity;
            if (newRemaining === 0) {
                item.status = 'completed';
                // Notify host about completion
                const product = productDatabase.find(p => p.id === item.productId);
                addNotification(request.hostName, 'Order Fulfilled', `Your ${currentLanguage === 'zh' ? product.chineseName : product.englishName} group buy is now complete!`, 'complete');
            } else if (newRemaining <= 5) {
                item.status = 'almost-full';
            }
            
            // Notify host about new participant
            addNotification(request.hostName, 'New Participant', `${currentUser} joined your group buy!`, 'join');
            
            closeRequestModal();
            renderRequests();
            renderMyGroups();
            
            const product = productDatabase.find(p => p.id === item.productId);
            showNotification(`Successfully joined ${currentLanguage === 'zh' ? product.chineseName : product.englishName} group buy! 🎉`);
        }
        
        function optOutRequest(requestId, itemIndex) {
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const item = request.items[itemIndex];
            const product = productDatabase.find(p => p.id === item.productId);
            const productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            
            if (!confirm(`Are you sure you want to opt out of ${productName}? This will make your quantity available for others to join.`)) {
                return;
            }
            
            // Find and remove participant from this specific product
            const participantIndex = item.participants.findIndex(p => p.name === currentUser && !p.isHost);
            if (participantIndex !== -1) {
                const participant = item.participants[participantIndex];
                const releasedQuantity = participant.quantity;
                
                item.currentQuantity -= participant.quantity;
                item.participants.splice(participantIndex, 1);
                
                // Update status - make quantities available to others
                const remaining = item.totalQuantity - item.currentQuantity;
                if (remaining === 0) {
                    item.status = 'completed';
                } else if (remaining <= 5) {
                    item.status = 'almost-full';
                } else {
                    item.status = 'open';
                }
                
                // Notify host about participant leaving this specific product
                addNotification(request.hostName, 'Participant Left Product', `${currentUser} has opted out of ${productName}. ${releasedQuantity} lbs is now available for others to join.`, 'leave');
                
                closeRequestModal();
                
                // Force refresh all views
                setTimeout(() => {
                    renderRequests();
                    renderMyGroups();
                }, 100);
                
                showNotification(`Successfully opted out of ${productName}. Your ${releasedQuantity} lbs is now available for others to join.`);
            }
        }
        
        // Open product-specific chat
        function openProductChat(requestId, itemIndex) {
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const item = request.items[itemIndex];
            const product = productDatabase.find(p => p.id === item.productId);
            
            // Check if user is participant in this specific product
            const isParticipant = item.participants.some(p => p.name === currentUser);
            if (!isParticipant) {
                alert('You can only access chat for products you are participating in.');
                return;
            }
            
            // Check if product is completed
            if (item.status !== 'completed') {
                alert('Product chat is only available when the order is fulfilled.');
                return;
            }
            
            const chatKey = `${requestId}-${itemIndex}`;
            currentChatRequestId = chatKey;
            
            const productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            document.getElementById('chat-modal-title').textContent = `${productName} Chat - ${request.hostName}`;
            document.getElementById('chat-modal').classList.remove('hidden');
            
            // Initialize chat if it doesn't exist
            if (!chatMessages[chatKey]) {
                chatMessages[chatKey] = [{
                    sender: 'System',
                    message: `Welcome to the ${productName} group chat! The order has been fulfilled and is ready for coordination.`,
                    timestamp: new Date()
                }];
            }
            
            renderChatMessages();
            
            // Scroll to bottom
            setTimeout(() => {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Host opt-out function - cancels entire request
        function hostOptOut(requestId) {
            if (!confirm('Are you sure you want to cancel this entire group buy request? This will void the order for all participants.')) {
                return;
            }
            
            const requestIndex = groupBuyRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) return;
            
            const request = groupBuyRequests[requestIndex];
            
            // Add notification for all participants (except host)
            request.items.forEach(item => {
                item.participants.forEach(participant => {
                    if (participant.name !== currentUser) {
                        addNotification(participant.name, 'Group Buy Cancelled', `The group buy hosted by ${currentUser} has been cancelled.`, 'cancelled');
                    }
                });
            });
            
            // Remove the request completely from the array
            groupBuyRequests.splice(requestIndex, 1);
            
            // Remove chat messages for all products in this request
            request.items.forEach((item, index) => {
                const chatKey = `${requestId}-${index}`;
                delete chatMessages[chatKey];
            });
            delete chatMessages[requestId];
            
            // Close modal if open
            closeRequestModal();
            
            // Immediately refresh all views to show the request is gone
            renderRequests();
            renderMyGroups();
            
            showNotification('Group buy request cancelled and removed successfully. All participants have been notified.');
        }
        
        // Participant opt-out function - removes from specific products
        function participantOptOut(requestId) {
            if (!confirm('Are you sure you want to opt out of this group buy?')) {
                return;
            }
            
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            let optedOutProducts = [];
            let totalReleasedQuantity = 0;
            
            // Remove participant from all items in the request
            request.items.forEach(item => {
                const participantIndex = item.participants.findIndex(p => p.name === currentUser && !p.isHost);
                if (participantIndex !== -1) {
                    const participant = item.participants[participantIndex];
                    totalReleasedQuantity += participant.quantity;
                    item.currentQuantity -= participant.quantity;
                    item.participants.splice(participantIndex, 1);
                    
                    // Update status - make quantities available to others
                    const remaining = item.totalQuantity - item.currentQuantity;
                    if (remaining === 0) {
                        item.status = 'completed';
                    } else if (remaining <= 5) {
                        item.status = 'almost-full';
                    } else {
                        item.status = 'open';
                    }
                    
                    const product = productDatabase.find(p => p.id === item.productId);
                    optedOutProducts.push(`${currentLanguage === 'zh' ? product.chineseName : product.englishName} (${participant.quantity} lbs)`);
                }
            });
            
            // Notify host about participant leaving
            if (optedOutProducts.length > 0) {
                addNotification(request.hostName, 'Participant Left', `${currentUser} has opted out of your group buy. ${optedOutProducts.join(', ')} quantities are now available for others to join.`, 'leave');
            }
            
            // Close modal if open
            closeRequestModal();
            
            // Immediately refresh all views to reflect the changes
            renderRequests();
            renderMyGroups();
            
            if (optedOutProducts.length > 0) {
                showNotification(`Successfully opted out of: ${optedOutProducts.join(', ')}. These quantities are now available for others to join.`);
            }
        }
        
        // Adjust participant quantity
        function adjustQuantity(requestId, itemIndex, participantIndex) {
            const request = groupBuyRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const item = request.items[itemIndex];
            const participant = item.participants[participantIndex];
            const product = productDatabase.find(p => p.id === item.productId);
            
            const newQuantityInput = document.getElementById(`adjust-qty-${requestId}-${itemIndex}-${participantIndex}`);
            const newQuantity = parseInt(newQuantityInput.value);
            const oldQuantity = participant.quantity;
            const minOrder = item.minOrderQuantity || 5;
            
            if (!newQuantity || newQuantity < minOrder) {
                alert(currentLanguage === 'zh' ? `最小訂購量為 ${minOrder} 磅` : `Minimum order quantity is ${minOrder} lbs`);
                newQuantityInput.value = oldQuantity;
                return;
            }
            
            // Calculate available space
            const currentWithoutThis = item.currentQuantity - oldQuantity;
            const maxPossible = item.totalQuantity - currentWithoutThis;
            
            if (newQuantity > maxPossible) {
                alert(`Maximum available quantity is ${maxPossible} lbs`);
                newQuantityInput.value = oldQuantity;
                return;
            }
            
            // Update quantities
            const quantityDiff = newQuantity - oldQuantity;
            participant.quantity = newQuantity;
            item.currentQuantity += quantityDiff;
            
            // Update status
            const remaining = item.totalQuantity - item.currentQuantity;
            if (remaining === 0) {
                item.status = 'completed';
            } else if (remaining <= 5) {
                item.status = 'almost-full';
            } else {
                item.status = 'open';
            }
            
            // Notify others about quantity change
            const productName = currentLanguage === 'zh' ? product.chineseName : product.englishName;
            const changeType = quantityDiff > 0 ? 'increased' : 'decreased';
            const absChange = Math.abs(quantityDiff);
            
            // Notify host if participant adjusted
            if (!participant.isHost) {
                addNotification(request.hostName, 'Quantity Adjusted', `${participant.name} ${changeType} their ${productName} order by ${absChange} lbs.`, 'quantity');
            }
            
            // Force refresh all views
            setTimeout(() => {
                renderRequests();
                renderMyGroups();
                openRequestModal(requestId); // Refresh the modal with updated data
            }, 100);
            
            showNotification(`Quantity updated! ${changeType === 'increased' ? 'Added' : 'Removed'} ${absChange} lbs ${changeType === 'increased' ? 'to' : 'from'} your ${productName} order.`);
        }
        
        // Add notification function
        function addNotification(userName, title, message, type) {
            const targetUser = userAccounts.find(u => u.name === userName);
            if (!targetUser || !targetUser.notificationPreferences) return;
            
            // Check if user wants this type of notification
            let shouldNotify = false;
            switch(type) {
                case 'join':
                    shouldNotify = targetUser.notificationPreferences.newParticipants;
                    break;
                case 'complete':
                    shouldNotify = targetUser.notificationPreferences.orderFulfilled;
                    break;
                case 'quantity':
                    shouldNotify = targetUser.notificationPreferences.quantityChanges;
                    break;
                case 'leave':
                case 'cancelled':
                    shouldNotify = targetUser.notificationPreferences.cancellations;
                    break;
                default:
                    shouldNotify = true;
            }
            
            if (!shouldNotify) return;
            
            // Only show browser notifications if user is currently logged in and has browser notifications enabled
            if (userName === currentUser && targetUser.notificationPreferences.browserNotifications) {
                userNotifications.unshift({
                    id: Date.now(),
                    title: title,
                    message: message,
                    type: type,
                    timestamp: new Date(),
                    read: false
                });
                
                updateNotificationBadge();
            }
            
            // Simulate email notification (would integrate with email service in real app)
            if (targetUser.notificationPreferences.emailNotifications) {
                console.log(`📧 Email sent to ${targetUser.email}: ${title} - ${message}`);
                if (userName === currentUser) {
                    showNotification(`📧 Email notification sent to ${targetUser.email}`);
                }
            }
            
            // Simulate SMS notification (would integrate with SMS service in real app)
            if (targetUser.notificationPreferences.smsNotifications) {
                console.log(`📱 SMS sent to ${targetUser.phone}: ${title} - ${message}`);
                if (userName === currentUser) {
                    showNotification(`📱 SMS notification sent to ${targetUser.phone}`);
                }
            }
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const unreadCount = userNotifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Utility functions
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (currentLanguage === 'zh') {
                if (minutes < 1) return '剛剛';
                if (minutes < 60) return `${minutes}分鐘前`;
                if (hours < 24) return `${hours}小時前`;
                return `${days}天前`;
            } else {
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }
        }
        
        // Toggle products view function
        function toggleProductsView(requestId) {
            const container = document.getElementById(`products-container-${requestId}`);
            const toggleText = document.getElementById(`toggle-text-${requestId}`);
            const toggleIcon = document.getElementById(`toggle-icon-${requestId}`);
            
            if (container.classList.contains('max-h-48')) {
                // Expand view
                container.classList.remove('max-h-48', 'overflow-hidden');
                container.classList.add('max-h-none');
                toggleText.textContent = 'Show less';
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                // Collapse view
                container.classList.remove('max-h-none');
                container.classList.add('max-h-48', 'overflow-hidden');
                toggleText.textContent = 'Show all products';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const userMenu = document.getElementById('user-menu');
            const userMenuButton = document.querySelector('button[onclick="toggleUserMenu()"]');
            const notificationsDropdown = document.getElementById('notifications-dropdown');
            const notificationsButton = document.querySelector('button[onclick="toggleNotifications()"]');
            
            if (userMenuButton && !userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
            
            if (notificationsButton && !notificationsButton.contains(e.target) && !notificationsDropdown.contains(e.target)) {
                notificationsDropdown.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98dc100c87a7465c',t:'MTc2MDMyOTQxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>


<!-- Supabase integration (minimal loader) -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const supabase = createClient("https://dhbexxcngocoesowiusb.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRoYmV4eGNuZ29jb2Vzb3dpdXNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTAzNTAsImV4cCI6MjA3NTc4NjM1MH0.RTGWoNU4hSl2_qVgLZR3_0NBJnXQ_9dD3bwkP2mcYK0");

  async function currentUser(){ const { data:{ user } } = await supabase.auth.getUser(); return user; }

  async function list() {
    const { data, error } = await supabase
      .from('groupbuys')
      .select('*, items:groupbuy_items(*, participants:participants(*))')
      .order('created_at', { ascending:false }).limit(50);
    if (error) { console.warn(error.message); return []; }
    return (data||[]).map(gb => ({
      id: gb.id, hostName: gb.host_name || '—',
      items: (gb.items||[]).map(it => ({
        productId: it.product_id, hostQuantity: it.host_quantity, totalQuantity: it.total_quantity,
        currentQuantity: it.current_quantity, status: it.status || 'open',
        participants: (it.participants||[]).map(p => ({ name: p.is_host ? 'Host' : 'Member', quantity: p.quantity, isHost: !!p.is_host }))
      })),
      notes: gb.notes || '', status: gb.status || 'open',
      createdAt: gb.created_at ? new Date(gb.created_at) : new Date(), chatEnabled: true
    }));
  }

  async function optOut(id){
    const u = await currentUser(); if(!u) return alert('請先登入');
    const { data: g } = await supabase.from('groupbuys').select('host_user').eq('id', id).single();
    if (!g || g.host_user !== u.id) return alert('只有主辦人可以作廢');
    await supabase.from('groupbuys').update({ status:'void' }).eq('id', id);
    await supabase.from('groupbuy_items').update({ status:'void' }).eq('groupbuy_id', id);
    alert('主辦人已退出，團購已作廢。');
  }

  window.SaveGoSupabase = { supabase, list, optOut, currentUser };

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const data = await list();
      if (Array.isArray(data) && data.length) {
        window.groupBuyRequests = data;
        if (typeof window.renderRequests === 'function') window.renderRequests();
      }
    } catch (e) {}
  });

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-optout-id]');
    if (!btn) return;
    const id = btn.getAttribute('data-optout-id');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = '作廢中…';
    try { await optOut(id); if (typeof window.renderRequests==='function') window.renderRequests(); }
    catch (err) { alert(err?.message || '失敗'); }
    finally { btn.disabled = false; btn.textContent = original; }
  });
</script>
</body>
</html>
